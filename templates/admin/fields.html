{% extends "admin/base.html" %}
{% block title %}Custom Fields{% endblock %}
{% block page_title %}Custom Fields{% endblock %}

{% block admin_content %}
<!-- Help Accordion: Custom Fields -->
<div class="help-accordion">
<div class="help-accordion-toggle" onclick="toggleHelpAccordion(this)">
<span style="font-size:18px">âš™ï¸</span>
<h4>â„¹ï¸ How Custom Fields Work</h4>
<svg class="ha-chevron" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/></svg>
</div>
<div class="help-accordion-body"><div class="help-accordion-inner">
<h5>What are Custom Fields?</h5>
<p>Custom Fields add <strong>extra pieces of information</strong> to any tier beyond the built-in fields (title, description, image). For example, a temple might need "Opening Time", "Entry Fee", or "Audio Guide URL".</p>
<h5>Creating a Custom Field</h5>
<p>Use the "Add New Field" form below. Each field needs:</p>
<ul>
<li><strong>Icon:</strong> Emoji shown next to the field on the frontend</li>
<li><strong>Label:</strong> Display name (e.g., "Opening Hours")</li>
<li><strong>Field Type:</strong> Text, Number, Image, Audio, Video, Rich Text, JSON, etc.</li>
<li><strong>Applies To:</strong> Which tiers see this field (All, T1 Only, T2+, T3+, etc.)</li>
<li><strong>Order:</strong> Sort position â€” lower numbers appear first</li>
</ul>
<h5>Available Field Types</h5>
<table>
<tr><th>Type</th><th>Use For</th><th>Example</th></tr>
<tr><td>ğŸ“ Text</td><td>Short text (one line)</td><td>Opening time, Phone</td></tr>
<tr><td>ğŸ“„ Textarea</td><td>Long text (multiple lines)</td><td>Detailed description</td></tr>
<tr><td>ğŸ“° Rich Text</td><td>Formatted text with bold, links</td><td>History & Significance</td></tr>
<tr><td>ğŸ”¢ Number</td><td>Numeric values</td><td>Entry fee, Elevation</td></tr>
<tr><td>ğŸ”— URL</td><td>Web links, audio/video URLs</td><td>YouTube link, website</td></tr>
<tr><td>ğŸ–¼ï¸ Image / ğŸ“¸ Multi</td><td>Image upload(s)</td><td>Map, floor plan, gallery</td></tr>
<tr><td>ğŸµ Audio / ğŸ¬ Video</td><td>Media file upload</td><td>Aarti recording, virtual tour</td></tr>
<tr><td>ğŸ“¦ JSON</td><td>Structured data</td><td>Schedule array, price tiers</td></tr>
</table>
<h5>"Applies To" Options</h5>
<ul>
<li><strong>ğŸŒ All Tiers:</strong> Appears in T1, T2, T3, and T4 forms</li>
<li><strong>ğŸ›ï¸ T1 Only / ğŸ“ T2 Only / ğŸ¯ T3 Only / âœ¦ T4 Only:</strong> Appears only in that tier</li>
<li><strong>ğŸ“ T2+:</strong> Appears in T2, T3, T4 (not T1)</li>
<li><strong>ğŸ¯ T3+:</strong> Appears in T3 and T4 (not T1 or T2)</li>
</ul>
<div class="ha-tip">ğŸ’¡ <strong>Tip:</strong> Create fields strategically! "Entry Fee" makes sense for T3. "Total Temples" suits T1. "GPS Note" fits T4.</div>
</div></div>
</div>

<!-- Help Accordion: JSON Info -->
<div class="help-accordion" style="border-left-color:#FF9800">
<div class="help-accordion-toggle" onclick="toggleHelpAccordion(this)">
<span style="font-size:18px">ğŸ“‹</span>
<h4>â„¹ï¸ About JSON Data Type</h4>
<svg class="ha-chevron" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"/></svg>
</div>
<div class="help-accordion-body"><div class="help-accordion-inner">
<h5>What is JSON?</h5>
<p>JSON (JavaScript Object Notation) is a simple way to store structured data as text â€” like a very organized list. The system uses JSON internally to store things like custom field values and visibility settings.</p>
<div class="ha-warn">âš ï¸ <strong>Important:</strong> You generally do NOT need to write JSON manually â€” the admin panel handles it for you. Only use the JSON field type if you need to store structured data that doesn't fit other field types.</div>
<h5>What JSON Looks Like</h5>
<div class="code-block">
{<br>
&nbsp;&nbsp;<span class="key">"opening_time"</span>: <span class="str">"5:00 AM"</span>,<br>
&nbsp;&nbsp;<span class="key">"closing_time"</span>: <span class="str">"9:00 PM"</span>,<br>
&nbsp;&nbsp;<span class="key">"entry_fee"</span>: <span class="val">0</span>,<br>
&nbsp;&nbsp;<span class="key">"has_darshan"</span>: <span class="val">true</span><br>
}
</div>
<h5>How JSON is Used in the System</h5>
<ul>
<li><strong>Field Visibility:</strong> On/off toggles for frontend display are saved as JSON</li>
<li><strong>Custom Field Values:</strong> Data like opening times, fees are stored as JSON internally</li>
<li><strong>Gallery Captions:</strong> Image captions are stored as JSON</li>
</ul>
<div class="ha-tip">ğŸ’¡ <strong>Key takeaway:</strong> You never need to write JSON yourself. The admin forms handle everything. JSON is just how the system stores your data behind the scenes.</div>
</div></div>
</div>

<p style="color:var(--text-light);margin-bottom:20px;font-size:14px">Define extra fields that appear on all tiers (T1 Holy Dhams, T2 Key Places, T3 Key Spots, T4 Key Points). Each field has an icon shown on the frontend.</p>

<!-- Add Field -->
<div class="admin-card" style="margin-bottom:20px;overflow:visible">
<div class="admin-card-header"><h3>Add New Field</h3></div>
<div class="admin-card-body" style="overflow:visible">
<form method="POST" action="{{ url_for('admin_field_new') }}" style="display:flex;gap:12px;align-items:end;flex-wrap:wrap;position:relative;z-index:10">
<div class="form-group" style="margin:0;width:70px">
<label>Icon</label>
<div class="icon-picker-wrap" style="position:relative">
<button type="button" class="form-control icon-pick-btn" onclick="toggleIconPicker(this)" style="font-size:22px;text-align:center;cursor:pointer;padding:6px;height:42px">ğŸ“‹</button>
<input type="hidden" name="icon" value="ğŸ“‹" class="icon-pick-val">
<div class="icon-picker-dropdown" style="display:none;position:absolute;top:100%;left:0;z-index:999;background:white;border:2px solid var(--border);border-radius:12px;padding:10px;width:320px;max-height:240px;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,.15);margin-top:4px">
<input type="text" class="form-control icon-search" placeholder="Search icons..." style="font-size:12px;margin-bottom:8px;padding:6px 10px" oninput="filterIcons(this)">
<div class="icon-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px">
{% for emoji, label in field_icons %}<button type="button" class="icon-opt" data-label="{{ label }}" onclick="pickIcon(this,'{{ emoji }}')" title="{{ label }}" style="font-size:18px;padding:6px;border:1px solid transparent;border-radius:8px;background:none;cursor:pointer;transition:all .15s;text-align:center" onmouseover="this.style.background='#f0f0f0';this.style.borderColor='#ddd'" onmouseout="this.style.background='none';this.style.borderColor='transparent'">{{ emoji }}</button>{% endfor %}
</div>
</div>
</div>
</div>
<div class="form-group" style="margin:0;flex:1;min-width:160px"><label>Label</label><input name="label" class="form-control" required placeholder="e.g. Opening Hours"></div>
<div class="form-group" style="margin:0;width:150px"><label>Field Type</label><select name="field_type" class="form-control" style="font-size:13px;padding:8px;height:auto;appearance:auto;-webkit-appearance:auto">
<option value="text">ğŸ“ Text</option><option value="textarea">ğŸ“„ Textarea</option><option value="richtext">ğŸ“° Rich Text</option>
<option value="number">ğŸ”¢ Number</option><option value="url">ğŸ”— URL / Link</option>
<option value="image">ğŸ–¼ï¸ Image</option><option value="audio">ğŸµ Audio</option><option value="video">ğŸ¬ Video</option><option value="images">ğŸ“¸ Multi-Images</option>
<option value="date">ğŸ“… Date</option><option value="select">ğŸ“‹ Select/Dropdown</option><option value="boolean">âœ… Yes/No</option><option value="color">ğŸ¨ Color</option><option value="json">ğŸ“¦ JSON Data</option>
</select></div>
<div class="form-group" style="margin:0;width:150px"><label>Placeholder</label><input name="placeholder" class="form-control" placeholder="Hint text"></div>
<div class="form-group" style="margin:0;width:70px"><label>Order</label><input name="sort_order" class="form-control" type="number" value="0"></div>
<div class="form-group" style="margin:0;width:140px"><label>Applies To</label><select name="applies_to" class="form-control" style="font-size:13px;padding:8px;height:auto;appearance:auto;-webkit-appearance:auto">
<option value="both">ğŸŒ All Tiers</option><option value="place">ğŸ›ï¸ T1 Only</option><option value="key_place">ğŸ“ T2 Only</option><option value="key_spot">ğŸ¯ T3 Only</option><option value="sub_spot">âœ¦ T4 Only</option><option value="t2_plus">ğŸ“ T2+ (T2-T4)</option><option value="t3_plus">ğŸ¯ T3+ (T3-T4)</option>
</select></div>
<button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add</button>
</form>
</div>
</div>

<!-- Fields List -->
<div class="admin-card">
{% if fields %}
<div style="overflow-x:auto">
<table class="admin-table">
<thead><tr><th style="width:50px">Icon</th><th>Order</th><th>Label</th><th>Name</th><th>Type</th><th>Scope</th><th>Status</th><th style="width:220px">Actions</th></tr></thead>
<tbody>
{% for f in fields %}
<tr style="{{ 'opacity:.5' if not f.is_active }}">
<td style="text-align:center;font-size:22px">{{ f.icon or 'ğŸ“‹' }}</td>
<td>{{ f.sort_order }}</td>
<td style="font-weight:600">{{ f.label }}</td>
<td style="font-size:11px;color:var(--text-light);font-family:monospace">{{ f.name }}</td>
<td><span class="badge" style="background:{{ {'text':'#D4E0F5','textarea':'#D4E5D4','richtext':'#F5ECD4','number':'#E5D4E8','url':'#D4E0F5','image':'#F8E5EE','audio':'#E8F5E8','video':'#F5E8E8','images':'#F8E5EE'}.get(f.field_type,'#EEE') }};color:var(--text-dark)">{{ f.field_type }}</span></td>
<td style="font-size:12px">{{ f.applies_to }}</td>
<td>
<form method="POST" action="{{ url_for('admin_field_toggle', field_id=f.id) }}" style="display:inline">
<button class="btn btn-sm {{ 'btn-primary' if f.is_active else 'btn-danger' }}" style="font-size:11px">{{ 'â— Active' if f.is_active else 'â—‹ Off' }}</button>
</form>
</td>
<td style="display:flex;gap:6px">
<button type="button" class="btn btn-secondary btn-sm" style="font-size:11px" onclick="openEditField({{ f.id }},'{{ f.label|e }}','{{ f.field_type }}','{{ (f.placeholder or '')|e }}',{{ f.sort_order }},'{{ f.applies_to }}','{{ f.icon or 'ğŸ“‹' }}')"><i class="fas fa-edit"></i> Edit</button>
<form method="POST" action="{{ url_for('admin_field_delete', field_id=f.id) }}" style="display:inline" onsubmit="return confirm('Delete field and all values?')">
<button class="btn btn-danger btn-sm btn-icon"><i class="fas fa-trash"></i></button>
</form>
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty"><span class="icon">âš™ï¸</span><h3>No custom fields yet</h3><p>Create fields above to extend data across all tiers.</p></div>
{% endif %}
</div>

<!-- Edit Field Modal -->
<div id="editFieldModal" style="display:none;position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.4);align-items:center;justify-content:center">
<div style="background:white;border-radius:16px;padding:28px;width:480px;max-width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.2)">
<h3 style="margin-bottom:16px;font-family:'Josefin Sans',sans-serif">Edit Field</h3>
<form id="editFieldForm" method="POST">
<div style="display:grid;gap:12px">
<div style="display:flex;gap:12px">
<div class="form-group" style="margin:0;width:70px">
<label>Icon</label>
<div class="icon-picker-wrap" style="position:relative">
<button type="button" class="form-control icon-pick-btn" id="editIconBtn" onclick="toggleIconPicker(this)" style="font-size:22px;text-align:center;cursor:pointer;padding:6px;height:42px">ğŸ“‹</button>
<input type="hidden" name="icon" value="ğŸ“‹" id="editIconVal" class="icon-pick-val">
<div class="icon-picker-dropdown" style="display:none;position:absolute;top:100%;left:0;z-index:999;background:white;border:2px solid var(--border);border-radius:12px;padding:10px;width:320px;max-height:240px;overflow-y:auto;box-shadow:0 12px 40px rgba(0,0,0,.15)">
<input type="text" class="form-control icon-search" placeholder="Search icons..." style="font-size:12px;margin-bottom:8px;padding:6px 10px" oninput="filterIcons(this)">
<div class="icon-grid" style="display:grid;grid-template-columns:repeat(8,1fr);gap:4px">
{% for emoji, label in field_icons %}<button type="button" class="icon-opt" data-label="{{ label }}" onclick="pickIcon(this,'{{ emoji }}')" title="{{ label }}" style="font-size:18px;padding:6px;border:1px solid transparent;border-radius:8px;background:none;cursor:pointer;text-align:center" onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">{{ emoji }}</button>{% endfor %}
</div>
</div>
</div>
</div>
<div class="form-group" style="margin:0;flex:1"><label>Label</label><input name="label" id="editLabel" class="form-control" required></div>
</div>
<div style="display:flex;gap:12px">
<div class="form-group" style="margin:0;flex:1"><label>Type</label><select name="field_type" id="editType" class="form-control" style="font-size:13px;padding:8px;height:auto;appearance:auto;-webkit-appearance:auto">
<option value="text">ğŸ“ Text</option><option value="textarea">ğŸ“„ Textarea</option><option value="richtext">ğŸ“° Rich Text</option>
<option value="number">ğŸ”¢ Number</option><option value="url">ğŸ”— URL</option>
<option value="image">ğŸ–¼ï¸ Image</option><option value="audio">ğŸµ Audio</option><option value="video">ğŸ¬ Video</option><option value="images">ğŸ“¸ Multi-Images</option>
<option value="date">ğŸ“… Date</option><option value="select">ğŸ“‹ Select</option><option value="boolean">âœ… Yes/No</option><option value="color">ğŸ¨ Color</option><option value="json">ğŸ“¦ JSON</option>
</select></div>
<div class="form-group" style="margin:0;flex:1"><label>Placeholder</label><input name="placeholder" id="editPH" class="form-control"></div>
</div>
<div style="display:flex;gap:12px">
<div class="form-group" style="margin:0;width:100px"><label>Order</label><input name="sort_order" id="editOrder" type="number" class="form-control"></div>
<div class="form-group" style="margin:0;flex:1"><label>Scope</label><select name="applies_to" id="editScope" class="form-control" style="font-size:13px;padding:8px;height:auto;appearance:auto;-webkit-appearance:auto">
<option value="both">ğŸŒ All Tiers</option><option value="place">ğŸ›ï¸ T1 Only</option><option value="key_place">ğŸ“ T2 Only</option><option value="key_spot">ğŸ¯ T3 Only</option><option value="sub_spot">âœ¦ T4 Only</option><option value="t2_plus">ğŸ“ T2+</option><option value="t3_plus">ğŸ¯ T3+</option>
</select></div>
</div>
<div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
<button type="button" class="btn btn-secondary" onclick="closeEditField()">Cancel</button>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save</button>
</div>
</div>
</form>
</div>
</div>

<script>
function toggleIconPicker(btn) {
    const dd = btn.parentElement.querySelector('.icon-picker-dropdown');
    const show = dd.style.display === 'none';
    document.querySelectorAll('.icon-picker-dropdown').forEach(d => d.style.display = 'none');
    dd.style.display = show ? 'block' : 'none';
    if (show) dd.querySelector('.icon-search').focus();
}
function pickIcon(btn, emoji) {
    const wrap = btn.closest('.icon-picker-wrap');
    wrap.querySelector('.icon-pick-btn').textContent = emoji;
    wrap.querySelector('.icon-pick-val').value = emoji;
    wrap.querySelector('.icon-picker-dropdown').style.display = 'none';
}
function filterIcons(input) {
    const q = input.value.toLowerCase();
    input.parentElement.querySelectorAll('.icon-opt').forEach(b => {
        b.style.display = b.getAttribute('data-label').toLowerCase().includes(q) ? '' : 'none';
    });
}
document.addEventListener('click', function(e) {
    if (!e.target.closest('.icon-picker-wrap')) {
        document.querySelectorAll('.icon-picker-dropdown').forEach(d => d.style.display = 'none');
    }
});
function openEditField(id, label, type, ph, order, scope, icon) {
    document.getElementById('editFieldForm').action = '/admin/fields/' + id + '/update';
    document.getElementById('editLabel').value = label;
    document.getElementById('editType').value = type;
    document.getElementById('editPH').value = ph;
    document.getElementById('editOrder').value = order;
    document.getElementById('editScope').value = scope;
    document.getElementById('editIconBtn').textContent = icon;
    document.getElementById('editIconVal').value = icon;
    document.getElementById('editFieldModal').style.display = 'flex';
}
function closeEditField() { document.getElementById('editFieldModal').style.display = 'none'; }
</script>
{% endblock %}
