{% extends "admin/base.html" %}
{% block title %}Key Spots (Tier 3) â€” {{ kp.title }}{% endblock %}
{% block page_title %}
<div style="display:flex;align-items:center;gap:12px">
<span style="width:36px;height:36px;background:#E7484515;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px">ğŸ”¸</span>
<div>
<div style="font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:#E74845">Tier 3 Â· Key Spots</div>
<div>{{ kp.title }}</div>
</div>
</div>
{% endblock %}
{% block topbar_actions %}
<a href="{{ url_for('admin_place_edit', place_id=kp.dham_id) }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to {{ kp.dham_title }}</a>
{% endblock %}

{% block admin_content %}
<!-- Breadcrumb -->
<div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:20px;font-size:13px">
<a href="{{ url_for('admin_places') }}" style="display:flex;align-items:center;gap:4px;text-decoration:none;color:var(--text-light)"><span style="width:18px;height:18px;background:#C76B8F;color:white;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">T1</span> Holy Dhams</a>
<span style="color:var(--text-light)">â€º</span>
<a href="{{ url_for('admin_place_edit', place_id=kp.dham_id) }}" style="display:flex;align-items:center;gap:4px;text-decoration:none;color:var(--text-light)"><span style="width:18px;height:18px;background:#C76B8F;color:white;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">T1</span> {{ kp.dham_title }}</a>
<span style="color:var(--text-light)">â€º</span>
<span style="display:flex;align-items:center;gap:4px;color:#2E86AB;font-weight:600"><span style="width:18px;height:18px;background:#2E86AB;color:white;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">T2</span> {{ kp.title }}</span>
<span style="color:var(--text-light)">â€º</span>
<span style="display:flex;align-items:center;gap:4px;color:#E74845;font-weight:700"><span style="width:18px;height:18px;background:#E74845;color:white;border-radius:5px;display:inline-flex;align-items:center;justify-content:center;font-size:8px;font-weight:700">T3</span> Key Spots</span>
</div>

<!-- Tier Info -->
<div style="background:linear-gradient(135deg,#fdf5f5,#f8f0f0);border:1.5px solid #E7484520;border-radius:14px;padding:18px 22px;margin-bottom:20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap">
<span style="width:44px;height:44px;background:#E7484515;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">ğŸ”¸</span>
<div style="flex:1;min-width:200px">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
<span style="font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:3px 10px;background:#E74845;color:white;border-radius:50px">Tier 3</span>
<span style="font-size:14px;font-weight:700;color:#E74845">Key Spots</span>
</div>
<div style="font-size:13px;color:var(--text-mid)">Each spot has <strong>all fields</strong>: location, description, content, gallery, and custom fields. Use all sections to populate data.</div>
</div>
<div style="text-align:center;padding:8px 16px;background:white;border-radius:10px;border:1px solid var(--border)">
<div style="font-size:24px;font-weight:700;color:#E74845">{{ spots|length }}</div>
<div style="font-size:11px;color:var(--text-light)">Key Spots</div>
</div>
</div>

<form method="POST" action="{{ url_for('admin_key_spots_save', kp_id=kp.id) }}" enctype="multipart/form-data" id="spotsForm">
<div id="spots-container">
{% for spot in spots %}
{% set ki = loop.index0 %}
{% set scv = ks_customs.get(spot.id, {}) %}
<div class="ks-item admin-card" style="margin-bottom:16px;border-left:4px solid {{ spot.cat_color or '#E74C3C' }}" data-index="{{ ki }}">
<input type="hidden" name="ks_{{ ki }}_id" value="{{ spot.id }}">
<div class="admin-card-header" style="cursor:pointer;user-select:none" onclick="this.parentElement.classList.toggle('ks-collapsed')">
<div style="display:flex;align-items:center;gap:10px">
<span style="font-size:18px">{{ spot.cat_icon or 'ğŸ“' }}</span>
<span style="font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;background:#E7484510;color:#E74845;border-radius:50px;border:1px solid #E7484520">Tier 3</span>
<h3 class="ks-title-display" style="margin:0">{{ spot.title }}</h3>
<span class="badge" style="background:{{ spot.cat_color or '#E74C3C' }}15;color:{{ spot.cat_color or '#E74C3C' }};font-size:11px;border:1px solid {{ spot.cat_color or '#E74C3C' }}25">{{ spot.cat_name or 'No Category' }}</span>
</div>
<div style="display:flex;align-items:center;gap:8px">
<a href="{{ url_for('admin_key_spot_subs', ks_id=spot.id) }}" class="btn btn-secondary btn-sm" onclick="event.stopPropagation()" style="background:#9C27B008;color:#9C27B0;border:1px solid #9C27B030;font-size:11px;font-weight:700"><i class="fas fa-layer-group"></i> T4 Points</a>
<i class="fas fa-chevron-down ks-chevron" style="transition:transform .3s;color:var(--text-light)"></i>
</div>
</div>
<div class="ks-body" style="padding:20px">

<!-- Core -->
<div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)">
<div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ“Œ Core Identity</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label>ğŸ“ Title *</label><input type="text" class="form-control" name="ks_{{ ki }}_title" value="{{ spot.title }}" required></div>
<div class="form-group"><label>ğŸ·ï¸ Category</label><select class="form-control" name="ks_{{ ki }}_category"><option value="">â€” Select â€”</option>{% for cat in spot_categories %}<option value="{{ cat.id }}" {{ 'selected' if spot.category_id == cat.id }}>{{ cat.icon }} {{ cat.name }}</option>{% endfor %}</select></div>
</div>
<div class="form-group"><label>ğŸ“‹ Short Description</label><textarea class="form-control" name="ks_{{ ki }}_short_description" rows="2">{{ spot.short_description or '' }}</textarea></div>
<div class="form-group"><label>ğŸ“– Full Content</label><textarea class="form-control" name="ks_{{ ki }}_full_content" rows="4">{{ spot.full_content or '' }}</textarea></div>
</div>

<!-- Location -->
<div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)">
<div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ“ Location</div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div class="form-group"><label>ğŸ™ï¸ City</label><input type="text" class="form-control" name="ks_{{ ki }}_city" value="{{ spot.city or '' }}" placeholder="e.g. Vrindavan"></div>
<div class="form-group"><label>ğŸ—ºï¸ State</label><input type="text" class="form-control" name="ks_{{ ki }}_state" value="{{ spot.state or '' }}" placeholder="e.g. UP"></div>
<div class="form-group"><label>ğŸŒ Country</label><input type="text" class="form-control" name="ks_{{ ki }}_country" value="{{ spot.country or '' }}" placeholder="India"></div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
<div class="form-group"><label>ğŸ“ Latitude</label><input type="number" class="form-control" name="ks_{{ ki }}_latitude" value="{{ spot.latitude or '' }}" step="any"></div>
<div class="form-group"><label>ğŸ“ Longitude</label><input type="number" class="form-control" name="ks_{{ ki }}_longitude" value="{{ spot.longitude or '' }}" step="any"></div>
</div>
</div>

<!-- Images -->
<div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)">
<div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ–¼ï¸ Images & Gallery</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
<div class="form-group"><label>ğŸ–¼ï¸ Featured Image</label>
{% if spot.featured_image %}<input type="hidden" name="ks_{{ ki }}_featured_image_existing" value="{{ spot.featured_image }}">
<div class="gal-section" style="margin-bottom:6px"><div class="gal-thumbs"><div class="gal-thumb"><img src="/static/uploads/{{ spot.featured_image }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="deleteGalleryImage('t3',{{ spot.id }},'{{ spot.featured_image }}',this)" title="Delete">âœ•</span></div></div></div>{% endif %}
<input type="file" class="form-control" name="ks_{{ ki }}_featured_image_file" accept="image/*"></div>
<div class="form-group gal-section"><label>ğŸ“¸ Gallery Images
{% if spot.gallery_images %}<span class="gal-count">{{ spot.gallery_images.split(',')|length }} image{{ 's' if spot.gallery_images.split(',')|length != 1 }}</span>{% endif %}</label>
<input type="hidden" name="ks_{{ ki }}_gallery_existing" value="{{ spot.gallery_images or '' }}" class="gal-existing-input">
<input type="hidden" class="gal-captions-data" data-prefix="ks_{{ ki }}" value="{{ spot.gallery_captions|default('{}') }}">
{% if spot.gallery_images %}
<div class="gal-individual-list" id="ks_{{ ki }}_gal_list">
{% for gi in spot.gallery_images.split(',') %}{% if gi.strip() %}
<div class="gal-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-cream);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
<div class="gal-thumb" style="flex-shrink:0"><img src="/static/uploads/{{ gi.strip() }}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"></div>
<div style="flex:1;min-width:0">
<input type="text" class="form-control gal-caption-input" name="ks_{{ ki }}_caption_{{ gi.strip() }}" data-img="{{ gi.strip() }}" placeholder="Caption for this image..." style="font-size:12px">
<div style="font-size:10px;color:var(--text-light);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ gi.strip().split('/')[-1] }}</div>
</div>
<button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="galDeleteConfirm(this,'t3',{{ spot.id }},'{{ gi.strip() }}','ks_{{ ki }}')"><i class="fas fa-trash"></i></button>
</div>
{% endif %}{% endfor %}
</div>
{% endif %}
<div id="ks_{{ ki }}_new_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="margin-top:6px;font-size:11px" onclick="addGalleryItem('ks_{{ ki }}')"><i class="fas fa-plus"></i> Add More Images</button>
</div>
<div style="font-size:10px;color:var(--text-light);margin-top:3px">Click thumbnail to preview. Click âœ• to delete.</div></div>
</div>
</div>

<!-- Custom Fields -->
{% if custom_fields %}
<div style="margin-bottom:10px">
<div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">âš™ï¸ Custom Fields</div>
<div style="display:grid;gap:8px">
{% for cf in custom_fields %}{% if cf.name != 'entry_fee' and cf.name != 'gallery_images' %}
{% set cv = scv.get(cf.id, {}) %}
<div style="display:flex;gap:8px;align-items:start;background:var(--cream-dark);border-radius:10px;padding:10px 12px;border:1px solid var(--border)">
<div style="flex:1">
<label style="display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;margin-bottom:5px"><span style="font-size:15px">{{ cf.icon or 'ğŸ“‹' }}</span> {{ cf.label }} <span style="font-size:9px;padding:1px 5px;background:var(--border);border-radius:50px;color:var(--text-light)">{{ cf.field_type }}</span></label>
{% if cf.field_type in ('text','url','number') %}<input name="ks_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}" placeholder="{{ cf.placeholder }}" style="font-size:13px">
{% elif cf.field_type in ('textarea','richtext') %}<textarea name="ks_{{ ki }}_cf_{{ cf.id }}" class="form-control" rows="2" style="font-size:13px">{{ cv.get('value','') }}</textarea>
{% elif cf.field_type in ('image','audio','video') %}{% if cv.get('value') %}<input type="hidden" name="ks_{{ ki }}_cf_{{ cf.id }}" value="{{ cv.get('value','') }}">
{% if cf.field_type=='image' %}<div class="gal-section" style="margin-bottom:4px"><div class="gal-thumbs"><div class="gal-thumb"><img src="/static/uploads/{{ cv.get('value','') }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="cfDeleteImage(this,'ks_{{ ki }}_cf_{{ cf.id }}','{{ cv.get('value','') }}')" title="Delete">âœ•</span></div></div></div>
{% else %}<div style="font-size:10px;color:green;margin-bottom:3px">âœ… {{ cv.get('value','') }}</div>{% endif %}{% endif %}<input type="file" name="ks_{{ ki }}_cf_file_{{ cf.id }}" class="form-control" accept="{{ 'image/*' if cf.field_type=='image' else 'audio/*' if cf.field_type=='audio' else 'video/*' }}" style="font-size:13px">
{% elif cf.field_type == 'images' %}{% if cv.get('value') %}<input type="hidden" name="ks_{{ ki }}_cf_{{ cf.id }}" value="{{ cv.get('value','') }}">
<div class="gal-section" style="margin-bottom:4px"><span class="gal-count">{{ cv.get('value','').split(',')|reject('equalto','')|list|length }} image{{ 's' if cv.get('value','').split(',')|reject('equalto','')|list|length != 1 else '' }} already uploaded</span>
<div class="gal-thumbs">{% for gi in cv.get('value','').split(',') %}{% if gi.strip() %}<div class="gal-thumb"><img src="/static/uploads/{{ gi.strip() }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="cfDeleteImage(this,'ks_{{ ki }}_cf_{{ cf.id }}','{{ gi.strip() }}')" title="Delete image">âœ•</span></div>{% endif %}{% endfor %}</div></div>{% endif %}<input type="file" name="ks_{{ ki }}_cf_files_{{ cf.id }}" class="form-control" accept="image/*" multiple style="font-size:13px">
{% else %}<input name="ks_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}" style="font-size:13px">{% endif %}
</div>
<div style="padding-top:26px"><label style="display:flex;align-items:center;gap:3px;font-size:11px;cursor:pointer;white-space:nowrap"><input type="checkbox" name="ks_{{ ki }}_cf_vis_{{ cf.id }}" {{ 'checked' if cv.get('is_visible',1) }} style="accent-color:#27AE60"> Show</label></div>
</div>
{% endif %}{% endfor %}
</div></div>
{% endif %}

<!-- Controls -->
<div style="display:flex;gap:10px;margin-top:10px;align-items:center">
<label style="display:flex;align-items:center;gap:4px;font-size:12px;cursor:pointer"><input type="checkbox" name="ks_{{ ki }}_is_visible" {{ 'checked' if spot.is_visible }}> Visible</label>
<div style="margin-left:auto;display:flex;gap:8px">
<button type="button" class="btn btn-sm" style="background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c30" onclick="this.closest('.ks-item').remove()"><i class="fas fa-trash"></i></button>
<a href="{{ url_for('admin_key_spot_subs', ks_id=spot.id) }}" class="btn btn-sm" style="background:#9C27B008;color:#9C27B0;border:1px solid #9C27B030"><i class="fas fa-sitemap"></i> T4 Points â†’</a>
</div>
</div>
</div></div>
{% endfor %}
</div>

<div style="display:flex;gap:12px;margin-top:20px">
<button type="button" class="btn btn-secondary" id="addSpotBtn" style="border-color:#E7484540;color:#E74845"><i class="fas fa-plus"></i> Add Key Spot</button>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save All</button>
</div>
</form>

<style>.ks-item.ks-collapsed .ks-body{display:none}.ks-item.ks-collapsed .ks-chevron{transform:rotate(-90deg)}</style>
<script>
let spotIdx={{ spots|length }};
document.getElementById('addSpotBtn').addEventListener('click',function(){
const c=document.getElementById('spots-container');
const cfHtml=`{% for cf in custom_fields %}{% if cf.name!='entry_fee' and cf.name!='gallery_images' %}<div style="display:flex;gap:8px;align-items:start;background:var(--cream-dark);border-radius:10px;padding:10px 12px;border:1px solid var(--border)"><div style="flex:1"><label style="display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;margin-bottom:5px"><span style="font-size:15px">{{ cf.icon or 'ğŸ“‹' }}</span> {{ cf.label }}</label>{% if cf.field_type in ('text','url','number') %}<input name="ks_${spotIdx}_cf_{{ cf.id }}" class="form-control" placeholder="{{ cf.placeholder }}" style="font-size:13px">{% elif cf.field_type in ('textarea','richtext') %}<textarea name="ks_${spotIdx}_cf_{{ cf.id }}" class="form-control" rows="2" style="font-size:13px"></textarea>{% elif cf.field_type in ('image','audio','video') %}<input type="file" name="ks_${spotIdx}_cf_file_{{ cf.id }}" class="form-control" style="font-size:13px">{% elif cf.field_type=='images' %}<input type="file" name="ks_${spotIdx}_cf_files_{{ cf.id }}" class="form-control" accept="image/*" multiple style="font-size:13px">{% else %}<input name="ks_${spotIdx}_cf_{{ cf.id }}" class="form-control" style="font-size:13px">{% endif %}</div><div style="padding-top:26px"><label style="font-size:11px;cursor:pointer"><input type="checkbox" name="ks_${spotIdx}_cf_vis_{{ cf.id }}" checked style="accent-color:#27AE60"> Show</label></div></div>{% endif %}{% endfor %}`;
c.insertAdjacentHTML('beforeend',`<div class="ks-item admin-card" style="margin-bottom:16px;border-left:4px solid #E74C3C" data-index="${spotIdx}"><div class="admin-card-header" onclick="this.parentElement.classList.toggle('ks-collapsed')" style="cursor:pointer;user-select:none"><div style="display:flex;align-items:center;gap:10px"><span style="font-size:18px">ğŸ“</span><span style="font-size:9px;font-weight:700;padding:3px 8px;background:#E7484510;color:#E74845;border-radius:50px;border:1px solid #E7484520;letter-spacing:1px;text-transform:uppercase">T3</span><h3>New Key Spot</h3></div><i class="fas fa-chevron-down ks-chevron" style="transition:transform .3s;color:var(--text-light)"></i></div><div class="ks-body" style="padding:20px"><div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)"><div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ“Œ Core</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ğŸ“ Title *</label><input type="text" class="form-control" name="ks_${spotIdx}_title" required></div><div class="form-group"><label>ğŸ·ï¸ Category</label><select class="form-control" name="ks_${spotIdx}_category"><option value="">â€” Select â€”</option>{% for cat in spot_categories %}<option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>{% endfor %}</select></div></div><div class="form-group"><label>ğŸ“‹ Description</label><textarea class="form-control" name="ks_${spotIdx}_short_description" rows="2"></textarea></div><div class="form-group"><label>ğŸ“– Content</label><textarea class="form-control" name="ks_${spotIdx}_full_content" rows="4"></textarea></div></div><div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)"><div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ“ Location</div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px"><div class="form-group"><label>ğŸ™ï¸ City</label><input type="text" class="form-control" name="ks_${spotIdx}_city"></div><div class="form-group"><label>ğŸ—ºï¸ State</label><input type="text" class="form-control" name="ks_${spotIdx}_state"></div><div class="form-group"><label>ğŸŒ Country</label><input type="text" class="form-control" name="ks_${spotIdx}_country"></div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:12px"><div class="form-group"><label>ğŸ“ Lat</label><input type="number" class="form-control" name="ks_${spotIdx}_latitude" step="any"></div><div class="form-group"><label>ğŸ“ Lng</label><input type="number" class="form-control" name="ks_${spotIdx}_longitude" step="any"></div></div></div><div style="margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)"><div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">ğŸ–¼ï¸ Images</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:14px"><div class="form-group"><label>ğŸ–¼ï¸ Featured</label><input type="file" class="form-control" name="ks_${spotIdx}_featured_image_file" accept="image/*"></div><div class="form-group"><label>ğŸ“¸ Gallery</label><div id="ks_${spotIdx}_new_gals"></div><button type="button" class="btn btn-sm btn-secondary" style="margin-top:6px;font-size:11px" onclick="addGalleryItem('ks_${spotIdx}')"><i class="fas fa-plus"></i> Add More Images</button></div></div></div><div style="margin-bottom:10px"><div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#E74845;margin-bottom:10px">âš™ï¸ Custom Fields</div><div style="display:grid;gap:8px">${cfHtml}</div></div><div style="display:flex;gap:10px;align-items:center"><label style="font-size:12px;cursor:pointer"><input type="checkbox" name="ks_${spotIdx}_is_visible" checked> Visible</label><button type="button" class="btn btn-sm" style="background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c30;margin-left:auto" onclick="this.closest('.ks-item').remove()"><i class="fas fa-trash"></i></button></div></div></div>`);
spotIdx++;
});
</script>
{% endblock %}
