<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Admin{% endblock %} ‚Äì Holy Dham CMS</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<!-- Leaflet Maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--primary:#C76B8F;--primary-light:#F8E5EE;--primary-dark:#A04870;
--bg:#F5F0EB;--white:#FFFFFF;--card:#FFFFFF;
--text:#2D1F2E;--text-mid:#5A4A5B;--text-light:#8A7A8B;
--border:#E8DDD0;--success:#5B9A5B;--warning:#D49B3F;--danger:#C45050;
--sidebar-bg:#2D1F2E;--sidebar-text:rgba(255,255,255,.6);--sidebar-active:rgba(255,255,255,.1);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
.sidebar{width:260px;background:var(--sidebar-bg);color:var(--sidebar-text);padding:24px 0;display:flex;flex-direction:column;position:fixed;top:0;bottom:0;left:0;z-index:100;overflow-y:auto}
.sidebar-brand{padding:0 24px 24px;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:16px}
.sidebar-brand a{color:white;text-decoration:none;font-family:'Playfair Display',serif;font-size:20px;display:flex;align-items:center;gap:10px}
.sidebar-brand span{font-size:22px}
.sidebar-section{padding:0 12px;margin-bottom:8px}
.sidebar-section-title{padding:8px 12px;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);font-weight:600}
.sidebar-link{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:10px;color:var(--sidebar-text);text-decoration:none;font-size:14px;font-weight:500;transition:all .2s;margin-bottom:2px}
.sidebar-link:hover{background:var(--sidebar-active);color:white}
.sidebar-link.active{background:var(--primary);color:white}
.sidebar-link i{width:20px;text-align:center;font-size:15px}
.sidebar-link .badge{margin-left:auto;background:rgba(255,255,255,.15);color:white;font-size:11px;padding:2px 8px;border-radius:50px}

.sidebar-footer{margin-top:auto;padding:16px 24px;border-top:1px solid rgba(255,255,255,.06)}
.sidebar-user{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sidebar-avatar{width:36px;height:36px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px}
.sidebar-user-info{font-size:13px}.sidebar-user-info strong{color:white;display:block}
.sidebar-user-info span{font-size:11px;color:rgba(255,255,255,.4)}

/* ‚îÄ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ */
.main{margin-left:260px;flex:1;padding:0;min-height:100vh}
.topbar{padding:16px 32px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-family:'Playfair Display',serif;font-size:22px}
.topbar-actions{display:flex;gap:8px;align-items:center}
.content{padding:32px}

/* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
.admin-card{background:var(--card);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.admin-card-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.admin-card-header h3{font-size:16px;font-weight:600}
.admin-card-body{padding:24px}

/* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:white;border-radius:14px;padding:24px;border:1px solid var(--border);display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.stat-icon.rose{background:var(--primary-light);color:var(--primary)}
.stat-icon.green{background:#D4E5D4;color:#5B9A5B}
.stat-icon.amber{background:#F5ECD4;color:#D49B3F}
.stat-icon.blue{background:#D4E0F5;color:#5070C4}
.stat-num{font-size:28px;font-weight:700}
.stat-label{font-size:12px;color:var(--text-light);margin-top:2px}

/* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
.admin-table{width:100%;border-collapse:collapse}
.admin-table th{text-align:left;padding:12px 16px;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text-light);background:var(--bg);border-bottom:1px solid var(--border);font-weight:600}
.admin-table td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle}
.admin-table tr:hover td{background:rgba(200,100,143,.02)}
.admin-table .actions{display:flex;gap:6px}

/* ‚îÄ‚îÄ‚îÄ Badges ‚îÄ‚îÄ‚îÄ */
.badge{display:inline-block;padding:4px 12px;border-radius:50px;font-size:11px;font-weight:600}
.badge-published{background:#D4E5D4;color:#3A6B3A}
.badge-draft{background:#F5ECD4;color:#8B6B20}
.badge-super_admin{background:var(--primary-light);color:var(--primary)}
.badge-content_admin{background:#D4E0F5;color:#4060A4}
.badge-editor{background:#E8E5D4;color:#6B6540}

/* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:10px;font-family:'DM Sans';font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;text-decoration:none}
.btn-primary{background:var(--primary);color:white}
.btn-primary:hover{background:var(--primary-dark);color:white}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:#FDE8E8;color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:white}
.btn-sm{padding:6px 14px;font-size:12px}
.btn-icon{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px}

/* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-group .hint{font-size:12px;color:var(--text-light);margin-top:4px}
.form-control{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-family:'DM Sans';font-size:14px;background:white;outline:none;transition:border-color .2s}
.form-control:focus{border-color:var(--primary)}
textarea.form-control{min-height:120px;resize:vertical}
select.form-control{appearance:auto;-webkit-appearance:auto;-moz-appearance:auto;background:white;cursor:pointer;padding:12px 16px;transition:all .3s ease;color:var(--text-dark)}
select.form-control option{padding:8px 12px;font-size:14px;background:white;color:var(--text-dark)}
select.form-control:hover{border-color:var(--primary);box-shadow:0 2px 12px rgba(199,107,143,.1)}
select.form-control:focus{border-color:var(--primary);box-shadow:0 4px 16px rgba(199,107,143,.15);outline:none}

/* Beautiful Custom Select Dropdown */
.custom-select-wrap{position:relative}
.custom-select-trigger{width:100%;padding:12px 40px 12px 16px;border:1px solid var(--border);border-radius:10px;font-family:'DM Sans';font-size:14px;background:white;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:8px;user-select:none;position:relative}
.custom-select-trigger:hover{border-color:var(--primary);box-shadow:0 2px 12px rgba(199,107,143,.08)}
.custom-select-trigger.open{border-color:var(--primary);box-shadow:0 4px 16px rgba(199,107,143,.12);border-radius:10px 10px 0 0}
.custom-select-trigger::after{content:'';position:absolute;right:16px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--text-light);transition:transform .3s ease}
.custom-select-trigger.open::after{transform:translateY(-50%) rotate(180deg)}
.custom-select-options{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--primary);border-top:none;border-radius:0 0 10px 10px;max-height:0;overflow:hidden;opacity:0;transition:max-height .35s cubic-bezier(0.23,1,0.32,1),opacity .25s ease;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.08)}
.custom-select-options.open{max-height:280px;overflow-y:auto;opacity:1}
.custom-select-option{padding:10px 16px;cursor:pointer;font-size:14px;transition:all .15s;display:flex;align-items:center;gap:8px}
.custom-select-option:hover{background:var(--primary-light);color:var(--primary)}
.custom-select-option.selected{background:var(--primary-light);color:var(--primary);font-weight:600}
.custom-select-option:last-child{border-radius:0 0 10px 10px}
.custom-select-options::-webkit-scrollbar{width:6px}
.custom-select-options::-webkit-scrollbar-track{background:transparent}
.custom-select-options::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.custom-select-options::-webkit-scrollbar-thumb:hover{background:var(--primary)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-check{display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer}
.form-check input[type="checkbox"]{width:18px;height:18px;accent-color:var(--primary)}
.tag-select{display:flex;flex-wrap:wrap;gap:8px}
.tag-select label{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:50px;border:1px solid var(--border);font-size:13px;cursor:pointer;transition:all .2s}
.tag-select label:has(input:checked){background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.tag-select input{display:none}

/* ‚îÄ‚îÄ‚îÄ Quill Editor Override ‚îÄ‚îÄ‚îÄ */
.ql-container{font-family:'DM Sans',sans-serif;font-size:15px;border-radius:0 0 10px 10px;border-color:var(--border)!important;min-height:200px}
.ql-toolbar{border-radius:10px 10px 0 0;border-color:var(--border)!important;background:var(--bg)}
.ql-editor{min-height:200px}

/* ‚îÄ‚îÄ‚îÄ Flash Messages ‚îÄ‚îÄ‚îÄ */
.flash{padding:14px 20px;border-radius:12px;margin-bottom:16px;font-size:14px;display:flex;align-items:center;gap:10px}
.flash-success{background:#D4E5D4;color:#2A5A2A}
.flash-error{background:#FDE8E8;color:#8B2020}
.flash-warning{background:#F5ECD4;color:#6B5020}
.flash-info{background:#D4E0F5;color:#2A4080}

/* ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ */
.empty{text-align:center;padding:48px 20px;color:var(--text-light)}
.empty .icon{font-size:40px;margin-bottom:12px;display:block}
.empty h3{font-size:18px;color:var(--text);margin-bottom:6px}

/* ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ */
.sidebar-toggle{display:none;background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)}
@media(max-width:1024px){
.sidebar{transform:translateX(-100%);transition:transform .3s}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.sidebar-toggle{display:block}
.content{padding:20px}
.form-row{grid-template-columns:1fr}
/* Dashboard 1.5fr+1fr layout ‚Üí stack on tablet */
[style*="grid-template-columns:1.5fr 1fr"]{grid-template-columns:1fr!important}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   TABLET (max-width: 768px) ‚Äî Covers ALL admin panel pages
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:768px){

/* ‚îÄ‚îÄ‚îÄ Global Layout ‚îÄ‚îÄ‚îÄ */
.content{padding:10px!important}
.topbar{padding:10px 14px!important}
.topbar h1{font-size:17px!important}
.topbar-actions{gap:4px!important}
.topbar-actions .btn{padding:7px 10px!important;font-size:11px!important}

/* ‚îÄ‚îÄ‚îÄ Global Typography & Spacing ‚îÄ‚îÄ‚îÄ */
h1{font-size:20px!important}
h2{font-size:17px!important}
h3{font-size:15px!important}

/* ‚îÄ‚îÄ‚îÄ Buttons (Global) ‚îÄ‚îÄ‚îÄ */
.btn{font-size:12px!important;padding:8px 14px!important}
.btn-sm{font-size:11px!important;padding:6px 10px!important}
.btn-icon{padding:6px 8px!important;min-width:32px!important}

/* ‚îÄ‚îÄ‚îÄ Form Controls (Global) ‚îÄ‚îÄ‚îÄ */
.form-control{font-size:13px!important;padding:10px 12px!important}
select.form-control{font-size:13px!important}
.form-group{margin-bottom:10px!important}
.form-group label{font-size:12px!important}
textarea.form-control{min-height:60px}
input[type="file"]{font-size:11px!important}
input[type="file"]::file-selector-button{padding:6px 12px!important;font-size:11px!important;margin-right:8px!important}

/* ‚îÄ‚îÄ‚îÄ Admin Cards (Global) ‚îÄ‚îÄ‚îÄ */
.admin-card{border-radius:12px!important}
.admin-card-header{padding:12px 14px!important;flex-wrap:wrap;gap:8px}
.admin-card-header h3{font-size:14px!important}
.admin-card-body{padding:12px!important}

/* ‚îÄ‚îÄ‚îÄ Tables (Global ‚Äî all admin pages) ‚îÄ‚îÄ‚îÄ */
.admin-table,.ft-table{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch;font-size:12px!important}
.admin-table th{padding:8px 10px!important;font-size:10px!important;white-space:nowrap}
.admin-table td{padding:10px!important;font-size:12px!important}
.admin-table .actions{gap:4px!important}
/* Make tables more compact on mobile */
.admin-table td a{font-size:12px!important}
.admin-table .badge{font-size:10px!important;padding:2px 8px!important}

/* ‚îÄ‚îÄ‚îÄ Force ALL inline grids ‚Üí single column ‚îÄ‚îÄ‚îÄ */
[style*="grid-template-columns:1fr 1fr 1fr"]{grid-template-columns:1fr!important}
[style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr!important}
[style*="grid-template-columns: 1fr 1fr"]{grid-template-columns:1fr!important}
[style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr)!important}
[style*="grid-template-columns:repeat(3"]{grid-template-columns:1fr!important}
[style*="grid-template-columns:1.5fr"]{grid-template-columns:1fr!important}
[style*="grid-template-columns: 1fr 320px"]{grid-template-columns:1fr!important}

/* ‚îÄ‚îÄ‚îÄ Force inline fixed widths to be flexible ‚îÄ‚îÄ‚îÄ */
[style*="width:240px"]{width:100%!important}
[style*="width:200px"]{width:100%!important}
[style*="width:180px"]{width:100%!important}
[style*="width:160px"]{width:100%!important}
[style*="width:150px"]{width:100%!important}
[style*="width:140px"]{width:100%!important}
[style*="width:100px"]{width:100%!important}
[style*="width:90px"]{width:100%!important}
[style*="width:70px"]{width:80px!important}
[style*="width:60px"]{width:70px!important}
[style*="max-width:700px"]{max-width:100%!important}
[style*="max-width:300px"]{max-width:100%!important}

/* ‚îÄ‚îÄ‚îÄ Inline flex forms ‚Üí column stack on mobile ‚îÄ‚îÄ‚îÄ */
form[style*="display:flex"][style*="align-items:end"]{flex-direction:column!important;align-items:stretch!important}
form[style*="display:flex"][style*="align-items:end"] .form-group{width:100%!important;min-width:0!important}
form[style*="display:flex"][style*="align-items:end"] .btn{width:100%!important;justify-content:center}

/* ‚ïê‚ïê‚ïê DASHBOARD PAGE ‚ïê‚ïê‚ïê */
/* Hero stats gradient box */
[style*="background:linear-gradient(135deg,#2D1F2E"]{padding:16px!important;border-radius:12px!important}
[style*="background:linear-gradient(135deg,#2D1F2E"] h3{font-size:11px!important;margin-bottom:10px!important}
[style*="background:linear-gradient(135deg,#2D1F2E"] [style*="grid-template-columns:repeat(4"]{grid-template-columns:repeat(2,1fr)!important;gap:10px!important}
[style*="background:rgba(255,255,255,.08)"]{padding:12px!important;border-radius:10px!important}
[style*="background:rgba(255,255,255,.08)"] [style*="font-size:28px"]{font-size:22px!important}
/* Stat cards grid */
.stats-grid{grid-template-columns:repeat(2,1fr)!important;gap:10px!important}
.stat-card{padding:14px!important;gap:10px!important}
.stat-icon{width:38px!important;height:38px!important;font-size:16px!important;border-radius:10px!important}
.stat-num{font-size:22px!important}
.stat-label{font-size:11px!important}
/* Help accordion */
.help-accordion-toggle{padding:12px 14px!important}
.help-accordion-toggle h4{font-size:13px!important}
.help-accordion-inner{padding:0 14px 14px!important;font-size:12px!important}
.help-accordion-inner h5{font-size:13px!important}
.help-accordion-inner .ha-tier-flow{flex-direction:column!important;gap:4px!important;align-items:stretch!important}
.help-accordion-inner .ha-tier-box{padding:8px 12px!important;font-size:11px!important;border-radius:8px}
.help-accordion-inner .ha-tier-arrow{transform:rotate(90deg);text-align:center;margin:0!important;font-size:14px}
.help-accordion-inner table{display:block;overflow-x:auto;font-size:11px}
.help-accordion-inner .ha-tip{font-size:11px!important;padding:8px 12px!important}

/* ‚ïê‚ïê‚ïê PLACES LIST PAGE ‚ïê‚ïê‚ïê */
/* Search bar */
[style*="margin-left:auto"][style*="display:flex"][style*="gap:8px"]{margin-left:0!important;width:100%!important}
[style*="margin-left:auto"][style*="display:flex"][style*="gap:8px"] input{flex:1!important}

/* ‚ïê‚ïê‚ïê TAGS & CATEGORIES PAGE ‚ïê‚ïê‚ïê */
/* Section headers */
[style*="font-size:18px"][style*="font-weight:700"][style*="display:flex"]{font-size:15px!important;flex-wrap:wrap}
/* Category edit modal */
#catEditModal > div{width:92vw!important;padding:20px!important}
#catEditModal [style*="display:flex"][style*="gap:12px"]{flex-direction:column!important}
#catEditModal [style*="width:70px"]{width:80px!important}
#catEditModal [style*="width:120px"]{width:100%!important}

/* ‚ïê‚ïê‚ïê CUSTOM FIELDS PAGE ‚ïê‚ïê‚ïê */
/* Icon picker dropdown */
.icon-picker-dropdown{width:280px!important;left:-10px!important}
.icon-grid{grid-template-columns:repeat(7,1fr)!important}

/* ‚ïê‚ïê‚ïê MEDIA LIBRARY PAGE ‚ïê‚ïê‚ïê */
/* Media grid */
[style*="grid-template-columns:repeat(auto-fill,minmax(200px"]{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))!important;gap:10px!important}
/* Filter buttons */
[style*="display:flex"][style*="gap:8px"][style*="margin-bottom:20px"]{gap:6px!important}
[style*="display:flex"][style*="gap:8px"][style*="margin-bottom:20px"] .btn{padding:6px 10px!important;font-size:11px!important}

/* ‚ïê‚ïê‚ïê REPORTS PAGE ‚ïê‚ïê‚ïê */
[style*="padding:16px 20px"]{padding:12px!important}
.report-actions,.ov-actions{flex-wrap:wrap}

/* ‚ïê‚ïê‚ïê PAGES/SECTIONS PAGE ‚ïê‚ïê‚ïê */
.sec-head{padding:10px 14px!important;gap:8px!important}
.sec-title-text{font-size:13px!important}
.sec-actions{gap:2px!important}
.sec-actions .btn{padding:4px 8px!important;font-size:10px!important}
.sec-field{margin-bottom:8px!important}
.sec-field label{font-size:11px!important}
.sec-field input,.sec-field textarea,.sec-field select{font-size:13px!important;padding:8px 10px!important}
.sec-preview{max-width:180px!important;font-size:10px!important}
.add-section-bar{flex-direction:column!important;gap:8px!important;padding:12px!important}
.add-section-bar input,.add-section-bar select{width:100%!important}
.item-row{flex-direction:column!important;gap:6px!important;padding:8px 10px!important}
/* Page edit sidebar ‚Üí stack */
form > [style*="grid-template-columns: 1fr 320px"]{grid-template-columns:1fr!important}

/* ‚ïê‚ïê‚ïê EMAIL SETTINGS PAGE ‚ïê‚ïê‚ïê */
[style*="grid-template-columns:1fr 1fr"][style*="gap:14px"]{grid-template-columns:1fr!important}
form[style*="max-width:700px"]{max-width:100%!important}

/* ‚ïê‚ïê‚ïê USERS PAGE ‚ïê‚ïê‚ïê */
/* User avatar row in table */
td[style*="display:flex"]{display:flex!important;gap:8px!important}
td[style*="display:flex"] [style*="width:36px"]{width:28px!important;height:28px!important;font-size:11px!important;border-radius:8px!important}

/* ‚ïê‚ïê‚ïê USER FORM PAGE ‚ïê‚ïê‚ïê */
[style*="grid-template-columns:1fr 1fr"][style*="gap:8px"]{grid-template-columns:1fr!important}

/* ‚ïê‚ïê‚ïê MODULES PAGE ‚ïê‚ïê‚ïê */
[style*="grid-template-columns:repeat(auto-fill,minmax(300px"]{grid-template-columns:1fr!important}
[style*="min-height:200px"][style*="border:2px dashed"]{min-height:80px!important}

/* ‚ïê‚ïê‚ïê ENTRIES PAGE ‚ïê‚ïê‚ïê */
/* Filter buttons row */
[style*="display:flex"][style*="gap:8px"][style*="flex-wrap:wrap"] .btn{font-size:11px!important;padding:6px 10px!important}

/* ‚ïê‚ïê‚ïê PLACE FORM (T1/T2 Edit) ‚ïê‚ïê‚ïê */
.place-two-col{grid-template-columns:1fr!important;gap:14px!important}
.tier-tabs-grid{grid-template-columns:1fr 1fr!important;gap:6px!important}
.tier-tabs-grid .tier-tab{padding:10px 8px!important;font-size:11px!important}
.tier-def{flex-direction:column!important;gap:10px!important;padding:14px!important}
.tier-def-icon{width:40px!important;height:40px!important;font-size:22px!important}
.field-row{flex-direction:column!important}
.field-row .field-toggle{padding-top:0!important}
/* KP accordions */
.kp-accordion-header{padding:12px 14px!important}
.kp-accordion-header h4{font-size:13px!important;flex-wrap:wrap}
.kp-accordion-header .kp-actions{width:100%;justify-content:flex-end}
.kp-accordion-body-inner{padding:14px!important}
.kp-num{width:24px!important;height:24px!important;font-size:10px!important}
/* Overview cards */
.overview-card{flex-direction:column!important;align-items:flex-start!important;gap:8px!important;padding:12px!important}
.overview-card .ov-icon{width:34px!important;height:34px!important;font-size:16px!important}
.overview-card .ov-actions{width:100%;justify-content:flex-start}
/* Section save */
.section-save{justify-content:stretch!important}
.section-save .btn{width:100%;justify-content:center}
/* Back button row */
.back-btn-row{flex-direction:column!important}
.back-btn-row .btn,.back-btn-row a{width:100%;text-align:center;justify-content:center}
/* Gallery items */
.gal-item{flex-direction:column!important;align-items:stretch!important}
.gal-item .gal-thumb{width:100%!important;height:auto!important}
.gal-item .gal-thumb img{width:100%!important;height:120px!important;object-fit:cover!important}
.gal-new-item{flex-direction:column!important}
/* Hier breadcrumbs */
.hier-bc{font-size:10px!important}
/* Quick info row */
.quick-info-row{flex-wrap:wrap!important;gap:4px!important}

/* ‚ïê‚ïê‚ïê KEY SPOTS (T3) & SUB SPOTS (T4) ‚ïê‚ïê‚ïê */
.ks-body,.ss-body{padding:12px!important}

/* ‚ïê‚ïê‚ïê LOCATION PICKER (all tiers) ‚ïê‚ïê‚ïê */
.loc-picker{padding:10px!important}
.loc-picker-title{font-size:13px!important;flex-wrap:wrap;gap:6px}
.loc-map-container{height:200px!important}
.loc-search-bar{flex-direction:column}
.loc-search-bar input{font-size:12px!important}
.loc-search-bar button{width:100%}
.loc-actions-row{flex-direction:column}
.loc-actions-row .loc-btn{width:100%;justify-content:center}
.loc-coords-row{grid-template-columns:1fr!important}
.loc-saved{flex-direction:column;gap:6px!important;font-size:11px!important}

/* ‚ïê‚ïê‚ïê CAMERA CAPTURE ‚ïê‚ïê‚ïê */
.cam-btn{font-size:12px!important;padding:9px 14px!important}
.cam-desc input{font-size:11px!important}

/* ‚ïê‚ïê‚ïê HELP GUIDE PAGE ‚ïê‚ïê‚ïê */
.help-hero{padding:12px 0 20px!important}
.help-hero h1{font-size:22px!important}
.help-hero p{font-size:13px!important}
.help-nav{gap:6px!important;padding:10px!important}
.help-nav a{font-size:11px!important;padding:6px 12px!important}
.help-section-head{padding:16px!important}
.help-section-head h2{font-size:15px!important}
.help-section-head p{font-size:12px!important}
.help-body{padding:14px!important}
.help-body h3{font-size:14px!important}
.help-body p,.help-body li{font-size:12px!important}
.help-body ul{padding-left:16px!important}
.help-tier-flow{flex-direction:column;align-items:stretch!important;gap:4px!important}
.help-tier-box{min-width:auto!important;padding:10px!important;font-size:12px!important}
.help-tier-arrow{transform:rotate(90deg);text-align:center;margin:0!important}
.help-example{font-size:12px!important;padding:10px!important}
.code-block{font-size:10px!important;padding:10px!important}
.help-tip,.help-warn{font-size:11px!important;padding:10px 12px!important}

/* ‚ïê‚ïê‚ïê INFO POPUP (location & camera) ‚ïê‚ïê‚ïê */
.loc-info-popup{max-width:95vw!important;max-height:90vh!important}
.loc-info-popup-head{padding:14px 16px 10px!important}
.loc-info-popup-head h3{font-size:15px!important}
.loc-info-popup-body{padding:14px 16px 18px!important}
.loc-info-popup-body h4{font-size:13px!important}
.loc-info-popup-body p{font-size:12px!important}
.loc-info-popup-body .info-step{padding:6px 10px!important;font-size:11px!important}

/* ‚ïê‚ïê‚ïê MODALS & OVERLAYS ‚ïê‚ïê‚ïê */
.dbl-confirm-box{width:90vw!important;padding:20px!important}
.lightbox-overlay img{max-width:95vw!important;max-height:85vh!important}

/* ‚ïê‚ïê‚ïê SIDEBAR OVERLAY ‚ïê‚ïê‚ïê */
.sidebar-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;display:none}
.sidebar-overlay.active{display:block}

/* ‚ïê‚ïê‚ïê EMPTY STATES ‚ïê‚ïê‚ïê */
.empty{padding:30px 16px!important}
.empty .icon{font-size:36px!important}
.empty h3{font-size:16px!important}
.empty p{font-size:12px!important}

/* ‚ïê‚ïê‚ïê BADGES ‚ïê‚ïê‚ïê */
.badge{font-size:10px!important;padding:3px 8px!important}

/* ‚ïê‚ïê‚ïê FORM FOOTERS (entry, module, user forms) ‚ïê‚ïê‚ïê */
[style*="padding:16px 24px"][style*="border-top"][style*="justify-content:flex-end"]{padding:12px!important;flex-direction:column!important;gap:8px!important}
[style*="padding:16px 24px"][style*="border-top"][style*="justify-content:flex-end"] .btn{width:100%!important;justify-content:center!important}

/* ‚ïê‚ïê‚ïê GENERAL INLINE PADDING FIXES ‚ïê‚ïê‚ïê */
[style*="padding:24px 28px"]{padding:14px!important}
[style*="padding:24px"]:not(.admin-card-body):not(.stat-card){padding:14px!important}
[style*="padding:20px"]:not(.admin-card-header){padding:12px!important}

/* ‚ïê‚ïê‚ïê HIERARCHY SEARCH ‚ïê‚ïê‚ïê */
.hsearch-wrap{width:100%!important}
.hsearch-input{font-size:13px!important;padding:9px 12px 9px 34px!important}
.hsearch-results{max-height:350px}
.hsearch-item{padding:10px 12px;gap:8px}
.hsearch-tier-icon{width:32px;height:32px;font-size:15px}
.hsearch-title{font-size:12.5px}
.hsearch-crumb{font-size:9px;max-width:120px}
.hsearch-meta{font-size:10px}

} /* end @media(max-width:768px) */

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SMALL PHONE (max-width: 420px) ‚Äî Extra compact
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:420px){
.content{padding:8px!important}
.topbar{padding:8px 10px!important}
.topbar h1{font-size:15px!important}
.topbar-actions .btn span{display:none}
/* Dashboard tier stats ‚Üí single column */
[style*="background:linear-gradient(135deg,#2D1F2E"] [style*="grid-template-columns:repeat(4"]{grid-template-columns:1fr!important}
[style*="background:rgba(255,255,255,.08)"] [style*="font-size:28px"]{font-size:20px!important}
.stats-grid{grid-template-columns:1fr!important}
.stat-card{padding:12px!important}
.stat-num{font-size:20px!important}
/* Admin cards tighter */
.admin-card-header{padding:10px 12px!important}
.admin-card-body{padding:10px!important}
/* Buttons tighter */
.btn{padding:7px 10px!important;font-size:11px!important}
/* Tables even more compact */
.admin-table th{padding:6px 8px!important;font-size:9px!important}
.admin-table td{padding:8px!important;font-size:11px!important}
/* Tier tabs ‚Üí single col */
.tier-tabs-grid{grid-template-columns:1fr!important}
/* Module cards ‚Üí single */
[style*="grid-template-columns:repeat(auto-fill,minmax(300px"]{grid-template-columns:1fr!important}
/* Location picker even smaller */
.loc-map-container{height:170px!important}
/* Help guide tighter */
.help-nav a{padding:5px 8px!important;font-size:10px!important}
}
/* ‚îÄ‚îÄ‚îÄ Beautiful File Upload ‚îÄ‚îÄ‚îÄ */
input[type="file"]{font-family:inherit;font-size:13px;color:#555}
input[type="file"]::file-selector-button{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;padding:8px 18px;border-radius:50px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;margin-right:12px;transition:all .25s;box-shadow:0 2px 8px rgba(99,102,241,.2)}
input[type="file"]::file-selector-button:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(99,102,241,.35)}
/* Gallery Thumbnails */
.gal-thumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.gal-thumb{position:relative;width:64px;height:64px;border-radius:8px;overflow:hidden;border:2px solid var(--border);cursor:pointer;transition:all .2s}
.gal-thumb:hover{border-color:var(--primary);transform:scale(1.05)}
.gal-thumb img{width:100%;height:100%;object-fit:cover}
.gal-thumb .gal-del{position:absolute;top:-2px;right:-2px;width:22px;height:22px;background:#E53935;color:white;border:2px solid white;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0.85;transition:opacity .2s,transform .2s;z-index:2;line-height:1;font-weight:bold}
.gal-thumb:hover .gal-del{opacity:1;transform:scale(1.1)}
.gal-count{font-family:'DM Sans';font-size:11px;color:var(--text-light);font-weight:600;background:var(--bg-cream);padding:2px 10px;border-radius:50px;display:inline-flex;align-items:center;gap:4px}
.delete-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);background:#2E7D32;color:white;padding:12px 28px;border-radius:50px;font-size:14px;font-weight:600;z-index:99999;opacity:0;transition:all .3s;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.delete-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
/* Lightbox */
.lightbox-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;cursor:zoom-out}
.lightbox-overlay.active{display:flex}
.lightbox-overlay img{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.lightbox-close{position:absolute;top:20px;right:24px;color:white;font-size:32px;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);transition:all .2s}
.lightbox-close:hover{background:rgba(255,255,255,.25)}
/* Double confirm modal */
.dbl-confirm{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.dbl-confirm.active{display:flex}
.dbl-confirm-box{background:white;border-radius:16px;padding:28px;width:400px;max-width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.2);text-align:center}
.dbl-confirm-box h3{font-family:'Josefin Sans',sans-serif;margin-bottom:8px}
.dbl-confirm-box p{color:var(--text-light);font-size:14px;margin-bottom:20px;line-height:1.6}
.dbl-confirm-box .warn{color:#E53935;font-weight:600;font-size:13px;margin-bottom:16px}
.dbl-confirm-btns{display:flex;gap:10px;justify-content:center}
/* Help Guide Accordion */
.help-accordion{margin-bottom:20px;background:white;border-radius:12px;border:1px solid var(--border);border-left:4px solid var(--primary);overflow:hidden}
.help-accordion-toggle{padding:14px 18px;cursor:pointer;display:flex;align-items:center;gap:10px;user-select:none;transition:background .2s}
.help-accordion-toggle:hover{background:var(--bg-cream)}
.help-accordion-toggle h4{flex:1;font-size:14px;font-weight:700;margin:0;color:var(--text-dark)}
.help-accordion-toggle .ha-chevron{width:18px;height:18px;transition:transform .3s;color:var(--text-light);flex-shrink:0}
.help-accordion.ha-open .ha-chevron{transform:rotate(180deg)}
.help-accordion-body{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.23,1,.32,1)}
.help-accordion.ha-open .help-accordion-body{max-height:5000px}
.help-accordion-inner{padding:0 18px 18px;font-size:13px;color:var(--text-mid);line-height:1.75}
.help-accordion-inner p{margin-bottom:10px}
.help-accordion-inner h5{font-size:13px;font-weight:700;color:var(--text-dark);margin:14px 0 6px}
.help-accordion-inner ul{margin:6px 0 12px;padding-left:18px}
.help-accordion-inner li{margin-bottom:4px}
.help-accordion-inner li strong{color:var(--text-dark)}
.help-accordion-inner .ha-example{background:var(--bg-cream);border:1px solid var(--border);border-radius:8px;padding:12px;margin:8px 0;font-size:12px}
.help-accordion-inner .ha-tip{background:#E8F5E9;border:1px solid #C8E6C9;border-radius:8px;padding:10px 14px;margin:10px 0;font-size:12px;color:#2E7D32}
.help-accordion-inner .ha-warn{background:#FFF3E0;border:1px solid #FFE0B2;border-radius:8px;padding:10px 14px;margin:10px 0;font-size:12px;color:#E65100}
.help-accordion-inner .ha-tier-flow{display:flex;align-items:center;gap:0;margin:12px 0;flex-wrap:wrap}
.help-accordion-inner .ha-tier-box{padding:8px 14px;border-radius:8px;font-size:11px;font-weight:700;text-align:center;color:white}
.help-accordion-inner .ha-tier-arrow{font-size:16px;color:var(--text-light);margin:0 4px}
.help-accordion-inner table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}
.help-accordion-inner th{background:var(--bg-cream);padding:8px 10px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:.5px}
.help-accordion-inner td{padding:8px 10px;border-bottom:1px solid var(--border)}
.help-accordion-inner .code-block{background:#1e1e2e;color:#cdd6f4;padding:12px;border-radius:8px;font-family:'Courier New',monospace;font-size:11px;overflow-x:auto;margin:8px 0;line-height:1.5}
.help-accordion-inner .code-block .key{color:#89b4fa}
.help-accordion-inner .code-block .val{color:#a6e3a1}
.help-accordion-inner .code-block .str{color:#f9e2af}
/* ‚ïê‚ïê‚ïê Location Picker Widget ‚ïê‚ïê‚ïê */
.loc-picker{background:var(--bg);border:2px solid var(--border);border-radius:14px;padding:16px;margin-bottom:8px}
.loc-picker-title{display:flex;align-items:center;gap:8px;font-size:13px;font-weight:700;color:var(--text);margin-bottom:12px}
.loc-picker-title .loc-badge{font-size:9px;padding:3px 8px;background:var(--primary);color:white;border-radius:50px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.loc-saved{display:flex;align-items:center;gap:10px;padding:10px 14px;background:white;border:1px solid var(--border);border-radius:10px;margin-bottom:12px;font-size:12px;flex-wrap:wrap}
.loc-saved .loc-coords-display{font-family:monospace;font-size:13px;font-weight:600;color:var(--primary-dark);background:var(--primary-light);padding:4px 10px;border-radius:6px}
.loc-saved .loc-no-data{color:var(--text-light);font-style:italic}
.loc-saved .loc-accuracy{font-size:11px;color:var(--success);display:flex;align-items:center;gap:4px}
.loc-saved .loc-updated{font-size:10px;color:var(--text-light);margin-left:auto}
.loc-map-container{position:relative;height:260px;border-radius:12px;overflow:hidden;border:2px solid var(--border);margin-bottom:12px;background:#e8e0d8}
.loc-map-container .leaflet-container{height:100%;width:100%;z-index:1}
.loc-search-bar{display:flex;gap:8px;margin-bottom:12px}
.loc-search-bar input{flex:1;padding:9px 14px;border:2px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border .2s}
.loc-search-bar input:focus{border-color:var(--primary)}
.loc-search-bar button{padding:9px 16px;background:var(--primary);color:white;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.loc-search-bar button:hover{background:var(--primary-dark)}
.loc-actions-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.loc-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;border:1.5px solid}
.loc-btn-gps{background:#E8F5E9;border-color:#81C784;color:#2E7D32}
.loc-btn-gps:hover{background:#C8E6C9}
.loc-btn-gps.loading{opacity:.6;cursor:wait}
.loc-btn-clear{background:#FFF3E0;border-color:#FFB74D;color:#E65100}
.loc-btn-clear:hover{background:#FFE0B2}
.loc-coords-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.loc-coords-row .form-group{margin-bottom:0}
.loc-status{padding:8px 12px;border-radius:8px;font-size:12px;margin-bottom:10px;display:none;align-items:center;gap:6px}
.loc-status.info{display:flex;background:#E3F2FD;border:1px solid #90CAF9;color:#1565C0}
.loc-status.success{display:flex;background:#E8F5E9;border:1px solid #A5D6A7;color:#2E7D32}
.loc-status.error{display:flex;background:#FFEBEE;border:1px solid #EF9A9A;color:#C62828}
.loc-search-results{position:absolute;top:100%;left:0;right:0;background:white;border:2px solid var(--border);border-radius:10px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,.12);display:none}
.loc-search-results.active{display:block}
.loc-search-result{padding:10px 14px;cursor:pointer;font-size:12px;border-bottom:1px solid var(--border);transition:background .15s}
.loc-search-result:hover{background:var(--primary-light)}
.loc-search-result:last-child{border-bottom:none}
/* Location Picker Info Popup */
.loc-info-btn{width:28px;height:28px;border-radius:50%;border:1.5px solid var(--border);background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .2s;flex-shrink:0;color:var(--primary)}
.loc-info-btn:hover{background:var(--primary);color:white;border-color:var(--primary)}

/* ‚ïê‚ïê‚ïê Camera Capture (Mobile/Tablet Only) ‚ïê‚ïê‚ïê */
.cam-capture-wrap{display:none}

/* ‚ïê‚ïê‚ïê Hierarchy ID Badges ‚ïê‚ïê‚ïê */
.hid-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 10px;background:#F3E5F5;border:1px solid #CE93D8;border-radius:6px;font-family:'Courier New',monospace;font-size:12px;font-weight:700;color:#6A1B9A;letter-spacing:.5px;cursor:pointer;transition:all .2s;user-select:all}
.hid-badge:hover{background:#E1BEE7;border-color:#AB47BC}
.hid-badge .hid-copy{font-size:10px;opacity:.5;transition:opacity .2s}
.hid-badge:hover .hid-copy{opacity:1}
.hid-badge.copied{background:#C8E6C9!important;border-color:#66BB6A!important;color:#2E7D32!important}
.hid-label{font-size:10px;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.hid-readonly{background:#F5F0EB;border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;font-family:'Courier New',monospace;font-size:13px;font-weight:700;color:#6A1B9A;letter-spacing:1px;width:100%;cursor:default}

/* ‚ïê‚ïê‚ïê Live Hierarchy Search Widget ‚ïê‚ïê‚ïê */
.hsearch-wrap{position:relative;width:100%}
.hsearch-input{width:100%;padding:10px 14px 10px 38px;border:2px solid var(--border);border-radius:10px;font-size:14px;background:white;transition:all .25s;outline:none;color:var(--text)}
.hsearch-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(199,107,143,.12)}
.hsearch-input::placeholder{color:#aaa}
.hsearch-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:#aaa;pointer-events:none;transition:color .2s}
.hsearch-input:focus ~ .hsearch-icon,.hsearch-wrap:focus-within .hsearch-icon{color:var(--primary)}
.hsearch-clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);width:22px;height:22px;border-radius:50%;background:#eee;border:none;cursor:pointer;display:none;align-items:center;justify-content:center;font-size:11px;color:#888;line-height:1}
.hsearch-clear:hover{background:#ddd;color:#333}
.hsearch-results{position:absolute;top:calc(100% + 4px);left:0;right:0;background:white;border:1.5px solid var(--border);border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.12);z-index:999;max-height:420px;overflow-y:auto;display:none;scrollbar-width:thin}
.hsearch-results.active{display:block}
.hsearch-results::-webkit-scrollbar{width:5px}
.hsearch-results::-webkit-scrollbar-thumb{background:#ccc;border-radius:5px}
.hsearch-item{display:flex;gap:12px;padding:12px 16px;cursor:pointer;transition:background .15s;border-bottom:1px solid #f5f0eb;text-decoration:none;color:inherit}
.hsearch-item:last-child{border-bottom:none}
.hsearch-item:hover,.hsearch-item.focused{background:#F9F5F1}
.hsearch-tier-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.hsearch-body{flex:1;min-width:0}
.hsearch-crumbs{display:flex;flex-wrap:wrap;align-items:center;gap:3px;margin-bottom:3px}
.hsearch-crumb{font-size:10px;font-weight:700;padding:1px 7px;border-radius:4px;letter-spacing:.3px;white-space:nowrap;max-width:180px;overflow:hidden;text-overflow:ellipsis}
.hsearch-crumb-id{font-family:'Courier New',monospace;font-size:9px;font-weight:700;color:#6A1B9A;opacity:.7}
.hsearch-arrow{font-size:9px;color:#bbb}
.hsearch-title{font-size:13.5px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.hsearch-title .hid-badge{font-size:10px;padding:1px 7px;vertical-align:middle}
.hsearch-meta{font-size:11px;color:var(--text-light);margin-top:2px;display:flex;gap:10px;flex-wrap:wrap}
.hsearch-children{font-size:10px;font-weight:600;padding:2px 8px;border-radius:50px}
.hsearch-empty{padding:24px;text-align:center;color:var(--text-light);font-size:13px}
.hsearch-empty i{font-size:28px;display:block;margin-bottom:8px;opacity:.3}
@media(hover:none) and (pointer:coarse){
  .cam-capture-wrap{display:block;margin-top:8px}
}
.cam-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 18px;background:linear-gradient(135deg,#1565C0,#0D47A1);color:white;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;width:100%}
.cam-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(21,101,192,.3)}
.cam-btn:active{transform:scale(.98)}
.cam-btn i{font-size:16px}
.cam-btn-gallery{background:linear-gradient(135deg,#6C5CE7,#5B4DCF)}
.cam-btn-gallery:hover{box-shadow:0 4px 16px rgba(108,92,231,.3)}
.cam-preview{margin-top:10px;position:relative;display:none}
.cam-preview.active{display:block}
.cam-preview img{width:100%;max-height:200px;object-fit:cover;border-radius:12px;border:2px solid var(--border)}
.cam-preview .cam-remove{position:absolute;top:6px;right:6px;width:28px;height:28px;background:rgba(0,0,0,.7);color:white;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.cam-desc{margin-top:8px}
.cam-desc input{width:100%;padding:8px 12px;border:2px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:12px;outline:none;transition:border .2s}
.cam-desc input:focus{border-color:var(--primary)}
.cam-info-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;color:var(--text-light);margin-top:4px}
.cam-info-badge i{font-size:11px}
.cam-size-info{font-size:10px;color:var(--success);margin-top:4px}
.loc-info-popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);z-index:10000;display:none;align-items:center;justify-content:center;padding:20px}
.loc-info-popup-overlay.active{display:flex}
.loc-info-popup{background:white;border-radius:18px;max-width:540px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:locInfoSlide .3s ease}
@keyframes locInfoSlide{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:none}}
.loc-info-popup-head{padding:20px 24px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.loc-info-popup-head h3{font-size:18px;font-weight:700;display:flex;align-items:center;gap:10px;margin:0}
.loc-info-popup-close{width:30px;height:30px;border-radius:50%;border:none;background:var(--bg);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.loc-info-popup-close:hover{background:var(--danger);color:white}
.loc-info-popup-body{padding:20px 24px 24px}
.loc-info-popup-body h4{font-size:14px;font-weight:700;margin:14px 0 6px;color:var(--text);display:flex;align-items:center;gap:6px}
.loc-info-popup-body h4:first-child{margin-top:0}
.loc-info-popup-body p{font-size:13px;color:var(--text-mid);line-height:1.7;margin-bottom:8px}
.loc-info-popup-body .info-step{display:flex;gap:10px;padding:8px 12px;background:var(--bg);border-radius:10px;margin-bottom:6px;font-size:12px;align-items:flex-start}
.loc-info-popup-body .info-step .step-num{width:22px;height:22px;background:var(--primary);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.loc-info-popup-body .info-step .step-text{color:var(--text-mid);line-height:1.5}
</style>
{% block extra_css %}{% endblock %}
</head>
<body>

<!-- Sidebar -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="document.getElementById('sidebar').classList.remove('open');this.classList.remove('active')"></div>
<aside class="sidebar" id="sidebar">
<div class="sidebar-brand">
<a href="{{ url_for('admin_dashboard') }}"><span>ü™∑</span> Holy Dham CMS</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Main</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_dashboard' }}" href="{{ url_for('admin_dashboard') }}">
<i class="fas fa-th-large"></i> Dashboard
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_places','admin_place_new','admin_place_edit') }}" href="{{ url_for('admin_places') }}">
<i class="fas fa-map-marked-alt"></i> Holy Dhams
</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Content</div>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_modules','admin_module_new','admin_module_edit') }}" href="{{ url_for('admin_modules') }}">
<i class="fas fa-cubes"></i> Module Builder
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_entries','admin_entry_new','admin_entry_edit') }}" href="{{ url_for('admin_entries') }}">
<i class="fas fa-file-alt"></i> Module Entries
</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_tags' }}" href="{{ url_for('admin_tags') }}">
<i class="fas fa-tags"></i> Tags & Categories
</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Media</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_media' }}" href="{{ url_for('admin_media') }}">
<i class="fas fa-photo-video"></i> Media Library
</a>
</div>

{% if current_user and current_user.role == 'super_admin' %}
<div class="sidebar-section">
<div class="sidebar-section-title">System</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_fields' }}" href="{{ url_for('admin_fields') }}">
<i class="fas fa-cogs"></i> Custom Fields
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_users','admin_user_new','admin_user_edit') }}" href="{{ url_for('admin_users') }}">
<i class="fas fa-users-cog"></i> Users & Roles
</a>
</div>
{% endif %}

<div class="sidebar-section">
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_pages' }}" href="{{ url_for('admin_pages') }}">
<i class="fas fa-file-alt"></i> Site Pages
</a>
<a class="sidebar-link" href="{{ url_for('home') }}" target="_blank">
<i class="fas fa-external-link-alt"></i> View Website
</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_reports' }}" href="{{ url_for('admin_reports') }}">
<i class="fas fa-flag"></i> Reports</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_email_settings' }}" href="{{ url_for('admin_email_settings') }}">
<i class="fas fa-envelope-open-text"></i> Email Settings</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_help' }}" href="{{ url_for('admin_help') }}">
<i class="fas fa-question-circle"></i> Help Guide
</a>
</div>

<div class="sidebar-footer">
<div class="sidebar-user">
<div class="sidebar-avatar">{{ current_user.display_name[0] if current_user else '?' }}</div>
<div class="sidebar-user-info">
<strong>{{ current_user.display_name if current_user else 'Guest' }}</strong>
<span>{{ current_user.role|replace('_',' ')|title if current_user else '' }}</span>
</div>
</div>
<a href="{{ url_for('admin_logout') }}" class="btn btn-secondary btn-sm" style="width:100%;justify-content:center">
<i class="fas fa-sign-out-alt"></i> Logout
</a>
</div>
</aside>

<!-- Main -->
<div class="main">
<div class="topbar">
<div style="display:flex;align-items:center;gap:12px">
<button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('active')">‚ò∞</button>
<h1>{% block page_title %}Dashboard{% endblock %}</h1>
</div>
<div class="topbar-actions">
{% block topbar_actions %}{% endblock %}
</div>
</div>
<div class="content">
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for cat, msg in messages %}
<div class="flash flash-{{ cat }}">
<i class="fas {{ 'fa-check-circle' if cat=='success' else 'fa-exclamation-circle' if cat=='error' else 'fa-info-circle' }}"></i>
{{ msg }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
{% block admin_content %}{% endblock %}
</div>
</div>

<!-- Location Picker Info Popup -->
<div class="loc-info-popup-overlay" id="locInfoPopup" onclick="if(event.target===this)this.classList.remove('active')">
<div class="loc-info-popup">
<div class="loc-info-popup-head">
<h3>üìç Location Picker Guide</h3>
<button class="loc-info-popup-close" onclick="document.getElementById('locInfoPopup').classList.remove('active')">‚úï</button>
</div>
<div class="loc-info-popup-body">
<p>The Location Picker helps you capture accurate latitude and longitude for any tier. Pilgrims use this data to navigate to exact spots on maps.</p>

<h4>üîç Option 1: Search for a Place</h4>
<div class="info-step"><span class="step-num">1</span><span class="step-text">Type the place name in the search bar (e.g. "Banke Bihari Temple Vrindavan")</span></div>
<div class="info-step"><span class="step-num">2</span><span class="step-text">Click <strong>Search</strong> or press Enter</span></div>
<div class="info-step"><span class="step-num">3</span><span class="step-text">If multiple results appear, click the correct one</span></div>
<div class="info-step"><span class="step-num">4</span><span class="step-text">Pin drops on the map and coordinates auto-fill</span></div>

<h4>üì° Option 2: Use GPS (On-Site)</h4>
<div class="info-step"><span class="step-num">1</span><span class="step-text">Visit the actual physical location with your phone</span></div>
<div class="info-step"><span class="step-num">2</span><span class="step-text">Click the green <strong>"üì° Use My Current Location"</strong> button</span></div>
<div class="info-step"><span class="step-num">3</span><span class="step-text">Allow location permission when browser asks</span></div>
<div class="info-step"><span class="step-num">4</span><span class="step-text">GPS coordinates are captured with accuracy display (e.g. ¬±5m)</span></div>

<h4>üó∫Ô∏è Option 3: Click on Map</h4>
<div class="info-step"><span class="step-num">1</span><span class="step-text">Zoom and pan the map to find the location</span></div>
<div class="info-step"><span class="step-num">2</span><span class="step-text">Click anywhere to drop a pin</span></div>
<div class="info-step"><span class="step-num">3</span><span class="step-text">Drag the pin to fine-tune the position</span></div>

<h4>üí° Tips</h4>
<p>‚Ä¢ The <strong>üóëÔ∏è Clear</strong> button removes the pin and clears coordinates<br>
‚Ä¢ Raw lat/lng fields below the map allow manual editing<br>
‚Ä¢ Status messages show in colored bars (blue=info, green=success, red=error)<br>
‚Ä¢ For best GPS accuracy, use your phone outdoors with a clear sky<br>
‚Ä¢ You can update the location anytime by re-editing the entry</p>

<h4>üìä Tier Usage</h4>
<p>‚Ä¢ <strong style="color:#C76B8F">T1 Holy Dham</strong> ‚Äî Center point of the entire sacred region<br>
‚Ä¢ <strong style="color:#2E86AB">T2 Key Places</strong> ‚Äî Center of each major area within the dham<br>
‚Ä¢ <strong style="color:#E74845">T3 Key Spots</strong> ‚Äî Exact location of each temple/ghat/site<br>
‚Ä¢ <strong style="color:#9C27B0">T4 Key Points</strong> ‚Äî Precise micro-location (samadhi, tree, step, etc.)</p>
</div>
</div>
</div>

<!-- Camera Capture Info Popup -->
<div class="loc-info-popup-overlay" id="camInfoPopup" onclick="if(event.target===this)this.classList.remove('active')">
<div class="loc-info-popup">
<div class="loc-info-popup-head">
<h3>üì∏ Camera Capture Guide</h3>
<button class="loc-info-popup-close" onclick="document.getElementById('camInfoPopup').classList.remove('active')">‚úï</button>
</div>
<div class="loc-info-popup-body">
<p>On <strong>mobile phones and tablets</strong>, you can directly capture photos using your device camera and upload them as featured images or gallery images for any tier.</p>

<h4>üì± How to Capture</h4>
<div class="info-step"><span class="step-num">1</span><span class="step-text">Look for the blue <strong>"üì∏ Capture Photo"</strong> button (visible only on mobile/tablet)</span></div>
<div class="info-step"><span class="step-num">2</span><span class="step-text">Tap it ‚Äî your device camera opens directly</span></div>
<div class="info-step"><span class="step-num">3</span><span class="step-text">Take the photo and confirm</span></div>
<div class="info-step"><span class="step-num">4</span><span class="step-text">A preview appears ‚Äî add a description if needed</span></div>
<div class="info-step"><span class="step-num">5</span><span class="step-text">Save the form to upload</span></div>

<h4>üóúÔ∏è Automatic Compression</h4>
<p>All uploaded images are <strong>automatically compressed</strong> on the server:</p>
<p>‚Ä¢ Large images are resized to max 1920px (longest side)<br>
‚Ä¢ JPEG quality optimized to 82% (excellent quality, smaller file)<br>
‚Ä¢ Mobile photo orientation is auto-corrected (EXIF rotation)<br>
‚Ä¢ PNG and WebP images are also optimized</p>

<h4>üìù Photo Description</h4>
<p>Each captured photo has a <strong>description field</strong> where you can add a caption (e.g. "Main entrance view" or "Deity darshan angle"). This helps organize and identify photos later.</p>

<h4>üí° Tips for Best Photos</h4>
<p>‚Ä¢ Hold your phone steady ‚Äî avoid blurry photos<br>
‚Ä¢ Use landscape orientation for featured images<br>
‚Ä¢ Capture from multiple angles for gallery images<br>
‚Ä¢ Natural lighting gives the best results<br>
‚Ä¢ The camera button only appears on touch devices (phones/tablets)</p>
</div>
</div>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// Initialize all Quill editors
document.querySelectorAll('.rich-editor').forEach(el => {
    const hidden = document.getElementById(el.dataset.target);
    const quill = new Quill(el, {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'link', 'image'],
                ['clean']
            ]
        }
    });
    if (hidden.value) quill.root.innerHTML = hidden.value;
    quill.on('text-change', () => { hidden.value = quill.root.innerHTML; });
    // Update before form submit
    el.closest('form')?.addEventListener('submit', () => { hidden.value = quill.root.innerHTML; });
});

// Beautiful custom select dropdowns
function initCustomSelects() {
    document.querySelectorAll('select.form-control').forEach(sel => {
        if (sel.dataset.enhanced) return;
        sel.dataset.enhanced = 'true';
        const wrap = document.createElement('div');
        wrap.className = 'custom-select-wrap';
        sel.parentNode.insertBefore(wrap, sel);
        
        const trigger = document.createElement('div');
        trigger.className = 'custom-select-trigger';
        const selectedOpt = sel.options[sel.selectedIndex];
        trigger.textContent = selectedOpt ? selectedOpt.textContent : 'Select...';
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'custom-select-options';
        
        Array.from(sel.options).forEach((opt, i) => {
            const optEl = document.createElement('div');
            optEl.className = 'custom-select-option' + (i === sel.selectedIndex ? ' selected' : '');
            optEl.textContent = opt.textContent;
            optEl.dataset.value = opt.value;
            optEl.addEventListener('click', () => {
                sel.value = opt.value;
                sel.dispatchEvent(new Event('change'));
                trigger.textContent = opt.textContent;
                optionsDiv.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                optEl.classList.add('selected');
                trigger.classList.remove('open');
                optionsDiv.classList.remove('open');
            });
            optionsDiv.appendChild(optEl);
        });
        
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-select-trigger.open').forEach(t => { if(t!==trigger){t.classList.remove('open');t.nextElementSibling.classList.remove('open')} });
            trigger.classList.toggle('open');
            optionsDiv.classList.toggle('open');
        });
        
        wrap.appendChild(trigger);
        wrap.appendChild(optionsDiv);
        sel.style.display = 'none';
        wrap.appendChild(sel);
    });
}
initCustomSelects();
document.addEventListener('click', () => {
    document.querySelectorAll('.custom-select-trigger.open').forEach(t => { t.classList.remove('open'); t.nextElementSibling.classList.remove('open'); });
});
</script>

<!-- Lightbox for image preview -->
<div class="lightbox-overlay" id="adminLightbox" onclick="this.classList.remove('active')">
<span class="lightbox-close" onclick="this.parentElement.classList.remove('active')">‚úï</span>
<img id="lightboxImg" src="" alt="Preview">
</div>

<!-- Double Confirm Modal -->
<div class="dbl-confirm" id="dblConfirm">
<div class="dbl-confirm-box">
<h3 id="dcTitle">‚ö†Ô∏è Are you sure?</h3>
<p id="dcMsg">This action cannot be undone.</p>
<div class="warn" id="dcWarn" style="display:none"></div>
<div class="dbl-confirm-btns">
<button class="btn btn-secondary" onclick="closeDblConfirm()">Cancel</button>
<button class="btn btn-danger" id="dcOk" onclick="dblConfirmStep2()">Yes, Delete</button>
</div>
</div>
</div>

<script>
/* === Lightbox === */
function openLightbox(src){
    document.getElementById('lightboxImg').src=src;
    document.getElementById('adminLightbox').classList.add('active');
}

/* === Double Confirmation Delete === */
let dcCallback=null, dcStep=1;
function dblConfirmDelete(msg, callback){
    dcStep=1; dcCallback=callback;
    document.getElementById('dcTitle').textContent='‚ö†Ô∏è Are you sure?';
    document.getElementById('dcMsg').textContent=msg||'This item will be permanently deleted.';
    document.getElementById('dcWarn').style.display='none';
    document.getElementById('dcOk').textContent='Yes, Delete';
    document.getElementById('dblConfirm').classList.add('active');
}
function dblConfirmStep2(){
    if(dcStep===1){
        dcStep=2;
        document.getElementById('dcTitle').textContent='‚ö†Ô∏è Final Confirmation';
        document.getElementById('dcMsg').textContent='This is irreversible. Are you absolutely sure?';
        document.getElementById('dcWarn').textContent='‚õî This cannot be undone!';
        document.getElementById('dcWarn').style.display='block';
        document.getElementById('dcOk').textContent='DELETE PERMANENTLY';
        document.getElementById('dcOk').style.background='#B71C1C';
        return;
    }
    var cb = dcCallback;
    closeDblConfirm();
    if(cb) cb();
}
function closeDblConfirm(){
    document.getElementById('dblConfirm').classList.remove('active');
    document.getElementById('dcOk').style.background='';
    dcCallback=null; dcStep=1;
}

/* === Gallery image delete (AJAX) === */
function deleteGalleryImage(tier, parentId, imagePath, thumbEl){
    dblConfirmDelete('Delete this image from the gallery?', function(){
        fetch('/admin/api/delete-gallery-image', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({tier:tier, parent_id:parentId, image:imagePath})
        }).then(function(r){ return r.json(); }).then(function(data){
            if(data.ok){
                var thumb = thumbEl.closest('.gal-thumb');
                if(thumb){
                    thumb.style.transition='all .3s';
                    thumb.style.opacity='0';
                    thumb.style.transform='scale(0.5)';
                }
                setTimeout(function(){
                    if(thumb) thumb.remove();
                    var section = thumbEl.closest('.gal-section') || thumbEl.closest('.form-group');
                    if(section){
                        var remaining = section.querySelectorAll('.gal-thumb').length;
                        var countEl = section.querySelector('.gal-count');
                        if(countEl){
                            if(remaining > 0) countEl.textContent = remaining + ' image' + (remaining!==1?'s':'') + ' already uploaded';
                            else countEl.remove();
                        }
                        var hidden = section.querySelector('input[type=hidden][name*=gallery]');
                        if(hidden){
                            var imgs = hidden.value.split(',').filter(function(x){return x.trim()!==imagePath && x.trim()!=='';});
                            hidden.value = imgs.join(',');
                        }
                    }
                    document.querySelectorAll('input[type=hidden]').forEach(function(inp){
                        if(inp.value.trim() === imagePath.trim()){
                            inp.value = '';
                        }
                    });
                    showDeleteToast();
                }, 350);
            } else { alert(data.error||'Delete failed'); }
        }).catch(function(e){ alert('Network error: '+e); });
    });
}

/* === Custom field image delete (client-side, saved on form submit) === */
function cfDeleteImage(thumbEl, hiddenName, imagePath){
    dblConfirmDelete('Delete this image? Change is saved when you submit the form.', function(){
        var thumb = thumbEl.closest('.gal-thumb');
        if(thumb){
            thumb.style.transition='all .3s';
            thumb.style.opacity='0';
            thumb.style.transform='scale(0.5)';
        }
        setTimeout(function(){
            if(thumb) thumb.remove();
            /* Update the hidden input: remove this image from comma list */
            var hidden = document.querySelector('input[type=hidden][name="'+hiddenName+'"]');
            if(hidden){
                var imgs = hidden.value.split(',').filter(function(x){ return x.trim()!==imagePath && x.trim()!==''; });
                hidden.value = imgs.join(',');
                if(!hidden.value) hidden.value = '';
            }
            /* Update count badge */
            var section = thumbEl.closest('.gal-section') || thumbEl.closest('.form-group');
            if(section){
                var remaining = section.querySelectorAll('.gal-thumb').length;
                var countEl = section.querySelector('.gal-count');
                if(countEl){
                    if(remaining > 0) countEl.textContent = remaining + ' image' + (remaining!==1?'s':'') + ' already uploaded';
                    else countEl.remove();
                }
            }
            showDeleteToast();
        }, 350);
    });
}

function showDeleteToast(){
    var toast = document.createElement('div');
    toast.className = 'delete-toast';
    toast.textContent = '‚úÖ Image deleted successfully';
    document.body.appendChild(toast);
    setTimeout(function(){ toast.classList.add('show'); }, 10);
    setTimeout(function(){ toast.remove(); }, 3000);
}

/* Override all delete form submissions with double confirmation */
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('form[onsubmit*="confirm"]').forEach(function(form){
        form.removeAttribute('onsubmit');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const f = this;
            dblConfirmDelete('Are you sure you want to delete this item?', function(){ f.submit(); });
        });
    });
});
</script>
<script>
/* Help Accordion Toggle */
function toggleHelpAccordion(el){el.closest('.help-accordion').classList.toggle('ha-open')}

/* Gallery: Add individual image upload item */
var galNewCounters = {};
function addGalleryItem(prefix) {
    if (!galNewCounters[prefix]) galNewCounters[prefix] = 0;
    var idx = galNewCounters[prefix]++;
    var container = document.getElementById(prefix + '_new_gals');
    if (!container) return;
    var div = document.createElement('div');
    div.className = 'gal-new-item';
    div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;border:2px dashed #6C5CE740;background:#6C5CE706;border-radius:10px;margin-bottom:8px';
    div.innerHTML = '<div style="flex:1;display:grid;gap:6px">'
        + '<input type="file" class="form-control" name="' + prefix + '_new_gallery_' + idx + '" accept="image/*" style="font-size:12px">'
        + '<input type="text" class="form-control" name="' + prefix + '_new_caption_' + idx + '" placeholder="Caption (optional)" style="font-size:12px">'
        + '</div>'
        + '<button type="button" class="btn btn-sm" style="background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c30;flex-shrink:0" onclick="this.closest(\'.gal-new-item\').remove()"><i class="fas fa-times"></i></button>';
    container.appendChild(div);
}

/* Camera capture gallery item (mobile/tablet) */
function addCamGalleryItem(prefix) {
    if (!galNewCounters[prefix]) galNewCounters[prefix] = 0;
    var idx = galNewCounters[prefix]++;
    var container = document.getElementById(prefix + '_new_gals');
    if (!container) return;
    var uid = 'camgal_' + prefix + '_' + idx;
    var div = document.createElement('div');
    div.className = 'gal-new-item';
    div.style.cssText = 'padding:10px;border:2px dashed #1565C040;background:#1565C006;border-radius:10px;margin-bottom:8px';
    div.innerHTML = '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">'
        + '<span style="font-size:11px;font-weight:700;color:#1565C0;letter-spacing:1px;text-transform:uppercase"><i class="fas fa-camera"></i> üì∏ Captured Photo</span>'
        + '<button type="button" class="btn btn-sm" style="background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c30;margin-left:auto;flex-shrink:0" onclick="this.closest(\'.gal-new-item\').remove()"><i class="fas fa-times"></i></button>'
        + '</div>'
        + '<input type="file" name="' + prefix + '_new_gallery_' + idx + '" accept="image/*" capture="environment" style="display:none" id="' + uid + '_input" onchange="var p=document.getElementById(\'' + uid + '_prev\');if(this.files[0]){p.style.display=\'block\';var r=new FileReader();r.onload=function(e){p.querySelector(\'img\').src=e.target.result};r.readAsDataURL(this.files[0])}">'
        + '<button type="button" class="cam-btn" style="width:100%;margin-bottom:6px" onclick="document.getElementById(\'' + uid + '_input\').click()"><i class="fas fa-camera"></i> Take Photo</button>'
        + '<div id="' + uid + '_prev" style="display:none;margin-bottom:6px"><img style="width:100%;max-height:150px;object-fit:cover;border-radius:10px;border:2px solid #ddd"></div>'
        + '<input type="text" class="form-control" name="' + prefix + '_new_caption_' + idx + '" placeholder="üìù Photo description (optional)" style="font-size:12px">';
    container.appendChild(div);
    // Auto-trigger camera
    setTimeout(function(){ document.getElementById(uid + '_input').click(); }, 200);
}

/* Gallery: Double-confirm delete for existing images */
function galDeleteConfirm(btn, tier, parentId, imagePath, prefix) {
    if (btn.dataset.confirmed) {
        // Second click: do the delete
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch('/admin/api/delete-gallery-image', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tier: tier, parent_id: parentId, image: imagePath})
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.ok) {
                var item = btn.closest('.gal-item');
                if (item) {
                    item.style.transition = 'all .3s';
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.95)';
                    setTimeout(function() { item.remove(); }, 300);
                }
                // Update hidden gallery_existing field
                var form = btn.closest('form') || document;
                var hidden = form.querySelector('input[name="' + prefix + '_gallery_existing"]');
                if (hidden) {
                    var imgs = hidden.value.split(',').filter(function(x) { return x.trim() !== imagePath && x.trim() !== ''; });
                    hidden.value = imgs.join(',');
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                alert('Error: ' + (data.error || 'Failed'));
            }
        }).catch(function() {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i>';
        });
        return;
    }
    // First click: show confirmation
    btn.dataset.confirmed = '1';
    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    btn.style.background = '#e74c3c';
    btn.style.color = 'white';
    btn.title = 'Click again to confirm deletion';
    setTimeout(function() {
        if (btn.dataset.confirmed) {
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.style.background = '';
            btn.style.color = '';
            btn.title = '';
            delete btn.dataset.confirmed;
        }
    }, 3000);
}

/* Gallery: Populate caption fields from JSON data attributes on page load */
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.gal-captions-data').forEach(function(el) {
        try {
            var captions = JSON.parse(el.value || '{}');
            var prefix = el.dataset.prefix;
            for (var img in captions) {
                var input = document.querySelector('input[name="' + prefix + '_caption_' + img + '"]');
                if (input) input.value = captions[img];
            }
        } catch(e) {}
    });
});
</script>
{% block extra_js %}{% endblock %}
<!-- Leaflet Maps -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ‚ïê‚ïê‚ïê Location Picker Widget ‚ïê‚ïê‚ïê
var _locPickers={};
function initLocationPicker(id, latName, lngName, opts){
  opts=opts||{};
  var container=document.getElementById(id);
  if(!container||container.dataset.lpInit) return;
  container.dataset.lpInit='1';
  var latInput=container.querySelector('input[name="'+latName+'"]');
  var lngInput=container.querySelector('input[name="'+lngName+'"]');
  var mapDiv=container.querySelector('.loc-map-wrap');
  var statusEl=container.querySelector('.loc-status');
  var savedEl=container.querySelector('.loc-saved-info');
  var searchInput=container.querySelector('.loc-search-input');
  var searchResults=container.querySelector('.loc-search-results');
  var curLat=parseFloat(latInput.value)||null;
  var curLng=parseFloat(lngInput.value)||null;
  var defaultLat=opts.defaultLat||27.5;
  var defaultLng=opts.defaultLng||77.7;

  // Init map
  var map=L.map(mapDiv,{scrollWheelZoom:true}).setView([curLat||defaultLat,curLng||defaultLng],curLat?16:6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'¬© OpenStreetMap',maxZoom:19
  }).addTo(map);

  var marker=null;
  if(curLat&&curLng){
    marker=L.marker([curLat,curLng],{draggable:true}).addTo(map);
    marker.on('dragend',function(){var p=marker.getLatLng();updateCoords(p.lat,p.lng,'Pin moved')});
    updateSavedDisplay(curLat,curLng);
  }

  // Click on map to place pin
  map.on('click',function(e){
    updateCoords(e.latlng.lat,e.latlng.lng,'Pin placed on map');
  });

  function updateCoords(lat,lng,msg){
    lat=Math.round(lat*1000000)/1000000;
    lng=Math.round(lng*1000000)/1000000;
    latInput.value=lat;lngInput.value=lng;
    if(marker){marker.setLatLng([lat,lng])}
    else{marker=L.marker([lat,lng],{draggable:true}).addTo(map);marker.on('dragend',function(){var p=marker.getLatLng();updateCoords(p.lat,p.lng,'Pin moved')})}
    map.setView([lat,lng],Math.max(map.getZoom(),16));
    updateSavedDisplay(lat,lng);
    showStatus('success','‚úì '+(msg||'Location updated')+' ‚Äî '+lat+', '+lng);
  }

  function updateSavedDisplay(lat,lng,acc){
    savedEl.innerHTML='<span class="loc-coords-display">'+lat+', '+lng+'</span>'+(acc?'<span class="loc-accuracy">¬± '+Math.round(acc)+'m</span>':'');
  }

  function showStatus(type,msg){
    statusEl.className='loc-status '+type;statusEl.innerHTML=msg;statusEl.style.display='flex';
    clearTimeout(statusEl._t);statusEl._t=setTimeout(function(){statusEl.style.display='none'},5000);
  }

  // Search with Nominatim
  var searchBtn=container.querySelector('.loc-search-btn');
  function doSearch(){
    var q=searchInput.value.trim();if(!q)return;
    showStatus('info','üîç Searching...');
    searchResults.innerHTML='';searchResults.classList.remove('active');
    fetch('https://nominatim.openstreetmap.org/search?format=json&limit=5&q='+encodeURIComponent(q))
    .then(function(r){return r.json()}).then(function(data){
      statusEl.style.display='none';
      if(!data.length){showStatus('error','No results found');return}
      if(data.length===1){
        updateCoords(parseFloat(data[0].lat),parseFloat(data[0].lon),'Found: '+data[0].display_name.split(',')[0]);
        return;
      }
      searchResults.innerHTML='';
      data.forEach(function(r){
        var d=document.createElement('div');d.className='loc-search-result';
        d.textContent=r.display_name;
        d.onclick=function(){updateCoords(parseFloat(r.lat),parseFloat(r.lon),'Selected: '+r.display_name.split(',')[0]);searchResults.classList.remove('active')};
        searchResults.appendChild(d);
      });
      searchResults.classList.add('active');
    }).catch(function(){showStatus('error','Search failed ‚Äî check your connection')});
  }
  searchBtn.onclick=doSearch;
  searchInput.onkeydown=function(e){if(e.key==='Enter'){e.preventDefault();doSearch()}};
  // Close results on outside click
  document.addEventListener('click',function(e){if(!container.contains(e.target))searchResults.classList.remove('active')});

  // GPS Button
  container.querySelector('.loc-btn-gps').onclick=function(){
    var btn=this;
    if(!navigator.geolocation){showStatus('error','Geolocation not supported');return}
    btn.classList.add('loading');btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Getting location...';
    showStatus('info','üì° Requesting GPS...');
    navigator.geolocation.getCurrentPosition(function(pos){
      btn.classList.remove('loading');btn.innerHTML='üì° Use My Current Location';
      updateCoords(pos.coords.latitude,pos.coords.longitude,'GPS location captured');
      updateSavedDisplay(pos.coords.latitude,pos.coords.longitude,pos.coords.accuracy);
      showStatus('success','‚úì GPS location captured ‚Äî Accuracy: ¬±'+Math.round(pos.coords.accuracy)+'m');
    },function(err){
      btn.classList.remove('loading');btn.innerHTML='üì° Use My Current Location';
      var msgs={1:'Permission denied ‚Äî please allow location access',2:'Position unavailable',3:'Request timed out'};
      showStatus('error',msgs[err.code]||'Could not get location');
    },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
  };

  // Clear button
  var clearBtn=container.querySelector('.loc-btn-clear');
  if(clearBtn) clearBtn.onclick=function(){
    latInput.value='';lngInput.value='';
    if(marker){map.removeLayer(marker);marker=null}
    savedEl.innerHTML='<span class="loc-no-data">No location set</span>';
    showStatus('info','Location cleared');
    map.setView([defaultLat,defaultLng],6);
  };

  // Fix map rendering in collapsed sections
  setTimeout(function(){map.invalidateSize()},300);
  // Observe for visibility changes (accordion expand)
  var observer=new MutationObserver(function(){setTimeout(function(){map.invalidateSize()},200)});
  var parent=container.closest('.kp-body,.ks-body,.ss-body,.admin-card-body');
  if(parent)observer.observe(parent,{attributes:true,attributeFilter:['style','class']});

  _locPickers[id]=map;
}

// Helper to generate location picker HTML
function locationPickerHTML(id, latName, lngName, latVal, lngVal){
  latVal=latVal||''; lngVal=lngVal||'';
  var hasSaved=(latVal!==''&&lngVal!=='');
  return '<div class="loc-picker" id="'+id+'">'+
    '<div class="loc-picker-title"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> Location Picker <span class="loc-badge">Map</span></div>'+
    '<div class="loc-saved" style="margin-bottom:10px"><span style="font-size:12px;color:var(--text-light);margin-right:4px">üìç Current:</span><span class="loc-saved-info">'+(hasSaved?'<span class="loc-coords-display">'+latVal+', '+lngVal+'</span>':'<span class="loc-no-data">No location set</span>')+'</span></div>'+
    '<div class="loc-status"></div>'+
    '<div class="loc-map-container"><div class="loc-map-wrap" style="height:100%"></div></div>'+
    '<div style="position:relative"><div class="loc-search-bar"><input class="loc-search-input" placeholder="üîç Search for a place (e.g. Banke Bihari Temple)"><button class="loc-search-btn" type="button"><i class="fas fa-search"></i> Search</button></div><div class="loc-search-results"></div></div>'+
    '<div class="loc-actions-row"><button type="button" class="loc-btn loc-btn-gps">üì° Use My Current Location</button><button type="button" class="loc-btn loc-btn-clear">üóëÔ∏è Clear</button></div>'+
    '<div class="loc-coords-row"><div class="form-group"><label>üìç Latitude</label><input type="number" class="form-control" name="'+latName+'" value="'+latVal+'" step="any" placeholder="e.g. 27.5835"></div><div class="form-group"><label>üìç Longitude</label><input type="number" class="form-control" name="'+lngName+'" value="'+lngVal+'" step="any" placeholder="e.g. 77.6949"></div></div>'+
    '<div style="font-size:10px;color:var(--text-light);margin-top:6px;display:flex;align-items:center;gap:6px"><i class="fas fa-info-circle"></i> Click map to place pin ¬∑ Drag pin to adjust ¬∑ Or use GPS/Search</div>'+
  '</div>';
}
// ‚ïê‚ïê‚ïê Hierarchy ID Copy ‚ïê‚ïê‚ïê
function copyHid(el){
  var id=el.dataset.hid||el.textContent.trim().replace('üìã','').trim();
  navigator.clipboard.writeText(id).then(function(){
    el.classList.add('copied');
    var orig=el.innerHTML;
    el.innerHTML='‚úÖ Copied!';
    setTimeout(function(){el.classList.remove('copied');el.innerHTML=orig},1500);
  });
}

// ‚ïê‚ïê‚ïê Live Hierarchy Search ‚ïê‚ïê‚ïê
function initHierarchySearch(inputEl,resultsEl,clearEl){
  var timer=null,focusIdx=-1,items=[];
  function doSearch(){
    var q=inputEl.value.trim();
    clearEl.style.display=q?'flex':'none';
    if(!q){resultsEl.classList.remove('active');resultsEl.innerHTML='';return;}
    fetch('/admin/api/hierarchy-search?q='+encodeURIComponent(q))
    .then(function(r){return r.json()})
    .then(function(data){
      focusIdx=-1;
      if(!data.length){resultsEl.innerHTML='<div class="hsearch-empty"><i class="fas fa-search"></i>No results for "'+q.replace(/</g,'&lt;')+'"</div>';resultsEl.classList.add('active');return;}
      var html='';
      data.forEach(function(d,idx){
        // Build breadcrumbs
        var bc='';
        if(d.great_grandparent) bc+='<span class="hsearch-crumb" style="background:'+_hclr('T1')+'15;color:'+_hclr('T1')+'">üèõÔ∏è '+_esc(d.great_grandparent)+'</span>'+(d.great_grandparent_hid?'<span class="hsearch-crumb-id">'+d.great_grandparent_hid+'</span>':'')+'<span class="hsearch-arrow">‚Ä∫</span>';
        if(d.grandparent) bc+='<span class="hsearch-crumb" style="background:'+_hclr(d.tier=='T3'?'T1':d.tier=='T4'?'T2':'T1')+'15;color:'+_hclr(d.tier=='T3'?'T1':d.tier=='T4'?'T2':'T1')+'">'+(d.tier=='T4'?'üìç':'üèõÔ∏è')+' '+_esc(d.grandparent)+'</span>'+(d.grandparent_hid?'<span class="hsearch-crumb-id">'+d.grandparent_hid+'</span>':'')+'<span class="hsearch-arrow">‚Ä∫</span>';
        if(d.parent) bc+='<span class="hsearch-crumb" style="background:'+_hclr(_parentTier(d.tier))+'15;color:'+_hclr(_parentTier(d.tier))+'">'+(d.tier=='T2'?'üèõÔ∏è':d.tier=='T3'?'üìç':'üéØ')+' '+_esc(d.parent)+'</span>'+(d.parent_hid?'<span class="hsearch-crumb-id">'+d.parent_hid+'</span>':'')+'<span class="hsearch-arrow">‚Ä∫</span>';
        bc+='<span class="hsearch-crumb" style="background:'+d.color+'15;color:'+d.color+'">'+d.icon+' '+d.tier+'</span>';
        // Meta
        var meta='';
        if(d.location) meta+='<span>üìç '+_esc(d.location)+'</span>';
        if(d.children) meta+='<span class="hsearch-children" style="background:'+d.color+'10;color:'+d.color+'">'+d.children+'</span>';
        html+='<a class="hsearch-item" href="'+d.url+'" data-idx="'+idx+'">';
        html+='<div class="hsearch-tier-icon" style="background:'+d.color+'12">'+d.icon+'</div>';
        html+='<div class="hsearch-body">';
        html+='<div class="hsearch-crumbs">'+bc+'</div>';
        html+='<div class="hsearch-title">'+_esc(d.title)+' <span class="hid-badge" onclick="event.preventDefault();event.stopPropagation();copyHid(this)" data-hid="'+d.hid+'">'+d.hid+' <span class="hid-copy">üìã</span></span></div>';
        if(meta) html+='<div class="hsearch-meta">'+meta+'</div>';
        html+='</div></a>';
      });
      resultsEl.innerHTML=html;
      resultsEl.classList.add('active');
      items=resultsEl.querySelectorAll('.hsearch-item');
    });
  }
  inputEl.addEventListener('input',function(){clearTimeout(timer);timer=setTimeout(doSearch,180)});
  inputEl.addEventListener('focus',function(){if(inputEl.value.trim()&&resultsEl.innerHTML)resultsEl.classList.add('active')});
  inputEl.addEventListener('keydown',function(e){
    if(!items.length)return;
    if(e.key==='ArrowDown'){e.preventDefault();focusIdx=Math.min(focusIdx+1,items.length-1);_hlItem()}
    else if(e.key==='ArrowUp'){e.preventDefault();focusIdx=Math.max(focusIdx-1,0);_hlItem()}
    else if(e.key==='Enter'&&focusIdx>=0){e.preventDefault();items[focusIdx].click()}
    else if(e.key==='Escape'){resultsEl.classList.remove('active');inputEl.blur()}
  });
  clearEl.addEventListener('click',function(){inputEl.value='';clearEl.style.display='none';resultsEl.classList.remove('active');resultsEl.innerHTML='';inputEl.focus()});
  document.addEventListener('click',function(e){if(!inputEl.parentElement.contains(e.target))resultsEl.classList.remove('active')});
  function _hlItem(){items.forEach(function(it,i){it.classList.toggle('focused',i===focusIdx)});if(items[focusIdx])items[focusIdx].scrollIntoView({block:'nearest'})}
  function _esc(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}
  function _hclr(t){return{T1:'#C76B8F',T2:'#2E86AB',T3:'#E74845',T4:'#9C27B0'}[t]||'#888'}
  function _parentTier(t){return{T2:'T1',T3:'T2',T4:'T3'}[t]||'T1'}
}

// ‚ïê‚ïê‚ïê Camera Capture for Mobile/Tablet ‚ïê‚ïê‚ïê
function camCaptureHTML(inputName, mode, opts){
  opts=opts||{};
  var label=mode==='featured'?'Featured Image':'Gallery Image';
  var btnClass=mode==='featured'?'cam-btn':'cam-btn cam-btn-gallery';
  var uid='cam_'+Math.random().toString(36).substr(2,8);
  var descName=opts.descName||inputName.replace('_file','_cam_desc').replace('_capture','_desc');
  return '<div class="cam-capture-wrap" id="'+uid+'">'
    +'<div style="display:flex;gap:8px;align-items:center">'
    +'<button type="button" class="'+btnClass+'" onclick="camTrigger(\''+uid+'\')"><i class="fas fa-camera"></i> Capture '+label+'</button>'
    +'<button class="loc-info-btn" type="button" onclick="document.getElementById(\'camInfoPopup\').classList.add(\'active\')" title="How to use" style="flex-shrink:0"><i class="fas fa-info"></i></button>'
    +'</div>'
    +'<input type="file" name="'+inputName+'" accept="image/*" capture="environment" style="display:none" class="cam-file-input" onchange="camPreviewShow(\''+uid+'\',this)">'
    +'<div class="cam-preview" id="'+uid+'_prev"><img><button type="button" class="cam-remove" onclick="camClear(\''+uid+'\')">‚úï</button></div>'
    +'<div class="cam-desc"><input type="text" name="'+descName+'" placeholder="üìù Photo description (optional)"></div>'
    +'<div class="cam-info-badge"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>'
    +'</div>';
}
function camTrigger(uid){
  var el=document.querySelector('#'+uid+' .cam-file-input');
  if(el) el.click();
}
function camPreviewShow(uid,input){
  if(!input.files||!input.files[0]) return;
  var file=input.files[0];
  var prev=document.getElementById(uid+'_prev');
  var img=prev.querySelector('img');
  var reader=new FileReader();
  reader.onload=function(e){
    img.src=e.target.result;
    prev.classList.add('active');
  };
  reader.readAsDataURL(file);
}
function camClear(uid){
  var prev=document.getElementById(uid+'_prev');
  prev.classList.remove('active');
  prev.querySelector('img').src='';
  var input=document.querySelector('#'+uid+' .cam-file-input');
  if(input) input.value='';
}
</script>
</body>
</html>
