<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}Admin{% endblock %} ‚Äì Holy Dham CMS</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Quill Editor -->
<link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
--primary:#C76B8F;--primary-light:#F8E5EE;--primary-dark:#A04870;
--bg:#F5F0EB;--white:#FFFFFF;--card:#FFFFFF;
--text:#2D1F2E;--text-mid:#5A4A5B;--text-light:#8A7A8B;
--border:#E8DDD0;--success:#5B9A5B;--warning:#D49B3F;--danger:#C45050;
--sidebar-bg:#2D1F2E;--sidebar-text:rgba(255,255,255,.6);--sidebar-active:rgba(255,255,255,.1);
}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* ‚îÄ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ‚îÄ */
.sidebar{width:260px;background:var(--sidebar-bg);color:var(--sidebar-text);padding:24px 0;display:flex;flex-direction:column;position:fixed;top:0;bottom:0;left:0;z-index:100;overflow-y:auto}
.sidebar-brand{padding:0 24px 24px;border-bottom:1px solid rgba(255,255,255,.06);margin-bottom:16px}
.sidebar-brand a{color:white;text-decoration:none;font-family:'Playfair Display',serif;font-size:20px;display:flex;align-items:center;gap:10px}
.sidebar-brand span{font-size:22px}
.sidebar-section{padding:0 12px;margin-bottom:8px}
.sidebar-section-title{padding:8px 12px;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,.3);font-weight:600}
.sidebar-link{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:10px;color:var(--sidebar-text);text-decoration:none;font-size:14px;font-weight:500;transition:all .2s;margin-bottom:2px}
.sidebar-link:hover{background:var(--sidebar-active);color:white}
.sidebar-link.active{background:var(--primary);color:white}
.sidebar-link i{width:20px;text-align:center;font-size:15px}
.sidebar-link .badge{margin-left:auto;background:rgba(255,255,255,.15);color:white;font-size:11px;padding:2px 8px;border-radius:50px}

.sidebar-footer{margin-top:auto;padding:16px 24px;border-top:1px solid rgba(255,255,255,.06)}
.sidebar-user{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.sidebar-avatar{width:36px;height:36px;background:var(--primary);border-radius:10px;display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:14px}
.sidebar-user-info{font-size:13px}.sidebar-user-info strong{color:white;display:block}
.sidebar-user-info span{font-size:11px;color:rgba(255,255,255,.4)}

/* ‚îÄ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ‚îÄ */
.main{margin-left:260px;flex:1;padding:0;min-height:100vh}
.topbar{padding:16px 32px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-family:'Playfair Display',serif;font-size:22px}
.topbar-actions{display:flex;gap:8px;align-items:center}
.content{padding:32px}

/* ‚îÄ‚îÄ‚îÄ Cards ‚îÄ‚îÄ‚îÄ */
.admin-card{background:var(--card);border-radius:16px;border:1px solid var(--border);overflow:hidden}
.admin-card-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.admin-card-header h3{font-size:16px;font-weight:600}
.admin-card-body{padding:24px}

/* ‚îÄ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:white;border-radius:14px;padding:24px;border:1px solid var(--border);display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.stat-icon.rose{background:var(--primary-light);color:var(--primary)}
.stat-icon.green{background:#D4E5D4;color:#5B9A5B}
.stat-icon.amber{background:#F5ECD4;color:#D49B3F}
.stat-icon.blue{background:#D4E0F5;color:#5070C4}
.stat-num{font-size:28px;font-weight:700}
.stat-label{font-size:12px;color:var(--text-light);margin-top:2px}

/* ‚îÄ‚îÄ‚îÄ Tables ‚îÄ‚îÄ‚îÄ */
.admin-table{width:100%;border-collapse:collapse}
.admin-table th{text-align:left;padding:12px 16px;font-size:11px;letter-spacing:1px;text-transform:uppercase;color:var(--text-light);background:var(--bg);border-bottom:1px solid var(--border);font-weight:600}
.admin-table td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle}
.admin-table tr:hover td{background:rgba(200,100,143,.02)}
.admin-table .actions{display:flex;gap:6px}

/* ‚îÄ‚îÄ‚îÄ Badges ‚îÄ‚îÄ‚îÄ */
.badge{display:inline-block;padding:4px 12px;border-radius:50px;font-size:11px;font-weight:600}
.badge-published{background:#D4E5D4;color:#3A6B3A}
.badge-draft{background:#F5ECD4;color:#8B6B20}
.badge-super_admin{background:var(--primary-light);color:var(--primary)}
.badge-content_admin{background:#D4E0F5;color:#4060A4}
.badge-editor{background:#E8E5D4;color:#6B6540}

/* ‚îÄ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:10px;font-family:'DM Sans';font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;text-decoration:none}
.btn-primary{background:var(--primary);color:white}
.btn-primary:hover{background:var(--primary-dark);color:white}
.btn-secondary{background:var(--bg);color:var(--text);border:1px solid var(--border)}
.btn-secondary:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:#FDE8E8;color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:white}
.btn-sm{padding:6px 14px;font-size:12px}
.btn-icon{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px}

/* ‚îÄ‚îÄ‚îÄ Forms ‚îÄ‚îÄ‚îÄ */
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:13px;font-weight:600;color:var(--text);margin-bottom:6px}
.form-group .hint{font-size:12px;color:var(--text-light);margin-top:4px}
.form-control{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:10px;font-family:'DM Sans';font-size:14px;background:white;outline:none;transition:border-color .2s}
.form-control:focus{border-color:var(--primary)}
textarea.form-control{min-height:120px;resize:vertical}
select.form-control{appearance:auto;-webkit-appearance:auto;-moz-appearance:auto;background:white;cursor:pointer;padding:12px 16px;transition:all .3s ease;color:var(--text-dark)}
select.form-control option{padding:8px 12px;font-size:14px;background:white;color:var(--text-dark)}
select.form-control:hover{border-color:var(--primary);box-shadow:0 2px 12px rgba(199,107,143,.1)}
select.form-control:focus{border-color:var(--primary);box-shadow:0 4px 16px rgba(199,107,143,.15);outline:none}

/* Beautiful Custom Select Dropdown */
.custom-select-wrap{position:relative}
.custom-select-trigger{width:100%;padding:12px 40px 12px 16px;border:1px solid var(--border);border-radius:10px;font-family:'DM Sans';font-size:14px;background:white;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:8px;user-select:none;position:relative}
.custom-select-trigger:hover{border-color:var(--primary);box-shadow:0 2px 12px rgba(199,107,143,.08)}
.custom-select-trigger.open{border-color:var(--primary);box-shadow:0 4px 16px rgba(199,107,143,.12);border-radius:10px 10px 0 0}
.custom-select-trigger::after{content:'';position:absolute;right:16px;top:50%;transform:translateY(-50%);width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-top:5px solid var(--text-light);transition:transform .3s ease}
.custom-select-trigger.open::after{transform:translateY(-50%) rotate(180deg)}
.custom-select-options{position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--primary);border-top:none;border-radius:0 0 10px 10px;max-height:0;overflow:hidden;opacity:0;transition:max-height .35s cubic-bezier(0.23,1,0.32,1),opacity .25s ease;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.08)}
.custom-select-options.open{max-height:280px;overflow-y:auto;opacity:1}
.custom-select-option{padding:10px 16px;cursor:pointer;font-size:14px;transition:all .15s;display:flex;align-items:center;gap:8px}
.custom-select-option:hover{background:var(--primary-light);color:var(--primary)}
.custom-select-option.selected{background:var(--primary-light);color:var(--primary);font-weight:600}
.custom-select-option:last-child{border-radius:0 0 10px 10px}
.custom-select-options::-webkit-scrollbar{width:6px}
.custom-select-options::-webkit-scrollbar-track{background:transparent}
.custom-select-options::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.custom-select-options::-webkit-scrollbar-thumb:hover{background:var(--primary)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.form-check{display:flex;align-items:center;gap:8px;font-size:14px;cursor:pointer}
.form-check input[type="checkbox"]{width:18px;height:18px;accent-color:var(--primary)}
.tag-select{display:flex;flex-wrap:wrap;gap:8px}
.tag-select label{display:flex;align-items:center;gap:6px;padding:6px 14px;border-radius:50px;border:1px solid var(--border);font-size:13px;cursor:pointer;transition:all .2s}
.tag-select label:has(input:checked){background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.tag-select input{display:none}

/* ‚îÄ‚îÄ‚îÄ Quill Editor Override ‚îÄ‚îÄ‚îÄ */
.ql-container{font-family:'DM Sans',sans-serif;font-size:15px;border-radius:0 0 10px 10px;border-color:var(--border)!important;min-height:200px}
.ql-toolbar{border-radius:10px 10px 0 0;border-color:var(--border)!important;background:var(--bg)}
.ql-editor{min-height:200px}

/* ‚îÄ‚îÄ‚îÄ Flash Messages ‚îÄ‚îÄ‚îÄ */
.flash{padding:14px 20px;border-radius:12px;margin-bottom:16px;font-size:14px;display:flex;align-items:center;gap:10px}
.flash-success{background:#D4E5D4;color:#2A5A2A}
.flash-error{background:#FDE8E8;color:#8B2020}
.flash-warning{background:#F5ECD4;color:#6B5020}
.flash-info{background:#D4E0F5;color:#2A4080}

/* ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ */
.empty{text-align:center;padding:48px 20px;color:var(--text-light)}
.empty .icon{font-size:40px;margin-bottom:12px;display:block}
.empty h3{font-size:18px;color:var(--text);margin-bottom:6px}

/* ‚îÄ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ‚îÄ */
.sidebar-toggle{display:none;background:none;border:none;font-size:24px;cursor:pointer;color:var(--text)}
@media(max-width:1024px){
.sidebar{transform:translateX(-100%);transition:transform .3s}
.sidebar.open{transform:translateX(0)}
.main{margin-left:0}
.sidebar-toggle{display:block}
.content{padding:20px}
.form-row{grid-template-columns:1fr}
}
/* ‚îÄ‚îÄ‚îÄ Beautiful File Upload ‚îÄ‚îÄ‚îÄ */
input[type="file"]{font-family:inherit;font-size:13px;color:#555}
input[type="file"]::file-selector-button{background:linear-gradient(135deg,#6366f1,#4f46e5);color:white;border:none;padding:8px 18px;border-radius:50px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;margin-right:12px;transition:all .25s;box-shadow:0 2px 8px rgba(99,102,241,.2)}
input[type="file"]::file-selector-button:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(99,102,241,.35)}
/* Gallery Thumbnails */
.gal-thumbs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.gal-thumb{position:relative;width:64px;height:64px;border-radius:8px;overflow:hidden;border:2px solid var(--border);cursor:pointer;transition:all .2s}
.gal-thumb:hover{border-color:var(--primary);transform:scale(1.05)}
.gal-thumb img{width:100%;height:100%;object-fit:cover}
.gal-thumb .gal-del{position:absolute;top:-2px;right:-2px;width:22px;height:22px;background:#E53935;color:white;border:2px solid white;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0.85;transition:opacity .2s,transform .2s;z-index:2;line-height:1;font-weight:bold}
.gal-thumb:hover .gal-del{opacity:1;transform:scale(1.1)}
.gal-count{font-family:'DM Sans';font-size:11px;color:var(--text-light);font-weight:600;background:var(--bg-cream);padding:2px 10px;border-radius:50px;display:inline-flex;align-items:center;gap:4px}
.delete-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(20px);background:#2E7D32;color:white;padding:12px 28px;border-radius:50px;font-size:14px;font-weight:600;z-index:99999;opacity:0;transition:all .3s;box-shadow:0 8px 30px rgba(0,0,0,.2)}
.delete-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
/* Lightbox */
.lightbox-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;align-items:center;justify-content:center;cursor:zoom-out}
.lightbox-overlay.active{display:flex}
.lightbox-overlay img{max-width:90vw;max-height:90vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
.lightbox-close{position:absolute;top:20px;right:24px;color:white;font-size:32px;cursor:pointer;width:44px;height:44px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:rgba(255,255,255,.1);transition:all .2s}
.lightbox-close:hover{background:rgba(255,255,255,.25)}
/* Double confirm modal */
.dbl-confirm{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.5);align-items:center;justify-content:center}
.dbl-confirm.active{display:flex}
.dbl-confirm-box{background:white;border-radius:16px;padding:28px;width:400px;max-width:92vw;box-shadow:0 20px 60px rgba(0,0,0,.2);text-align:center}
.dbl-confirm-box h3{font-family:'Josefin Sans',sans-serif;margin-bottom:8px}
.dbl-confirm-box p{color:var(--text-light);font-size:14px;margin-bottom:20px;line-height:1.6}
.dbl-confirm-box .warn{color:#E53935;font-weight:600;font-size:13px;margin-bottom:16px}
.dbl-confirm-btns{display:flex;gap:10px;justify-content:center}
/* Help Guide Accordion */
.help-accordion{margin-bottom:20px;background:white;border-radius:12px;border:1px solid var(--border);border-left:4px solid var(--primary);overflow:hidden}
.help-accordion-toggle{padding:14px 18px;cursor:pointer;display:flex;align-items:center;gap:10px;user-select:none;transition:background .2s}
.help-accordion-toggle:hover{background:var(--bg-cream)}
.help-accordion-toggle h4{flex:1;font-size:14px;font-weight:700;margin:0;color:var(--text-dark)}
.help-accordion-toggle .ha-chevron{width:18px;height:18px;transition:transform .3s;color:var(--text-light);flex-shrink:0}
.help-accordion.ha-open .ha-chevron{transform:rotate(180deg)}
.help-accordion-body{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.23,1,.32,1)}
.help-accordion.ha-open .help-accordion-body{max-height:5000px}
.help-accordion-inner{padding:0 18px 18px;font-size:13px;color:var(--text-mid);line-height:1.75}
.help-accordion-inner p{margin-bottom:10px}
.help-accordion-inner h5{font-size:13px;font-weight:700;color:var(--text-dark);margin:14px 0 6px}
.help-accordion-inner ul{margin:6px 0 12px;padding-left:18px}
.help-accordion-inner li{margin-bottom:4px}
.help-accordion-inner li strong{color:var(--text-dark)}
.help-accordion-inner .ha-example{background:var(--bg-cream);border:1px solid var(--border);border-radius:8px;padding:12px;margin:8px 0;font-size:12px}
.help-accordion-inner .ha-tip{background:#E8F5E9;border:1px solid #C8E6C9;border-radius:8px;padding:10px 14px;margin:10px 0;font-size:12px;color:#2E7D32}
.help-accordion-inner .ha-warn{background:#FFF3E0;border:1px solid #FFE0B2;border-radius:8px;padding:10px 14px;margin:10px 0;font-size:12px;color:#E65100}
.help-accordion-inner .ha-tier-flow{display:flex;align-items:center;gap:0;margin:12px 0;flex-wrap:wrap}
.help-accordion-inner .ha-tier-box{padding:8px 14px;border-radius:8px;font-size:11px;font-weight:700;text-align:center;color:white}
.help-accordion-inner .ha-tier-arrow{font-size:16px;color:var(--text-light);margin:0 4px}
.help-accordion-inner table{width:100%;border-collapse:collapse;margin:8px 0;font-size:12px}
.help-accordion-inner th{background:var(--bg-cream);padding:8px 10px;text-align:left;font-weight:700;border-bottom:2px solid var(--border);font-size:11px;text-transform:uppercase;letter-spacing:.5px}
.help-accordion-inner td{padding:8px 10px;border-bottom:1px solid var(--border)}
.help-accordion-inner .code-block{background:#1e1e2e;color:#cdd6f4;padding:12px;border-radius:8px;font-family:'Courier New',monospace;font-size:11px;overflow-x:auto;margin:8px 0;line-height:1.5}
.help-accordion-inner .code-block .key{color:#89b4fa}
.help-accordion-inner .code-block .val{color:#a6e3a1}
.help-accordion-inner .code-block .str{color:#f9e2af}
</style>
{% block extra_css %}{% endblock %}
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
<div class="sidebar-brand">
<a href="{{ url_for('admin_dashboard') }}"><span>ü™∑</span> Holy Dham CMS</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Main</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_dashboard' }}" href="{{ url_for('admin_dashboard') }}">
<i class="fas fa-th-large"></i> Dashboard
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_places','admin_place_new','admin_place_edit') }}" href="{{ url_for('admin_places') }}">
<i class="fas fa-map-marked-alt"></i> Holy Dhams
</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Content</div>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_modules','admin_module_new','admin_module_edit') }}" href="{{ url_for('admin_modules') }}">
<i class="fas fa-cubes"></i> Module Builder
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_entries','admin_entry_new','admin_entry_edit') }}" href="{{ url_for('admin_entries') }}">
<i class="fas fa-file-alt"></i> Module Entries
</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_tags' }}" href="{{ url_for('admin_tags') }}">
<i class="fas fa-tags"></i> Tags & Categories
</a>
</div>

<div class="sidebar-section">
<div class="sidebar-section-title">Media</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_media' }}" href="{{ url_for('admin_media') }}">
<i class="fas fa-photo-video"></i> Media Library
</a>
</div>

{% if current_user and current_user.role == 'super_admin' %}
<div class="sidebar-section">
<div class="sidebar-section-title">System</div>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_fields' }}" href="{{ url_for('admin_fields') }}">
<i class="fas fa-cogs"></i> Custom Fields
</a>
<a class="sidebar-link {{ 'active' if request.endpoint in ('admin_users','admin_user_new','admin_user_edit') }}" href="{{ url_for('admin_users') }}">
<i class="fas fa-users-cog"></i> Users & Roles
</a>
</div>
{% endif %}

<div class="sidebar-section">
<a class="sidebar-link" href="{{ url_for('home') }}" target="_blank">
<i class="fas fa-external-link-alt"></i> View Website
</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_reports' }}" href="{{ url_for('admin_reports') }}">
<i class="fas fa-flag"></i> Reports</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_email_settings' }}" href="{{ url_for('admin_email_settings') }}">
<i class="fas fa-envelope-open-text"></i> Email Settings</a>
<a class="sidebar-link {{ 'active' if request.endpoint == 'admin_help' }}" href="{{ url_for('admin_help') }}">
<i class="fas fa-question-circle"></i> Help Guide
</a>
</div>

<div class="sidebar-footer">
<div class="sidebar-user">
<div class="sidebar-avatar">{{ current_user.display_name[0] if current_user else '?' }}</div>
<div class="sidebar-user-info">
<strong>{{ current_user.display_name if current_user else 'Guest' }}</strong>
<span>{{ current_user.role|replace('_',' ')|title if current_user else '' }}</span>
</div>
</div>
<a href="{{ url_for('admin_logout') }}" class="btn btn-secondary btn-sm" style="width:100%;justify-content:center">
<i class="fas fa-sign-out-alt"></i> Logout
</a>
</div>
</aside>

<!-- Main -->
<div class="main">
<div class="topbar">
<div style="display:flex;align-items:center;gap:12px">
<button class="sidebar-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
<h1>{% block page_title %}Dashboard{% endblock %}</h1>
</div>
<div class="topbar-actions">
{% block topbar_actions %}{% endblock %}
</div>
</div>
<div class="content">
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for cat, msg in messages %}
<div class="flash flash-{{ cat }}">
<i class="fas {{ 'fa-check-circle' if cat=='success' else 'fa-exclamation-circle' if cat=='error' else 'fa-info-circle' }}"></i>
{{ msg }}
</div>
{% endfor %}
{% endif %}
{% endwith %}
{% block admin_content %}{% endblock %}
</div>
</div>

<script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
<script>
// Initialize all Quill editors
document.querySelectorAll('.rich-editor').forEach(el => {
    const hidden = document.getElementById(el.dataset.target);
    const quill = new Quill(el, {
        theme: 'snow',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'link', 'image'],
                ['clean']
            ]
        }
    });
    if (hidden.value) quill.root.innerHTML = hidden.value;
    quill.on('text-change', () => { hidden.value = quill.root.innerHTML; });
    // Update before form submit
    el.closest('form')?.addEventListener('submit', () => { hidden.value = quill.root.innerHTML; });
});

// Beautiful custom select dropdowns
function initCustomSelects() {
    document.querySelectorAll('select.form-control').forEach(sel => {
        if (sel.dataset.enhanced) return;
        sel.dataset.enhanced = 'true';
        const wrap = document.createElement('div');
        wrap.className = 'custom-select-wrap';
        sel.parentNode.insertBefore(wrap, sel);
        
        const trigger = document.createElement('div');
        trigger.className = 'custom-select-trigger';
        const selectedOpt = sel.options[sel.selectedIndex];
        trigger.textContent = selectedOpt ? selectedOpt.textContent : 'Select...';
        
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'custom-select-options';
        
        Array.from(sel.options).forEach((opt, i) => {
            const optEl = document.createElement('div');
            optEl.className = 'custom-select-option' + (i === sel.selectedIndex ? ' selected' : '');
            optEl.textContent = opt.textContent;
            optEl.dataset.value = opt.value;
            optEl.addEventListener('click', () => {
                sel.value = opt.value;
                sel.dispatchEvent(new Event('change'));
                trigger.textContent = opt.textContent;
                optionsDiv.querySelectorAll('.custom-select-option').forEach(o => o.classList.remove('selected'));
                optEl.classList.add('selected');
                trigger.classList.remove('open');
                optionsDiv.classList.remove('open');
            });
            optionsDiv.appendChild(optEl);
        });
        
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelectorAll('.custom-select-trigger.open').forEach(t => { if(t!==trigger){t.classList.remove('open');t.nextElementSibling.classList.remove('open')} });
            trigger.classList.toggle('open');
            optionsDiv.classList.toggle('open');
        });
        
        wrap.appendChild(trigger);
        wrap.appendChild(optionsDiv);
        sel.style.display = 'none';
        wrap.appendChild(sel);
    });
}
initCustomSelects();
document.addEventListener('click', () => {
    document.querySelectorAll('.custom-select-trigger.open').forEach(t => { t.classList.remove('open'); t.nextElementSibling.classList.remove('open'); });
});
</script>

<!-- Lightbox for image preview -->
<div class="lightbox-overlay" id="adminLightbox" onclick="this.classList.remove('active')">
<span class="lightbox-close" onclick="this.parentElement.classList.remove('active')">‚úï</span>
<img id="lightboxImg" src="" alt="Preview">
</div>

<!-- Double Confirm Modal -->
<div class="dbl-confirm" id="dblConfirm">
<div class="dbl-confirm-box">
<h3 id="dcTitle">‚ö†Ô∏è Are you sure?</h3>
<p id="dcMsg">This action cannot be undone.</p>
<div class="warn" id="dcWarn" style="display:none"></div>
<div class="dbl-confirm-btns">
<button class="btn btn-secondary" onclick="closeDblConfirm()">Cancel</button>
<button class="btn btn-danger" id="dcOk" onclick="dblConfirmStep2()">Yes, Delete</button>
</div>
</div>
</div>

<script>
/* === Lightbox === */
function openLightbox(src){
    document.getElementById('lightboxImg').src=src;
    document.getElementById('adminLightbox').classList.add('active');
}

/* === Double Confirmation Delete === */
let dcCallback=null, dcStep=1;
function dblConfirmDelete(msg, callback){
    dcStep=1; dcCallback=callback;
    document.getElementById('dcTitle').textContent='‚ö†Ô∏è Are you sure?';
    document.getElementById('dcMsg').textContent=msg||'This item will be permanently deleted.';
    document.getElementById('dcWarn').style.display='none';
    document.getElementById('dcOk').textContent='Yes, Delete';
    document.getElementById('dblConfirm').classList.add('active');
}
function dblConfirmStep2(){
    if(dcStep===1){
        dcStep=2;
        document.getElementById('dcTitle').textContent='‚ö†Ô∏è Final Confirmation';
        document.getElementById('dcMsg').textContent='This is irreversible. Are you absolutely sure?';
        document.getElementById('dcWarn').textContent='‚õî This cannot be undone!';
        document.getElementById('dcWarn').style.display='block';
        document.getElementById('dcOk').textContent='DELETE PERMANENTLY';
        document.getElementById('dcOk').style.background='#B71C1C';
        return;
    }
    var cb = dcCallback;
    closeDblConfirm();
    if(cb) cb();
}
function closeDblConfirm(){
    document.getElementById('dblConfirm').classList.remove('active');
    document.getElementById('dcOk').style.background='';
    dcCallback=null; dcStep=1;
}

/* === Gallery image delete (AJAX) === */
function deleteGalleryImage(tier, parentId, imagePath, thumbEl){
    dblConfirmDelete('Delete this image from the gallery?', function(){
        fetch('/admin/api/delete-gallery-image', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({tier:tier, parent_id:parentId, image:imagePath})
        }).then(function(r){ return r.json(); }).then(function(data){
            if(data.ok){
                var thumb = thumbEl.closest('.gal-thumb');
                if(thumb){
                    thumb.style.transition='all .3s';
                    thumb.style.opacity='0';
                    thumb.style.transform='scale(0.5)';
                }
                setTimeout(function(){
                    if(thumb) thumb.remove();
                    var section = thumbEl.closest('.gal-section') || thumbEl.closest('.form-group');
                    if(section){
                        var remaining = section.querySelectorAll('.gal-thumb').length;
                        var countEl = section.querySelector('.gal-count');
                        if(countEl){
                            if(remaining > 0) countEl.textContent = remaining + ' image' + (remaining!==1?'s':'') + ' already uploaded';
                            else countEl.remove();
                        }
                        var hidden = section.querySelector('input[type=hidden][name*=gallery]');
                        if(hidden){
                            var imgs = hidden.value.split(',').filter(function(x){return x.trim()!==imagePath && x.trim()!=='';});
                            hidden.value = imgs.join(',');
                        }
                    }
                    document.querySelectorAll('input[type=hidden]').forEach(function(inp){
                        if(inp.value.trim() === imagePath.trim()){
                            inp.value = '';
                        }
                    });
                    showDeleteToast();
                }, 350);
            } else { alert(data.error||'Delete failed'); }
        }).catch(function(e){ alert('Network error: '+e); });
    });
}

/* === Custom field image delete (client-side, saved on form submit) === */
function cfDeleteImage(thumbEl, hiddenName, imagePath){
    dblConfirmDelete('Delete this image? Change is saved when you submit the form.', function(){
        var thumb = thumbEl.closest('.gal-thumb');
        if(thumb){
            thumb.style.transition='all .3s';
            thumb.style.opacity='0';
            thumb.style.transform='scale(0.5)';
        }
        setTimeout(function(){
            if(thumb) thumb.remove();
            /* Update the hidden input: remove this image from comma list */
            var hidden = document.querySelector('input[type=hidden][name="'+hiddenName+'"]');
            if(hidden){
                var imgs = hidden.value.split(',').filter(function(x){ return x.trim()!==imagePath && x.trim()!==''; });
                hidden.value = imgs.join(',');
                if(!hidden.value) hidden.value = '';
            }
            /* Update count badge */
            var section = thumbEl.closest('.gal-section') || thumbEl.closest('.form-group');
            if(section){
                var remaining = section.querySelectorAll('.gal-thumb').length;
                var countEl = section.querySelector('.gal-count');
                if(countEl){
                    if(remaining > 0) countEl.textContent = remaining + ' image' + (remaining!==1?'s':'') + ' already uploaded';
                    else countEl.remove();
                }
            }
            showDeleteToast();
        }, 350);
    });
}

function showDeleteToast(){
    var toast = document.createElement('div');
    toast.className = 'delete-toast';
    toast.textContent = '‚úÖ Image deleted successfully';
    document.body.appendChild(toast);
    setTimeout(function(){ toast.classList.add('show'); }, 10);
    setTimeout(function(){ toast.remove(); }, 3000);
}

/* Override all delete form submissions with double confirmation */
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('form[onsubmit*="confirm"]').forEach(function(form){
        form.removeAttribute('onsubmit');
        form.addEventListener('submit', function(e){
            e.preventDefault();
            const f = this;
            dblConfirmDelete('Are you sure you want to delete this item?', function(){ f.submit(); });
        });
    });
});
</script>
<script>
/* Help Accordion Toggle */
function toggleHelpAccordion(el){el.closest('.help-accordion').classList.toggle('ha-open')}

/* Gallery: Add individual image upload item */
var galNewCounters = {};
function addGalleryItem(prefix) {
    if (!galNewCounters[prefix]) galNewCounters[prefix] = 0;
    var idx = galNewCounters[prefix]++;
    var container = document.getElementById(prefix + '_new_gals');
    if (!container) return;
    var div = document.createElement('div');
    div.className = 'gal-new-item';
    div.style.cssText = 'display:flex;align-items:center;gap:10px;padding:10px;border:2px dashed #6C5CE740;background:#6C5CE706;border-radius:10px;margin-bottom:8px';
    div.innerHTML = '<div style="flex:1;display:grid;gap:6px">'
        + '<input type="file" class="form-control" name="' + prefix + '_new_gallery_' + idx + '" accept="image/*" style="font-size:12px">'
        + '<input type="text" class="form-control" name="' + prefix + '_new_caption_' + idx + '" placeholder="Caption (optional)" style="font-size:12px">'
        + '</div>'
        + '<button type="button" class="btn btn-sm" style="background:#e74c3c15;color:#e74c3c;border:1px solid #e74c3c30;flex-shrink:0" onclick="this.closest(\'.gal-new-item\').remove()"><i class="fas fa-times"></i></button>';
    container.appendChild(div);
}

/* Gallery: Double-confirm delete for existing images */
function galDeleteConfirm(btn, tier, parentId, imagePath, prefix) {
    if (btn.dataset.confirmed) {
        // Second click: do the delete
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        fetch('/admin/api/delete-gallery-image', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tier: tier, parent_id: parentId, image: imagePath})
        }).then(function(r) { return r.json(); }).then(function(data) {
            if (data.ok) {
                var item = btn.closest('.gal-item');
                if (item) {
                    item.style.transition = 'all .3s';
                    item.style.opacity = '0';
                    item.style.transform = 'scale(0.95)';
                    setTimeout(function() { item.remove(); }, 300);
                }
                // Update hidden gallery_existing field
                var form = btn.closest('form') || document;
                var hidden = form.querySelector('input[name="' + prefix + '_gallery_existing"]');
                if (hidden) {
                    var imgs = hidden.value.split(',').filter(function(x) { return x.trim() !== imagePath && x.trim() !== ''; });
                    hidden.value = imgs.join(',');
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-trash"></i>';
                alert('Error: ' + (data.error || 'Failed'));
            }
        }).catch(function() {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-trash"></i>';
        });
        return;
    }
    // First click: show confirmation
    btn.dataset.confirmed = '1';
    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    btn.style.background = '#e74c3c';
    btn.style.color = 'white';
    btn.title = 'Click again to confirm deletion';
    setTimeout(function() {
        if (btn.dataset.confirmed) {
            btn.innerHTML = '<i class="fas fa-trash"></i>';
            btn.style.background = '';
            btn.style.color = '';
            btn.title = '';
            delete btn.dataset.confirmed;
        }
    }, 3000);
}

/* Gallery: Populate caption fields from JSON data attributes on page load */
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.gal-captions-data').forEach(function(el) {
        try {
            var captions = JSON.parse(el.value || '{}');
            var prefix = el.dataset.prefix;
            for (var img in captions) {
                var input = document.querySelector('input[name="' + prefix + '_caption_' + img + '"]');
                if (input) input.value = captions[img];
            }
        } catch(e) {}
    });
});
</script>
{% block extra_js %}{% endblock %}
</body>
</html>
