{% extends "admin/base.html" %}
{% block title %}{{ 'Edit' if editing else 'New' }} Entry{% endblock %}
{% block page_title %}{{ 'Edit' if editing else 'New' }} Module Entry{% endblock %}

{% block admin_content %}
<style>
.entry-two-col{display:grid;grid-template-columns:1fr 340px;gap:20px;align-items:start}
.entry-img-section{background:var(--bg-cream);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid var(--border)}
.entry-img-section>label{font-weight:700;font-size:13px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.entry-gal-list{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.entry-gal-item{display:flex;align-items:center;gap:10px;padding:8px;background:white;border:1px solid var(--border);border-radius:8px}
.entry-gal-item img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
.entry-gal-item .eg-info{flex:1;min-width:0}
.ecam-wrap{margin-top:8px}
.ecam-btn{background:linear-gradient(135deg,#2E86AB,#1a6d8f);color:white;border:none;padding:10px 18px;border-radius:50px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .25s;box-shadow:0 2px 8px rgba(46,134,171,.2)}
.ecam-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(46,134,171,.35)}
.ecam-btn-green{background:linear-gradient(135deg,#8BAB8A,#6d8d6c);box-shadow:0 2px 8px rgba(139,171,138,.2)}
.ecam-preview{display:none;margin-top:8px;position:relative;border-radius:10px;overflow:hidden;max-width:200px}
.ecam-preview.active{display:block}
.ecam-preview img{width:100%;border-radius:10px}
.ecam-remove{position:absolute;top:6px;right:6px;width:24px;height:24px;background:rgba(0,0,0,.6);color:white;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.ecam-info{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-light);margin-top:6px;padding:4px 10px;background:var(--bg-cream);border-radius:50px;width:fit-content}
.ecam-info i{color:#2E86AB}
@media(max-width:900px){.entry-two-col{grid-template-columns:1fr}}
</style>

<form method="POST" enctype="multipart/form-data" class="admin-card">
<div class="admin-card-body">
<div class="entry-two-col">
<!-- LEFT: Main Content -->
<div>
<div class="form-row">
<div class="form-group">
<label>Module *</label>
<select name="module_id" class="form-control" required>
<option value="">Select module...</option>
{% for mod in modules %}
<option value="{{ mod.id }}" {{ 'selected' if editing and entry.module_id == mod.id }}>{{ mod.icon }} {{ mod.name }}</option>
{% endfor %}
</select>
</div>
<div class="form-group">
<label>Linked Place (optional)</label>
<select name="place_id" class="form-control">
<option value="">None</option>
{% for p in places %}
<option value="{{ p.id }}" {{ 'selected' if editing and entry.place_id == p.id }}>{{ p.title }}</option>
{% endfor %}
</select>
</div>
</div>
<div class="form-group">
<label>Title *</label>
<input name="title" class="form-control" value="{{ entry.title if editing else '' }}" required>
</div>
<div class="form-group">
<label>Content (Rich Editor)</label>
<input type="hidden" name="content" id="entry_content" value="{{ entry.content if editing else '' }}">
<div class="rich-editor" data-target="entry_content" style="background:white;min-height:250px"></div>
</div>
<div class="form-group">
<label>Custom Fields (JSON)</label>
<textarea name="custom_fields" class="form-control" rows="3">{{ entry.custom_fields if editing else '{}' }}</textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Status</label>
<select name="status" class="form-control">
<option value="draft" {{ 'selected' if editing and entry.status=='draft' }}>Draft</option>
<option value="published" {{ 'selected' if editing and entry.status=='published' }}>Published</option>
</select>
</div>
<div class="form-group">
<label>Sort Order</label>
<input name="sort_order" class="form-control" type="number" value="{{ entry.sort_order if editing else 0 }}">
</div>
</div>
</div>

<!-- RIGHT: Images & Media -->
<div>
<!-- Featured Image -->
<div class="entry-img-section">
<label>üñºÔ∏è Featured Image</label>
{% if editing and entry.featured_image %}
<input type="hidden" name="featured_image_existing" value="{{ entry.featured_image }}">
<div style="margin-bottom:8px;position:relative;display:inline-block;width:100%">
<img src="/static/uploads/{{ entry.featured_image }}" style="width:100%;max-height:160px;object-fit:cover;border-radius:8px;cursor:pointer" onclick="openLightbox(this.src)" onerror="this.style.display='none'">
<button type="button" style="position:absolute;top:4px;right:4px;width:22px;height:22px;background:rgba(231,72,69,.9);color:white;border:none;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center" onclick="this.parentElement.remove();document.querySelector('input[name=featured_image_existing]').value=''" title="Remove">‚úï</button>
</div>
{% endif %}
<input type="file" name="featured_image_file" class="form-control" accept="image/*" style="font-size:12px">
<div class="ecam-wrap">
<div style="display:flex;gap:8px;align-items:center">
<button type="button" class="ecam-btn" onclick="this.parentElement.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture Featured Image</button>
</div>
<input type="file" name="featured_image_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.parentElement.querySelector('.ecam-preview');p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="ecam-preview"><img><button type="button" class="ecam-remove" onclick="var w=this.closest('.ecam-wrap');w.querySelector('.ecam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">‚úï</button></div>
<div class="ecam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>
</div>
</div>

<!-- Gallery Images -->
<div class="entry-img-section">
<label>üì∏ Gallery Images <span style="font-size:10px;font-weight:400;color:var(--text-light)">(shown as slider on frontend)</span>
{% if editing and entry.gallery_images %}<span style="font-size:11px;font-weight:400;color:var(--primary);margin-left:4px">{{ entry.gallery_images.split(',')|reject('equalto','')|list|length }} uploaded</span>{% endif %}
</label>
<input type="hidden" name="gallery_existing" value="{{ entry.gallery_images if editing and entry.gallery_images else '' }}">
{% if editing and entry.gallery_images %}
<div class="entry-gal-list" id="entry_gal_list">
{% for gi in entry.gallery_images.split(',') %}{% if gi.strip() %}
<div class="entry-gal-item">
<img src="/static/uploads/{{ gi.strip() }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'">
<div class="eg-info">
<div style="font-size:10px;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ gi.strip().split('/')[-1] }}</div>
</div>
<button type="button" style="background:none;border:none;color:#E74845;cursor:pointer;font-size:14px" onclick="entryGalDelete(this,'{{ gi.strip() }}')" title="Remove">‚úï</button>
</div>
{% endif %}{% endfor %}
</div>
{% endif %}
<div id="entry_new_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:11px;margin-top:4px" onclick="addEntryGalleryItem()"><i class="fas fa-plus"></i> Add More Images</button>
<div class="ecam-wrap" style="margin-top:8px">
<button type="button" class="ecam-btn ecam-btn-green" onclick="addEntryCamGalleryItem()"><i class="fas fa-camera"></i> Capture Gallery Photo</button>
<div class="ecam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>
</div>
</div>
</div>
</div>
</div>
<div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end">
<a href="{{ url_for('admin_entries') }}" class="btn btn-secondary">Cancel</a>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> {{ 'Update' if editing else 'Create' }} Entry</button>
</div>
</form>

<script>
var entryGalIdx = 0;
function addEntryGalleryItem(){
    var c = document.getElementById('entry_new_gals');
    var div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px';
    div.innerHTML = '<input type="file" name="entry_new_gallery_'+entryGalIdx+'" accept="image/*" class="form-control" style="font-size:12px;flex:1"><button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>';
    c.appendChild(div);
    entryGalIdx++;
}
function addEntryCamGalleryItem(){
    var c = document.getElementById('entry_new_gals');
    var div = document.createElement('div');
    div.style.cssText = 'margin-bottom:6px';
    div.innerHTML = '<div class="ecam-wrap"><input type="file" name="entry_new_gallery_'+entryGalIdx+'" accept="image/*" capture="environment" style="font-size:12px" onchange="var p=this.parentElement.querySelector(\'.ecam-preview\');p.classList.add(\'active\');var r=new FileReader();r.onload=function(e){p.querySelector(\'img\').src=e.target.result};r.readAsDataURL(this.files[0])"><div class="ecam-preview"><img><button type="button" class="ecam-remove" onclick="this.closest(\'.ecam-wrap\').parentElement.remove()">‚úï</button></div></div>';
    c.appendChild(div);
    entryGalIdx++;
}
function entryGalDelete(btn, img){
    if(!confirm('Remove this gallery image?')) return;
    btn.closest('.entry-gal-item').remove();
    var h = document.querySelector('input[name=gallery_existing]');
    var imgs = h.value.split(',').filter(function(x){ return x.trim() !== img.trim(); });
    h.value = imgs.join(',');
}
</script>
{% endblock %}
