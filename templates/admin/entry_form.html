{% extends "admin/base.html" %}
{% block title %}{{ 'Edit' if editing else 'New' }} {{ selected_module.name if selected_module else 'Module' }} Entry{% endblock %}
{% block page_title %}{{ selected_module.icon if selected_module else 'üìù' }} {{ 'Edit' if editing else 'New' }} {{ selected_module.name if selected_module else 'Module' }} Entry{% endblock %}

{% block admin_content %}
<style>
.entry-layout{display:grid;grid-template-columns:1fr 360px;gap:20px;align-items:start}
.entry-section{background:var(--bg-cream);border-radius:12px;padding:16px;margin-bottom:14px;border:1px solid var(--border)}
.entry-section>label,.section-title{font-weight:700;font-size:13px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.section-title{font-size:14px;color:var(--primary);border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:14px}
.dyn-fields{transition:all .3s ease}
.dyn-field{margin-bottom:12px}
.dyn-field label{font-weight:600;font-size:12px;margin-bottom:4px;display:flex;align-items:center;gap:5px;color:var(--text)}
.dyn-field label .fi{font-size:14px}
.dyn-field input,.dyn-field textarea,.dyn-field select{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;font-family:inherit;background:white;transition:border .2s}
.dyn-field input:focus,.dyn-field textarea:focus,.dyn-field select:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(199,107,143,.1)}
.dyn-field textarea{min-height:60px;resize:vertical}
.tier-cascade{display:flex;flex-direction:column;gap:14px}
.tier-step{display:flex;align-items:flex-start;gap:10px}
.tier-step-num{width:26px;height:26px;min-width:26px;background:#ccc;color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;margin-top:22px;transition:background .3s}
.tier-step-num.active{background:var(--primary)}
.tier-step-num.done{background:#27ae60}
.tier-hint{font-size:11px;color:var(--text-light);margin-top:5px;display:flex;align-items:center;gap:4px;padding:4px 0}
.tier-hint i{color:var(--primary);font-size:10px}
.tier-hint.error{color:#E74845}.tier-hint.error i{color:#E74845}
.tier-hint.success{color:#27ae60}.tier-hint.success i{color:#27ae60}
.tier-summary{display:flex;align-items:center;gap:8px;margin-top:10px;padding:10px 14px;background:#d4edda;border-radius:10px;font-size:13px;font-weight:600;color:#155724;border:1px solid #c3e6cb}
.tier-summary span{flex:1}
.tier-clear-btn{width:22px;height:22px;background:rgba(0,0,0,.1);color:#155724;border:none;border-radius:50%;cursor:pointer;font-size:12px;display:flex;align-items:center;justify-content:center;transition:background .2s}
.tier-clear-btn:hover{background:rgba(0,0,0,.2)}
select:disabled{opacity:.55;cursor:not-allowed;background:#f5f5f5}
.av-item{background:white;border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;position:relative}
.av-remove{position:absolute;top:8px;right:8px;width:22px;height:22px;background:rgba(231,72,69,.9);color:white;border:none;border-radius:50%;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center}
.av-existing-file{font-size:11px;color:var(--primary);background:var(--bg-cream);padding:4px 8px;border-radius:6px;display:inline-flex;align-items:center;gap:4px;margin-top:4px}
.entry-gal-list{display:flex;flex-direction:column;gap:6px;margin-bottom:8px}
.entry-gal-item{display:flex;align-items:center;gap:10px;padding:8px;background:white;border:1px solid var(--border);border-radius:8px}
.entry-gal-item img{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer}
.entry-gal-item .eg-info{flex:1;min-width:0}
.ecam-wrap{margin-top:8px}
.ecam-btn{background:linear-gradient(135deg,#2E86AB,#1a6d8f);color:white;border:none;padding:10px 18px;border-radius:50px;font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;transition:all .25s;box-shadow:0 2px 8px rgba(46,134,171,.2)}
.ecam-btn:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(46,134,171,.35)}
.ecam-btn-green{background:linear-gradient(135deg,#8BAB8A,#6d8d6c);box-shadow:0 2px 8px rgba(139,171,138,.2)}
.ecam-preview{display:none;margin-top:8px;position:relative;border-radius:10px;overflow:hidden;max-width:200px}
.ecam-preview.active{display:block}
.ecam-preview img{width:100%;border-radius:10px}
.ecam-remove{position:absolute;top:6px;right:6px;width:24px;height:24px;background:rgba(0,0,0,.6);color:white;border:none;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.ecam-info{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--text-light);margin-top:6px;padding:4px 10px;background:var(--bg-cream);border-radius:50px;width:fit-content}
.ecam-info i{color:#2E86AB}
.no-schema-msg{color:var(--text-light);font-size:13px;font-style:italic;padding:16px;text-align:center}
@media(max-width:900px){.entry-layout{grid-template-columns:1fr}.tier-step{flex-direction:column;gap:4px}.tier-step-num{margin-top:0}}
</style>

<form method="POST" enctype="multipart/form-data" class="admin-card" id="entryForm">
<div class="admin-card-body">
<div class="entry-layout">
<!-- LEFT: Main Content -->
<div>

<!-- Hidden module_id -->
<input type="hidden" name="module_id" value="{{ selected_module.id }}">

<!-- Title + Status -->
<div class="form-row">
<div class="form-group" style="flex:2">
<label>Title *</label>
<input name="title" class="form-control" value="{{ entry.title if editing else '' }}" required placeholder="Enter {{ selected_module.name|lower }} title">
</div>
<div class="form-group" style="flex:0 0 160px">
<label>Status</label>
<select name="status" class="form-control">
<option value="draft" {{ 'selected' if editing and entry.status=='draft' }}>üìù Draft</option>
<option value="published" {{ 'selected' if editing and entry.status=='published' }}>‚úÖ Published</option>
</select>
</div>
</div>

<!-- Tier Linking (Cascading 3-step) -->
<div class="entry-section">
<div class="section-title">üîó Link to Tier Hierarchy</div>
<div class="tier-cascade">
<!-- Step 1: Select Dham -->
<div class="tier-step">
<div class="tier-step-num active" id="stepNum1">1</div>
<div class="dyn-field" style="margin:0;flex:1">
<label>Select Dham (Tier 1)</label>
<select id="tierDhamSelect" class="form-control" onchange="onDhamSelected()">
<option value="">‚Äî Choose a Dham ‚Äî</option>
{% for p in places %}
<option value="{{ p.id }}">üõï {{ p.title }}</option>
{% endfor %}
</select>
<div class="tier-hint" id="tierStep1Hint"><i class="fas fa-info-circle"></i> Start by selecting a Dham to link this entry</div>
</div>
</div>

<!-- Step 2: Select Tier Level (disabled until step 1 done) -->
<div class="tier-step" id="tierStep2Wrap" style="opacity:0.45;pointer-events:none">
<div class="tier-step-num" id="stepNum2">2</div>
<div class="dyn-field" style="margin:0;flex:1">
<label>Link to Tier Level</label>
<select id="tierLevelSelect" class="form-control" onchange="onTierLevelSelected()">
<option value="">‚Äî Choose tier level ‚Äî</option>
<option value="dham">üõï This Dham itself (T1)</option>
<option value="key_place">üìç Key Place (T2)</option>
<option value="key_spot">‚≠ê Key Spot (T3)</option>
<option value="sub_spot">üìå Sub Spot (T4)</option>
</select>
<div class="tier-hint" id="tierStep2Hint" style="display:none"></div>
</div>
</div>

<!-- Step 3: Select Target (hidden until step 2 picks T2/T3/T4) -->
<div class="tier-step" id="tierStep3Wrap" style="display:none">
<div class="tier-step-num" id="stepNum3">3</div>
<div class="dyn-field" style="margin:0;flex:1">
<label id="tierStep3Label">Select Target Location</label>
<select id="tierTargetSelect" class="form-control" onchange="onTargetSelected()">
<option value="">‚Äî Pick target ‚Äî</option>
</select>
<div class="tier-hint" id="tierStep3Hint" style="display:none"></div>
</div>
</div>
</div>

<!-- Hidden fields for form submission -->
<input type="hidden" name="tier_link_type" id="tierLinkTypeHidden" value="{{ entry.tier_link_type if editing and entry.tier_link_type else '' }}">
<input type="hidden" name="tier_link_id" id="tierLinkIdHidden" value="{{ entry.tier_link_id if editing and entry.tier_link_id else 0 }}">

<!-- Summary badge -->
<div id="tierSummary" class="tier-summary" style="display:none">
<i class="fas fa-check-circle" style="color:#27ae60"></i>
<span id="tierSummaryText"></span>
<button type="button" class="tier-clear-btn" onclick="clearTierLink()" title="Clear linking">‚úï</button>
</div>
</div>

<!-- Content Editor -->
<div class="form-group">
<label>Content (Rich Editor)</label>
<input type="hidden" name="content" id="content_hidden" value="{{ entry.content if editing else '' }}">
<div class="rich-editor" data-target="content_hidden" style="min-height:250px;background:white">{{ entry.content|safe if editing else '' }}</div>
</div>

<!-- Dynamic Module Fields -->
<div class="entry-section" id="dynamicFieldsSection">
<div class="section-title" id="dynFieldsTitle">üìã Module Fields</div>
<div id="dynamicFields"><div class="no-schema-msg">Loading fields...</div></div>
</div>

<!-- Audio/Video -->
<div class="entry-section">
<div class="section-title">üéµ Audio / Video</div>
<div id="avContainer">
{% for av in audio_video_items %}
<div class="av-item">
<button type="button" class="av-remove" onclick="this.closest('.av-item').remove()" title="Remove">‚úï</button>
<div style="display:grid;gap:8px">
<div class="form-row" style="gap:8px">
<div class="dyn-field" style="margin:0"><label>Type</label><select name="av_type_{{ loop.index0 }}" class="form-control"><option value="audio" {{ 'selected' if av.media_type=='audio' }}>üéµ Audio</option><option value="video" {{ 'selected' if av.media_type=='video' }}>üé¨ Video</option></select></div>
<div class="dyn-field" style="margin:0"><label>Source</label><select name="av_source_{{ loop.index0 }}" class="form-control" onchange="toggleAvSource(this,{{ loop.index0 }})"><option value="upload" {{ 'selected' if av.source_type=='upload' }}>üì§ Upload</option><option value="link" {{ 'selected' if av.source_type=='link' }}>üîó Link</option></select></div>
</div>
<div class="dyn-field" style="margin:0;{{ 'display:none' if av.source_type=='link' }}" id="av_upload_{{ loop.index0 }}">
<label>File</label><input type="file" name="av_file_{{ loop.index0 }}" class="form-control" accept="audio/*,video/*" style="font-size:12px">
{% if av.source_type=='upload' and av.file_path %}<div class="av-existing-file"><i class="fas fa-file-audio"></i> {{ av.file_path.split('/')[-1] }}</div><input type="hidden" name="av_existing_{{ loop.index0 }}" value="{{ av.file_path }}">{% endif %}
</div>
<div class="dyn-field" style="margin:0;{{ 'display:none' if av.source_type=='upload' }}" id="av_link_{{ loop.index0 }}"><label>URL</label><input name="av_url_{{ loop.index0 }}" class="form-control" value="{{ av.external_url or '' }}" placeholder="https://youtube.com/..."></div>
<div class="dyn-field" style="margin:0"><label>Description *</label><textarea name="av_desc_{{ loop.index0 }}" class="form-control" rows="2" placeholder="Describe this content">{{ av.description or '' }}</textarea></div>
</div>
</div>
{% endfor %}
</div>
<button type="button" class="btn btn-sm btn-secondary" onclick="addAvItem()"><i class="fas fa-plus"></i> Add Audio/Video</button>
</div>
</div>

<!-- RIGHT: Media Panel -->
<div>
<!-- Featured Image -->
<div class="entry-section">
<div class="section-title">üñºÔ∏è Featured Image</div>
{% if editing and entry.featured_image %}
<div style="margin-bottom:8px;position:relative">
<img src="/static/uploads/{{ entry.featured_image }}" style="width:100%;border-radius:8px;max-height:200px;object-fit:cover" onerror="this.style.display='none'">
<input type="hidden" name="featured_image_existing" value="{{ entry.featured_image }}">
</div>
{% endif %}
<input type="file" name="featured_image_file" accept="image/*" class="form-control" style="font-size:12px">
<div style="font-size:10px;color:var(--text-light);margin-top:4px"><i class="fas fa-compress-alt"></i> Images are auto-compressed on upload (max 1920px, optimized quality)</div>
<div class="ecam-wrap" style="margin-top:6px">
<button type="button" class="ecam-btn ecam-btn-green" onclick="document.getElementById('featCamInput').click()"><i class="fas fa-camera"></i> Capture</button>
<input type="file" name="featured_image_cam" id="featCamInput" accept="image/*" capture="environment" style="display:none" onchange="var p=document.getElementById('featCamPreview');p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="ecam-preview" id="featCamPreview"><img><button type="button" class="ecam-remove" onclick="this.closest('.ecam-preview').classList.remove('active');document.getElementById('featCamInput').value=''">‚úï</button></div>
<div class="ecam-info"><i class="fas fa-compress-alt"></i> Auto-compressed</div>
</div>
</div>

<!-- Gallery Images -->
<div class="entry-section">
<div class="section-title">üñºÔ∏è Gallery Images</div>
{% if editing and entry.gallery_images %}
<input type="hidden" name="gallery_existing" value="{{ entry.gallery_images }}">
<div class="entry-gal-list">
{% for gi in entry.gallery_images.split(',') %}
{% if gi.strip() %}
<div class="entry-gal-item">
<img src="/static/uploads/{{ gi.strip() }}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 60 60%22><rect fill=%22%23eee%22 width=%2260%22 height=%2260%22/></svg>'" onclick="window.open('/static/uploads/{{ gi.strip() }}','_blank')">
<div class="eg-info"><div style="font-size:11px;color:var(--text-light);word-break:break-all">{{ gi.strip().split('/')[-1] }}</div></div>
<button type="button" style="background:none;border:none;color:#E74845;cursor:pointer;font-size:14px" onclick="entryGalDelete(this,'{{ gi.strip() }}')" title="Remove">‚úï</button>
</div>
{% endif %}{% endfor %}
</div>
{% endif %}
<div id="entry_new_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:11px;margin-top:4px" onclick="addEntryGalleryItem()"><i class="fas fa-plus"></i> Add Images</button>
<div class="ecam-wrap" style="margin-top:8px">
<button type="button" class="ecam-btn ecam-btn-green" onclick="addEntryCamGalleryItem()"><i class="fas fa-camera"></i> Capture</button>
</div>
</div>

<!-- Legacy place link (hidden) -->
<input type="hidden" name="place_id" value="{{ entry.place_id if editing and entry.place_id else '' }}">
</div>
</div>
</div>
<div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end">
<a href="{{ url_for('admin_entries') }}" class="btn btn-secondary">Cancel</a>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> {{ 'Update' if editing else 'Create' }} Entry</button>
</div>
</form>

<script>
var MODULE_SCHEMAS = {{ module_schemas|tojson }};
var CURRENT_MODULE_SLUG = {{ (selected_module.slug if selected_module else '')|tojson }};
var ENTRY_CF = {};
{% if editing and entry.custom_fields %}
try { ENTRY_CF = JSON.parse({{ entry.custom_fields|tojson }}); } catch(e) { ENTRY_CF = {}; }
{% endif %}

/* ‚ïê‚ïê‚ïê Module Fields (auto-loaded) ‚ïê‚ïê‚ïê */
function loadModuleFields() {
    var slug = CURRENT_MODULE_SLUG;
    if (!slug) return;
    var schema = MODULE_SCHEMAS[slug] || [];
    renderSchema(schema, slug);
}

function renderSchema(schema, slug) {
    var container = document.getElementById('dynamicFields');
    if (!schema || schema.length === 0) {
        container.innerHTML='<div class="no-schema-msg">No predefined fields for this module. Use the Content editor above.</div>';
        return;
    }
    var pretty = slug.replace(/-/g,' ').replace(/\b\w/g,function(l){return l.toUpperCase();});
    document.getElementById('dynFieldsTitle').innerHTML = 'üìã ' + pretty + ' Fields';
    var html = '';
    schema.forEach(function(f) {
        var val = ENTRY_CF[f.name] || '';
        var icon = f.icon || 'üìã';
        html += '<div class="dyn-field">';
        html += '<label><span class="fi">' + icon + '</span> ' + f.label + (f.required ? ' *' : '') + '</label>';
        if (f.type === 'text' || f.type === 'number' || f.type === 'url' || f.type === 'datetime') {
            var itype = f.type === 'datetime' ? 'datetime-local' : f.type;
            html += '<input type="' + itype + '" name="cf_' + f.name + '" class="form-control" value="' + escHtml(val) + '" placeholder="' + escHtml(f.placeholder||'') + '"' + (f.required?' required':'') + '>';
        } else if (f.type === 'textarea') {
            html += '<textarea name="cf_' + f.name + '" class="form-control" rows="3" placeholder="' + escHtml(f.placeholder||'') + '">' + escHtml(val) + '</textarea>';
        } else if (f.type === 'richtext') {
            html += '<input type="hidden" name="cf_' + f.name + '" id="cf_rt_' + f.name + '" value="' + escHtml(val) + '">';
            html += '<div class="rich-editor" data-target="cf_rt_' + f.name + '" style="background:white;min-height:150px"></div>';
        } else if (f.type === 'select') {
            html += '<select name="cf_' + f.name + '" class="form-control"><option value="">Select...</option>';
            (f.options||[]).forEach(function(opt) { html += '<option value="' + escHtml(opt) + '"' + (val===opt?' selected':'') + '>' + escHtml(opt) + '</option>'; });
            html += '</select>';
        } else if (f.type === 'image') {
            if (val) { html += '<input type="hidden" name="cf_' + f.name + '_existing" value="' + escHtml(val) + '"><div style="margin-bottom:6px"><img src="/static/uploads/' + escHtml(val) + '" style="max-height:80px;border-radius:6px" onerror="this.style.display=\'none\'"></div>'; }
            html += '<input type="file" name="cf_' + f.name + '_file" class="form-control" accept="image/*" style="font-size:12px">';
        }
        html += '</div>';
    });
    container.innerHTML = html;
    setTimeout(function() { if(typeof initRichEditors==='function') initRichEditors(); }, 100);
}

function escHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* ‚ïê‚ïê‚ïê Cascading Tier Linking ‚ïê‚ïê‚ïê */
var _selDhamId = 0;
var _selDhamName = '';

function setStep(num, state) {
    var el = document.getElementById('stepNum' + num);
    if (el) el.className = 'tier-step-num' + (state === 'done' ? ' done' : state === 'active' ? ' active' : '');
}

function onDhamSelected() {
    var sel = document.getElementById('tierDhamSelect');
    _selDhamId = parseInt(sel.value) || 0;
    _selDhamName = _selDhamId ? sel.options[sel.selectedIndex].text.replace(/^üõï\s*/, '').trim() : '';

    var step2 = document.getElementById('tierStep2Wrap');
    var step3 = document.getElementById('tierStep3Wrap');
    var levelSel = document.getElementById('tierLevelSelect');
    var h1 = document.getElementById('tierStep1Hint');
    var h2 = document.getElementById('tierStep2Hint');

    // Reset downstream
    levelSel.value = '';
    step3.style.display = 'none';
    updateHidden('', 0);
    hideSummary();

    if (!_selDhamId) {
        step2.style.opacity = '0.45';
        step2.style.pointerEvents = 'none';
        setStep(1, 'active'); setStep(2, ''); setStep(3, '');
        h1.innerHTML = '<i class="fas fa-info-circle"></i> Start by selecting a Dham to link this entry';
        h1.className = 'tier-hint'; h1.style.display = '';
        h2.style.display = 'none';
        return;
    }

    // Dham selected ‚Üí unlock step 2
    setStep(1, 'done'); setStep(2, 'active'); setStep(3, '');
    step2.style.opacity = '1';
    step2.style.pointerEvents = 'auto';
    h1.innerHTML = '<i class="fas fa-check"></i> <strong>' + escHtml(_selDhamName) + '</strong> selected';
    h1.className = 'tier-hint success'; h1.style.display = '';
    h2.innerHTML = '<i class="fas fa-hand-point-down"></i> Now choose which tier level to link to';
    h2.className = 'tier-hint'; h2.style.display = '';
}

function onTierLevelSelected() {
    var levelSel = document.getElementById('tierLevelSelect');
    var level = levelSel.value;
    var step3 = document.getElementById('tierStep3Wrap');
    var targetSel = document.getElementById('tierTargetSelect');
    var h2 = document.getElementById('tierStep2Hint');
    var h3 = document.getElementById('tierStep3Hint');
    var label3 = document.getElementById('tierStep3Label');

    if (!_selDhamId) {
        h2.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Please select a Dham first!';
        h2.className = 'tier-hint error'; h2.style.display = '';
        return;
    }

    if (!level) {
        step3.style.display = 'none';
        setStep(2, 'active'); setStep(3, '');
        updateHidden('', 0); hideSummary();
        return;
    }

    setStep(2, 'done');
    h2.style.display = 'none';

    if (level === 'dham') {
        step3.style.display = 'none';
        updateHidden('dham', _selDhamId);
        showSummary('üõï Linked to Dham: <strong>' + escHtml(_selDhamName) + '</strong>');
        return;
    }

    // Show step 3 and load options filtered by dham
    var tierLabels = {key_place:'Key Places (T2)', key_spot:'Key Spots (T3)', sub_spot:'Sub Spots (T4)'};
    label3.textContent = 'Select ' + (tierLabels[level] || 'Target');
    step3.style.display = '';
    setStep(3, 'active');
    targetSel.length = 0;
    populateSelect(targetSel, [{value:'', text:'‚è≥ Loading ' + (tierLabels[level]||'items') + '...'}]);
    h3.style.display = 'none';
    updateHidden('', 0);
    hideSummary();

    fetch('/api/v1/tier-options/' + level + '?dham_id=' + _selDhamId)
        .then(function(r) {
            if (!r.ok) throw new Error('Server error ' + r.status);
            return r.json();
        })
        .then(function(data) {
            if (!data || data.length === 0) {
                populateSelect(targetSel, [{value:'', text:'‚Äî No items found ‚Äî'}]);
                h3.innerHTML = '<i class="fas fa-exclamation-circle"></i> No ' + (tierLabels[level]||'items') + ' found under <strong>' + escHtml(_selDhamName) + '</strong>. Add them first in Holy Dhams section.';
                h3.className = 'tier-hint error'; h3.style.display = '';
                return;
            }
            var opts = [{value:'', text:'‚Äî Select from ' + data.length + ' ' + (tierLabels[level]||'items') + ' ‚Äî'}];
            data.forEach(function(item) {
                var lbl = item.parent ? item.title + ' (' + item.parent + ')' : item.title;
                opts.push({value: String(item.id), text: lbl});
            });
            populateSelect(targetSel, opts);
            h3.innerHTML = '<i class="fas fa-list"></i> ' + data.length + ' ' + (tierLabels[level]||'items') + ' found under <strong>' + escHtml(_selDhamName) + '</strong>';
            h3.className = 'tier-hint success'; h3.style.display = '';
        })
        .catch(function(err) {
            populateSelect(targetSel, [{value:'', text:'‚Äî Error loading ‚Äî'}]);
            h3.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to load. ' + (err.message||'');
            h3.className = 'tier-hint error'; h3.style.display = '';
        });
}

function onTargetSelected() {
    var level = document.getElementById('tierLevelSelect').value;
    var targetSel = document.getElementById('tierTargetSelect');
    var tid = parseInt(targetSel.value) || 0;
    if (!tid || !level) { setStep(3,'active'); updateHidden('',0); hideSummary(); return; }
    setStep(3, 'done');
    updateHidden(level, tid);
    var name = targetSel.options[targetSel.selectedIndex].text;
    var icons = {key_place:'üìç', key_spot:'‚≠ê', sub_spot:'üìå'};
    showSummary((icons[level]||'') + ' Linked to: <strong>' + escHtml(name) + '</strong> (under ' + escHtml(_selDhamName) + ')');
}

function updateHidden(type, id) {
    document.getElementById('tierLinkTypeHidden').value = type || '';
    document.getElementById('tierLinkIdHidden').value = id || 0;
}

/* Reliable cross-browser select population */
function populateSelect(sel, options) {
    /* options = [{value:'', text:'Pick...'}, {value:'1', text:'Name'}] */
    while (sel.options.length > 0) sel.remove(0);
    for (var i = 0; i < options.length; i++) {
        var opt = document.createElement('option');
        opt.value = options[i].value;
        opt.textContent = options[i].text;
        sel.appendChild(opt);
    }
}
function showSummary(h) { document.getElementById('tierSummaryText').innerHTML = h; document.getElementById('tierSummary').style.display = ''; }
function hideSummary() { document.getElementById('tierSummary').style.display = 'none'; }
function clearTierLink() { document.getElementById('tierDhamSelect').value = ''; onDhamSelected(); }

/* Restore on edit */
function restoreTierState() {
    var savedType = document.getElementById('tierLinkTypeHidden').value;
    var savedId = parseInt(document.getElementById('tierLinkIdHidden').value) || 0;
    if (!savedType || !savedId) return;
    if (savedType === 'dham') {
        document.getElementById('tierDhamSelect').value = savedId;
        onDhamSelected();
        setTimeout(function() { document.getElementById('tierLevelSelect').value = 'dham'; onTierLevelSelected(); }, 100);
    } else {
        fetch('/api/v1/tier-options/' + savedType + '?dham_id=0')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var found = data.find(function(item) { return item.id === savedId; });
                if (found && found.dham) {
                    var ds = document.getElementById('tierDhamSelect');
                    for (var i = 0; i < ds.options.length; i++) {
                        if (ds.options[i].text.replace(/^üõï\s*/, '').trim() === found.dham) { ds.selectedIndex = i; onDhamSelected(); break; }
                    }
                }
                setTimeout(function() {
                    document.getElementById('tierLevelSelect').value = savedType;
                    onTierLevelSelected();
                    setTimeout(function() { document.getElementById('tierTargetSelect').value = savedId; onTargetSelected(); }, 800);
                }, 300);
            });
    }
}

/* ‚ïê‚ïê‚ïê Audio/Video ‚ïê‚ïê‚ïê */
var avIdx = {{ audio_video_items|length }};
function addAvItem() {
    var c = document.getElementById('avContainer'), d = document.createElement('div');
    d.className = 'av-item';
    d.innerHTML = '<button type="button" class="av-remove" onclick="this.closest(\'.av-item\').remove()" title="Remove">‚úï</button>'
        + '<div style="display:grid;gap:8px">'
        + '<div class="form-row" style="gap:8px">'
        + '<div class="dyn-field" style="margin:0"><label>Type</label><select name="av_type_'+avIdx+'" class="form-control"><option value="audio">üéµ Audio</option><option value="video">üé¨ Video</option></select></div>'
        + '<div class="dyn-field" style="margin:0"><label>Source</label><select name="av_source_'+avIdx+'" class="form-control" onchange="toggleAvSource(this,'+avIdx+')"><option value="upload">üì§ Upload</option><option value="link">üîó Link</option></select></div>'
        + '</div>'
        + '<div class="dyn-field" style="margin:0" id="av_upload_'+avIdx+'"><label>File</label><input type="file" name="av_file_'+avIdx+'" class="form-control" accept="audio/*,video/*" style="font-size:12px"></div>'
        + '<div class="dyn-field" style="margin:0;display:none" id="av_link_'+avIdx+'"><label>URL</label><input name="av_url_'+avIdx+'" class="form-control" placeholder="https://youtube.com/..."></div>'
        + '<div class="dyn-field" style="margin:0"><label>Description *</label><textarea name="av_desc_'+avIdx+'" class="form-control" rows="2" placeholder="Describe this content"></textarea></div>'
        + '</div>';
    c.appendChild(d); avIdx++;
}
function toggleAvSource(sel, idx) {
    document.getElementById('av_upload_'+idx).style.display = sel.value==='upload'?'':'none';
    document.getElementById('av_link_'+idx).style.display = sel.value==='link'?'':'none';
}

/* ‚ïê‚ïê‚ïê Gallery ‚ïê‚ïê‚ïê */
var entryGalIdx = 0;
function addEntryGalleryItem(){
    var c = document.getElementById('entry_new_gals'), d = document.createElement('div');
    d.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:6px';
    d.innerHTML = '<input type="file" name="entry_new_gallery_'+entryGalIdx+'" accept="image/*" class="form-control" style="font-size:12px;flex:1"><button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>';
    c.appendChild(d); entryGalIdx++;
}
function addEntryCamGalleryItem(){
    var c = document.getElementById('entry_new_gals'), d = document.createElement('div');
    d.style.cssText = 'margin-bottom:6px';
    d.innerHTML = '<div class="ecam-wrap"><input type="file" name="entry_new_gallery_'+entryGalIdx+'" accept="image/*" capture="environment" style="font-size:12px" onchange="var p=this.parentElement.querySelector(\'.ecam-preview\');p.classList.add(\'active\');var r=new FileReader();r.onload=function(e){p.querySelector(\'img\').src=e.target.result};r.readAsDataURL(this.files[0])"><div class="ecam-preview"><img><button type="button" class="ecam-remove" onclick="this.closest(\'.ecam-wrap\').parentElement.remove()">‚úï</button></div></div>';
    c.appendChild(d); entryGalIdx++;
}
function entryGalDelete(btn, img){
    if(!confirm('Remove this gallery image?')) return;
    btn.closest('.entry-gal-item').remove();
    var h = document.querySelector('input[name=gallery_existing]');
    var imgs = h.value.split(',').filter(function(x){ return x.trim() !== img.trim(); });
    h.value = imgs.join(',');
}

/* ‚ïê‚ïê‚ïê Init ‚ïê‚ïê‚ïê */
document.addEventListener('DOMContentLoaded', function() {
    loadModuleFields();
    {% if editing and entry.tier_link_type and entry.tier_link_id %}
    setTimeout(restoreTierState, 200);
    {% endif %}
});
</script>
{% endblock %}
