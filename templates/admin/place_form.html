{% extends "admin/base.html" %}
{% block title %}{{ 'Edit' if editing else 'New' }} Holy Dham{% endblock %}
{% block page_title %}{{ 'Edit' if editing else 'Create New' }} Holy Dham{% if editing and place.hierarchy_id %} <span class="hid-badge" onclick="copyHid(this)" data-hid="{{ place.hierarchy_id }}" style="font-size:12px;vertical-align:middle">{{ place.hierarchy_id }} <span class="hid-copy">ğŸ“‹</span></span>{% endif %}{% endblock %}
{% block topbar_actions %}
<a href="{{ url_for('admin_places') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to All Dhams</a>
{% if editing %}<a href="{{ url_for('place_detail', slug=place.slug) }}" target="_blank" class="btn btn-secondary"><i class="fas fa-eye"></i> View Live</a>{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.red-star{color:#E74C3C;font-weight:700}
.toggle-switch{position:relative;width:48px;height:26px;display:inline-block;flex-shrink:0}
.toggle-switch input{opacity:0;width:0;height:0}
.toggle-slider{position:absolute;cursor:pointer;inset:0;background:#E74C3C;border-radius:26px;transition:.3s}
.toggle-slider:before{content:'';position:absolute;height:20px;width:20px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s}
.toggle-switch input:checked + .toggle-slider{background:#27AE60}
.toggle-switch input:checked + .toggle-slider:before{transform:translateX(22px)}
.toggle-label{display:inline-flex;align-items:center;gap:8px;font-size:12px;font-weight:600;cursor:pointer;user-select:none}
.status-text.on{color:#27AE60}.status-text.off{color:#E74C3C}
.field-row{display:flex;gap:12px;align-items:start;margin-bottom:16px}
.field-row .field-main{flex:1}
.field-row .field-toggle{padding-top:28px;display:flex;align-items:center}

/* â•â•â• CLICKABLE TIER TABS â•â•â• */
.tier-tabs{background:linear-gradient(135deg,#2D1F2E,#3D2B4E);border-radius:16px;padding:22px 24px 18px;margin-bottom:24px;color:white;position:relative;overflow:hidden}
.tier-tabs::before{content:'';position:absolute;right:-40px;top:-30px;width:200px;height:200px;background:radial-gradient(circle,rgba(199,107,143,.15),transparent);pointer-events:none}
.tier-tabs-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:14px}
.tier-tab{padding:14px 16px;border-radius:12px;border:2px solid rgba(255,255,255,.06);cursor:pointer;transition:all .3s;position:relative;user-select:none}
.tier-tab:hover{border-color:rgba(255,255,255,.15);background:rgba(255,255,255,.04)}
.tier-tab.active{border-color:rgba(255,255,255,.3);background:rgba(255,255,255,.08);transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.3)}
.tier-tab .t-num{font-size:9px;letter-spacing:2px;text-transform:uppercase;opacity:.5;font-weight:700;margin-bottom:4px}
.tier-tab.active .t-num{opacity:.9}
.tier-tab .t-icon{font-size:22px;margin-bottom:4px}
.tier-tab .t-name{font-size:14px;font-weight:700}
.tier-tab .t-desc{font-size:10px;opacity:.4;margin-top:3px;line-height:1.3}
.tier-tab.active .t-desc{opacity:.7}
.tier-tab .t-count{position:absolute;top:10px;right:10px;font-size:10px;padding:2px 8px;border-radius:50px;font-weight:700;background:rgba(255,255,255,.1)}
.tier-tab.active .t-count{background:rgba(255,255,255,.2)}

/* Tier Content Sections */
.tier-content{display:none}
.tier-content.active{display:block}

/* Tier definition box */
.tier-def{border-radius:14px;padding:18px 22px;margin-bottom:20px;display:flex;gap:16px;align-items:flex-start}
.tier-def-icon{width:50px;height:50px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0}
.tier-def-body h4{font-size:15px;font-weight:700;margin-bottom:4px}
.tier-def-body .def-text{font-size:12px;line-height:1.6;opacity:.7}
.tier-def-body .def-chars{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.tier-def-body .def-char{font-size:10px;padding:3px 10px;border-radius:50px;font-weight:600}

/* Two Column Layout */
.place-two-col{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:stretch}
.place-two-col .admin-card{display:flex;flex-direction:column}
.place-two-col .admin-card-body{flex:1}

/* Key Places Accordion */
.kp-accordion{border:2px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:12px;background:#F8F4F0;transition:border-color .3s}
.kp-accordion:hover{border-color:#2E86AB40}
.kp-accordion-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;cursor:pointer;user-select:none;transition:background .2s}
.kp-accordion-header:hover{background:#F0EAE3}
.kp-accordion-header h4{font-size:15px;display:flex;align-items:center;gap:10px;margin:0}
.kp-accordion-header .kp-actions{display:flex;gap:8px;align-items:center}
.kp-accordion-body{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(0.23,1,0.32,1)}
.kp-accordion.open .kp-accordion-body{max-height:3000px}
.kp-accordion-body-inner{padding:20px;border-top:1px solid var(--border);background:white}
.kp-accordion-header .chevron{transition:transform .3s;font-size:12px;color:var(--text-light)}
.kp-accordion.open .kp-accordion-header .chevron{transform:rotate(180deg)}
.kp-num{width:28px;height:28px;background:#2E86AB;color:white;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}

.add-kp-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;border:2px dashed #2E86AB40;border-radius:14px;cursor:pointer;color:#2E86AB;font-weight:600;transition:all .2s;background:none;width:100%;font-size:14px}
.add-kp-btn:hover{border-color:#2E86AB;background:#2E86AB08}

/* Hierarchy breadcrumb mini */
.hier-bc{display:flex;align-items:center;gap:5px;font-size:11px;flex-wrap:wrap;margin-bottom:6px}
.hier-bc .bc-pill{padding:2px 8px;border-radius:50px;font-weight:700;font-size:9px;letter-spacing:.5px;display:inline-flex;align-items:center;gap:3px}
.hier-bc .bc-arrow{color:var(--text-light);font-size:8px}

/* Spot / Point overview card */
.overview-card{background:white;border-radius:12px;padding:16px 18px;margin-bottom:10px;border-left:4px solid;transition:all .2s;display:flex;align-items:center;gap:14px}
.overview-card:hover{transform:translateX(3px);box-shadow:0 4px 16px rgba(0,0,0,.06)}
.overview-card .ov-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.overview-card .ov-body{flex:1;min-width:0}
.overview-card .ov-title{font-size:14px;font-weight:700;color:var(--text)}
.overview-card .ov-cat{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.overview-card .ov-actions{display:flex;gap:6px;flex-shrink:0}

.img-preview{width:60px;height:60px;border-radius:8px;object-fit:cover;border:1px solid var(--border)}
.section-save{display:flex;justify-content:flex-end;padding:16px 0 0;border-top:1px solid var(--border);margin-top:16px}
.section-save .btn{min-width:160px}
.cf-section{background:#FAFAF5;border-radius:12px;padding:20px;margin-top:12px}

.back-btn-row{display:flex;gap:8px;margin-bottom:16px}
.back-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;color:var(--text-light);font-size:12px;font-weight:600;text-decoration:none;transition:all .2s}
.back-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}

@media(max-width:1024px){.place-two-col{grid-template-columns:1fr}.tier-tabs-grid{grid-template-columns:repeat(2,1fr)}.t1-top-bar{grid-template-columns:1fr!important}}
@media(max-width:600px){.tier-tabs-grid{grid-template-columns:1fr}
/* Custom field boxes responsive */
.field-row .form-group textarea.form-control{min-height:80px;width:100%!important}
.field-row .form-group input.form-control{width:100%!important}
.field-row .form-group .rich-editor{min-height:140px!important;width:100%!important}
.field-row{flex-direction:column;gap:8px}
.field-main{width:100%!important}
.field-toggle{padding-top:4px!important}
.ql-container{font-size:14px!important}
/* Mobile: collapse all inline grids in facc and kp bodies */
.facc-bi [style*="grid-template-columns:1fr 1fr 1fr"]{grid-template-columns:1fr!important}
.facc-bi [style*="grid-template-columns:1fr 1fr"]{grid-template-columns:1fr!important}
.kp-accordion-body-inner [style*="grid-template-columns"]{grid-template-columns:1fr!important}
.overview-card{flex-direction:column;align-items:flex-start;gap:10px}
.overview-card .ov-actions{align-self:flex-end}
.hier-bc{flex-wrap:wrap}
}
</style>
{% endblock %}

{% block admin_content %}
{% set vis = json.loads(place.field_visibility) if editing and place.field_visibility else {} %}
{% set indian_states = ['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Andaman and Nicobar Islands','Chandigarh','Dadra and Nagar Haveli','Daman and Diu','Delhi','Jammu and Kashmir','Ladakh','Lakshadweep','Puducherry'] %}

<!-- â•â•â• HIERARCHY SEARCH BAR â•â•â• -->
<div style="margin-bottom:16px">
<div class="hsearch-wrap">
<input id="editHSearch" class="hsearch-input" autocomplete="off" placeholder="ğŸ” Search all tiers by name or hierarchy ID...">
<i class="fas fa-search hsearch-icon"></i>
<button type="button" class="hsearch-clear" id="editHClear">âœ•</button>
<div class="hsearch-results" id="editHResults"></div>
</div>
</div>

<!-- â•â•â• CLICKABLE TIER TABS â•â•â• -->
<div class="tier-tabs">
<div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px">
<div>
<div style="font-size:10px;letter-spacing:2px;text-transform:uppercase;opacity:.4;font-weight:700;margin-bottom:3px">4-Tier Hierarchy Â· Click a tier to view & manage</div>
<div style="font-size:18px;font-weight:700">{{ place.title if editing else 'New Holy Dham' }}</div>
</div>
{% if editing %}<div style="font-size:11px;opacity:.35">ID #{{ place.id }} Â· {{ place.status }}</div>{% endif %}
</div>

<div class="tier-tabs-grid">
<div class="tier-tab active" onclick="switchTier(1)" data-tier="1" style="border-color:rgba(199,107,143,.4)">
<div class="t-num" style="color:#E8A0BF">Tier 1</div>
<div class="t-icon">ğŸ™</div>
<div class="t-name">Holy Dham</div>
<div class="t-desc">Divine spiritual region</div>
</div>
<div class="tier-tab" onclick="switchTier(2)" data-tier="2">
<div class="t-num" style="color:#7CC0DE">Tier 2</div>
<div class="t-icon">ğŸ“</div>
<div class="t-name">Key Places</div>
<div class="t-desc">Major zones within Dham</div>
<div class="t-count">{{ key_places|length }}</div>
</div>
<div class="tier-tab" onclick="switchTier(3)" data-tier="3">
<div class="t-num" style="color:#F09190">Tier 3</div>
<div class="t-icon">ğŸ”¸</div>
<div class="t-name">Key Spots</div>
<div class="t-desc">Pilgrimage locations</div>
<div class="t-count">{{ all_spots|length if editing else 0 }}</div>
</div>
<div class="tier-tab" onclick="switchTier(4)" data-tier="4">
<div class="t-num" style="color:#CE93D8">Tier 4</div>
<div class="t-icon">âœ¦</div>
<div class="t-name">Key Points</div>
<div class="t-desc">Micro-locations for meditation</div>
<div class="t-count">{{ all_points|length if editing else 0 }}</div>
</div>
</div>
</div>

<form method="POST" enctype="multipart/form-data" id="mainPlaceForm">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TIER 1 CONTENT: HOLY DHAM -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tier-content active" id="tier-1-content">

<!-- Tier 1 Definition -->
<div class="tier-def" style="background:#C76B8F0A;border:1.5px solid #C76B8F20">
<div class="tier-def-icon" style="background:#C76B8F15">ğŸ™</div>
<div class="tier-def-body">
<h4 style="color:#A04870"><span style="font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:2px 10px;background:#C76B8F;color:white;border-radius:50px;margin-right:8px">Tier 1</span> Holy Dham</h4>
<div class="def-text">A spiritually complete sacred region associated with the divine pastimes of the Lord and His associates. Represents the entire spiritual ecosystem.</div>
<div class="def-chars">
<span class="def-char" style="background:#C76B8F15;color:#C76B8F">Scripturally established</span>
<span class="def-char" style="background:#C76B8F15;color:#C76B8F">Multiple pastime locations</span>
<span class="def-char" style="background:#C76B8F15;color:#C76B8F">Pilgrimage destination</span>
</div>
</div>
</div>

<!-- T1 TOP BAR: Title + Status + Featured -->
<div style="display:grid;grid-template-columns:1fr 160px auto;gap:12px;background:white;border-radius:12px;padding:16px;border:1px solid var(--border);margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,.02)" class="t1-top-bar">
<div class="form-group" style="margin:0"><label>ğŸ›• Dham Title <span class="red-star">*</span></label>
<input name="title" class="form-control" value="{{ place.title if editing else '' }}" required placeholder="e.g. Vrindavan Dham, Mayapur Dham"><input type="hidden" name="vis_title" value="on"></div>
<div class="form-group" style="margin:0"><label>Status</label><select name="status" class="form-control"><option value="draft" {{ 'selected' if not editing or place.status=='draft' }}>ğŸ“ Draft</option><option value="published" {{ 'selected' if editing and place.status=='published' }}>âœ… Published</option><option value="archived" {{ 'selected' if editing and place.status=='archived' }}>ğŸ“¦ Archived</option></select></div>
<div class="form-group" style="margin:0"><label>&nbsp;</label><label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;padding-top:4px"><input type="checkbox" name="is_featured" {{ 'checked' if editing and place.is_featured }} style="accent-color:var(--warning)">â­ Featured</label></div>
</div>

<!-- ACC 1: ğŸ“‹ Core Information -->
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ“‹</span> Core Information<span class="fab">3 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="form-group"><label>ğŸ“ Short Description <span class="red-star">*</span></label>
<textarea name="short_description" class="form-control" rows="3" placeholder="Brief overview...">{{ place.short_description if editing else '' }}</textarea><input type="hidden" name="vis_short_description" value="on"></div>
<div class="form-group"><label>ğŸ“– Full Description <span class="red-star">*</span></label>
<input type="hidden" name="full_content" id="full_content" value="{{ place.full_content if editing else '' }}">
<div class="rich-editor" data-target="full_content" style="background:white;min-height:200px"></div><input type="hidden" name="vis_full_content" value="on"></div>
<div class="form-group"><label>ğŸ·ï¸ Tags</label>
<div style="display:flex;flex-wrap:wrap;gap:8px">{% for tag in tags %}
<label style="display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:50px;border:2px solid {{ tag.color }}30;background:{{ tag.color }}08;font-size:13px;cursor:pointer">
<input type="checkbox" name="tags" value="{{ tag.id }}" {{ 'checked' if tag.id in place_tags }} style="accent-color:{{ tag.color }}">
<span style="width:8px;height:8px;border-radius:50%;background:{{ tag.color }}"></span>{{ tag.name }}</label>{% endfor %}</div><input type="hidden" name="vis_tags" value="on"></div>
</div></div></div>

<!-- ACC 2: ğŸ“ Location & Geography -->
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ“</span> Location & Geography<span class="fab">5 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div class="form-group"><label>ğŸ™ï¸ City <span class="red-star">*</span></label><input name="city" class="form-control" value="{{ place.city if editing else '' }}" placeholder="e.g. Mathura"><input type="hidden" name="vis_city" value="on"></div>
<div class="form-group"><label>ğŸ—ºï¸ State <span class="red-star">*</span></label>
<select name="state" class="form-control"><option value="">Select State</option>{% for st in indian_states %}<option value="{{ st }}" {{ 'selected' if editing and place.state == st }}>{{ st }}</option>{% endfor %}</select><input type="hidden" name="vis_state" value="on"></div>
<div class="form-group"><label>ğŸŒ Country</label><input name="country" class="form-control" value="{{ place.country if editing else 'India' }}"><input type="hidden" name="vis_country" value="on"></div>
</div>
<div id="loc_t1" class="loc-picker">
<div class="loc-picker-title"><i class="fas fa-map-marker-alt" style="color:var(--primary)"></i> Location Picker <span class="loc-badge">T1 Dham</span><button class="loc-info-btn" type="button" onclick="document.getElementById('locInfoPopup').classList.add('active')" title="How to use"><i class="fas fa-info"></i></button></div>
<div class="loc-saved" style="margin-bottom:10px"><span style="font-size:12px;color:var(--text-light);margin-right:4px">ğŸ“ Current:</span><span class="loc-saved-info">{% if editing and place.latitude and place.longitude %}<span class="loc-coords-display">{{ place.latitude }}, {{ place.longitude }}</span>{% else %}<span class="loc-no-data">No location set</span>{% endif %}</span></div>
{% if editing and place.location_updated_at %}<div style="font-size:11px;color:var(--text-light);margin-bottom:10px;padding:6px 10px;background:var(--bg);border-radius:8px;border:1px dashed var(--border);display:inline-flex;align-items:center;gap:6px"><i class="fas fa-clock" style="color:var(--primary);font-size:10px"></i> Location last updated by <strong style="color:var(--text-dark)">{{ place.location_updated_by }}</strong> on <strong style="color:var(--text-dark)">{{ place.location_updated_at }}</strong></div>{% endif %}
<div class="loc-status"></div>
<div class="loc-map-container"><div class="loc-map-wrap" style="height:100%"></div></div>
<div style="position:relative"><div class="loc-search-bar"><input class="loc-search-input" placeholder="ğŸ” Search for a place (e.g. Vrindavan Dham)"><button class="loc-search-btn" type="button"><i class="fas fa-search"></i> Search</button></div><div class="loc-search-results"></div></div>
<div class="loc-actions-row"><button type="button" class="loc-btn loc-btn-gps">ğŸ“¡ Use My Current Location</button><button type="button" class="loc-btn loc-btn-clear">ğŸ—‘ï¸ Clear</button></div>
<div class="loc-coords-row">
<div class="form-group"><label>ğŸ“ Latitude</label><input name="latitude" class="form-control" type="number" step="any" value="{{ place.latitude if editing and place.latitude else '' }}"><input type="hidden" name="vis_latitude" value="on"></div>
<div class="form-group"><label>ğŸ“ Longitude</label><input name="longitude" class="form-control" type="number" step="any" value="{{ place.longitude if editing and place.longitude else '' }}"><input type="hidden" name="vis_longitude" value="on"></div>
</div>
<div style="font-size:10px;color:var(--text-light);margin-top:6px;display:flex;align-items:center;gap:6px"><i class="fas fa-info-circle"></i> Click map to place pin Â· Drag pin to adjust Â· Or use GPS/Search</div>
</div>
</div></div></div>

<!-- ACC 3: ğŸ–¼ï¸ Images & Media -->
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ–¼ï¸</span> Images & Media<span class="fab">3 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="form-group"><label>ğŸ–¼ï¸ Featured Image</label>
{% if editing and place.featured_image %}<input type="hidden" name="featured_image_existing" value="{{ place.featured_image }}">
<div class="gal-section" style="margin-bottom:10px">
<span class="gal-count">ğŸ“· 1 image uploaded</span>
<div class="gal-thumbs">
<div class="gal-thumb">
<img src="/static/uploads/{{ place.featured_image }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'">
<span class="gal-del" onclick="deleteGalleryImage('t1',{{ place.id }},'{{ place.featured_image }}',this)" title="Delete image">âœ•</span>
</div>
</div>
</div>{% endif %}
<input type="file" name="featured_image_file" class="form-control" accept="image/*"><input type="hidden" name="vis_featured_image" value="on">
<div class="cam-capture-wrap">
<div style="display:flex;gap:8px;align-items:center">
<button type="button" class="cam-btn" onclick="this.parentElement.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture Featured Image</button>
<button class="loc-info-btn" type="button" onclick="document.getElementById('camInfoPopup').classList.add('active')" title="How to use" style="flex-shrink:0"><i class="fas fa-info"></i></button>
</div>
<input type="file" name="featured_image_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.parentElement.querySelector('.cam-preview');p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.cam-capture-wrap');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('.cam-preview img').src='';w.querySelector('input[name=featured_image_cam]').value=''">âœ•</button></div>
<div class="cam-desc"><input type="text" name="featured_image_cam_desc" placeholder="ğŸ“ Photo description (optional)"></div>
<div class="cam-info-badge"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>
</div>
<input type="text" name="featured_image_desc" class="form-control" value="{{ place.featured_image_desc if editing else '' }}" placeholder="ğŸ“ Featured image description (shows as overlay on frontend)" style="font-size:12px;margin-top:6px">
</div>
<!-- T1 Gallery Images -->
<div class="form-group gal-section"><label style="display:flex;align-items:center;gap:6px;font-weight:700;margin-bottom:6px;font-size:13px"><span style="font-size:16px">ğŸ“¸</span> Gallery Images <span style="font-size:10px;font-weight:500;color:var(--text-light)">(shown as slider on frontend)</span>
{% if editing and gallery_media is defined and gallery_media %}<span class="gal-count">{{ gallery_media|length }} image{{ 's' if gallery_media|length != 1 }}</span>{% endif %}</label>
{% if editing and gallery_media is defined and gallery_media %}
<div class="gal-individual-list" id="t1_gal_list">
{% for gm in gallery_media %}
<div class="gal-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--bg-cream);border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
<div class="gal-thumb" style="flex-shrink:0"><img src="/static/uploads/{{ gm.filename }}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"></div>
<div style="flex:1;min-width:0">
<input type="text" class="form-control" name="t1_media_caption_{{ gm.id }}" placeholder="Caption for this image..." style="font-size:12px" value="{{ gm.caption or '' }}">
<div style="font-size:10px;color:var(--text-light);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ gm.filename.split('/')[-1] }}</div>
</div>
<button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="galDeleteConfirm(this,'t1',{{ place.id }},'{{ gm.filename }}','t1')"><i class="fas fa-trash"></i></button>
</div>
{% endfor %}
</div>
{% endif %}
<div id="t1_new_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="margin-top:6px;font-size:11px" onclick="addGalleryItem('t1')"><i class="fas fa-plus"></i> Add More Images</button>
<div class="cam-capture-wrap" style="margin-top:8px">
<button type="button" class="cam-btn cam-btn-gallery" onclick="addCamGalleryItem('t1')"><i class="fas fa-camera"></i> Capture Gallery Photo</button>
<div class="cam-info-badge"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>
</div>
</div>
</div></div></div>

<!-- ACC 4: ğŸ§³ Visitor Information (Custom Fields) -->
{% if custom_fields %}
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ§³</span> Visitor Information<span class="fab">custom fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="cf-sep">Custom Fields â€” Visitor Info</div>
{% for cf in custom_fields %}{% if cf.name in ('opening_hours','best_time_to_visit','dress_code','how_to_reach','accommodation') %}{% set cv = custom_values.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label>{{ cf.label }} <span style="font-size:10px;color:var(--text-light)">{{ cf.field_type }}</span></label>
{% if cf.field_type in ('text','number') %}<input name="cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}" placeholder="{{ cf.placeholder }}">
{% elif cf.field_type == 'textarea' %}<textarea name="cf_{{ cf.id }}" class="form-control" rows="3">{{ cv.get('value','') }}</textarea>
{% else %}<input name="cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}">{% endif %}
</div></div>
<div class="field-toggle" style="padding-top:28px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="cf_vis_{{ cf.id }}" {{ 'checked' if cv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if cv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if cv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
</div></div></div>

<!-- ACC 5: ğŸ“œ History & Spiritual Significance -->
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ“œ</span> History & Spiritual Significance<span class="fab">1 field</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="cf-sep">Custom Fields â€” Spiritual</div>
{% for cf in custom_fields %}{% if cf.name == 'history' %}{% set cv = custom_values.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label>{{ cf.label }}</label>
{% if cf.field_type == 'richtext' %}<input type="hidden" name="cf_{{ cf.id }}" id="cf_rt_{{ cf.id }}" value="{{ cv.get('value','') }}"><div class="rich-editor" data-target="cf_rt_{{ cf.id }}" style="background:white;min-height:160px"></div>
{% else %}<textarea name="cf_{{ cf.id }}" class="form-control" rows="4">{{ cv.get('value','') }}</textarea>{% endif %}
</div></div>
<div class="field-toggle" style="padding-top:28px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="cf_vis_{{ cf.id }}" {{ 'checked' if cv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if cv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if cv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
</div></div></div>

<!-- ACC 6: ğŸ¬ Audio, Video & External Links -->
<div class="facc"><button type="button" class="facc-h ct1" onclick="togFacc(this)"><span class="fai">ğŸ¬</span> Audio, Video & External Links<span class="fab">media</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="cf-sep">Custom Fields â€” Media</div>
{% for cf in custom_fields %}{% if cf.name in ('audio_narration','video_tour','external_audio_url','external_video_url','gallery_images') and cf.name != 'entry_fee' %}{% set cv = custom_values.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label>{{ cf.label }} <span style="font-size:10px;color:var(--text-light)">{{ cf.field_type }}</span></label>
{% if cf.field_type in ('text','number') %}<input name="cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}" placeholder="{{ cf.placeholder }}">
{% elif cf.field_type == 'url' %}<input name="cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}" placeholder="{{ cf.placeholder or 'URL' }}">
<input name="cf_desc_{{ cf.id }}" class="form-control" value="{{ cv.get('description','') }}" placeholder="ğŸ“ Description (shown to visitors)" style="margin-top:6px;font-size:12px">
{% elif cf.field_type in ('audio','video') %}{% if cv.get('value') %}<input type="hidden" name="cf_{{ cf.id }}" value="{{ cv.get('value','') }}">
<div style="font-size:11px;color:green;margin-bottom:4px;display:flex;align-items:center;gap:4px">âœ… {{ cv.get('value','') }}</div>{% endif %}
<input type="file" name="cf_file_{{ cf.id }}" class="form-control" accept="{{ 'audio/*' if cf.field_type=='audio' else 'video/*' }}">
<input name="cf_desc_{{ cf.id }}" class="form-control" value="{{ cv.get('description','') }}" placeholder="ğŸ“ Description for this {{ cf.field_type }}" style="margin-top:6px;font-size:12px">
{% elif cf.field_type == 'images' %}{% if cv.get('value') %}<input type="hidden" name="cf_{{ cf.id }}" value="{{ cv.get('value','') }}">
<div class="gal-section" style="margin-bottom:6px"><span class="gal-count">{{ cv.get('value','').split(',')|reject('equalto','')|list|length }} image{{ 's' if cv.get('value','').split(',')|reject('equalto','')|list|length != 1 else '' }}</span>
<div class="gal-thumbs">{% for gi in cv.get('value','').split(',') %}{% if gi.strip() %}<div class="gal-thumb"><img src="/static/uploads/{{ gi.strip() }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="cfDeleteImage(this,'cf_{{ cf.id }}','{{ gi.strip() }}')" title="Delete">âœ•</span></div>{% endif %}{% endfor %}</div></div>{% endif %}<input type="file" name="cf_files_{{ cf.id }}" class="form-control" accept="image/*" multiple>
{% else %}<input name="cf_{{ cf.id }}" class="form-control" value="{{ cv.get('value','') }}">{% endif %}
</div></div>
<div class="field-toggle" style="padding-top:28px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="cf_vis_{{ cf.id }}" {{ 'checked' if cv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if cv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if cv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
{% endif %}
{% if editing %}
<div style="border-top:2px solid var(--border);padding-top:14px;margin-top:12px">
<h4 style="font-size:13px;font-weight:700;color:var(--text-light);letter-spacing:1px;text-transform:uppercase;margin-bottom:10px">ğŸµ Audio / Video Library</h4>
{% if t1_av %}
{% for av in t1_av %}
<div style="background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:8px;border:1px solid var(--border)">
<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px">
<div style="flex:1;min-width:0">
<div style="font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:{{ '#8BAB8A' if av.media_type=='audio' else '#9C27B0' }}">{{ 'ğŸµ Audio' if av.media_type=='audio' else 'ğŸ¬ Video' }}{% if av.source_type=='url' %} (URL){% endif %}</div>
{% if av.description %}<div style="font-size:12px;color:var(--text);margin-top:2px">{{ av.description }}</div>{% endif %}
<div style="font-size:10px;color:var(--text-light);margin-top:2px;word-break:break-all">{{ av.file_path or av.external_url }}</div>
{% if av.media_type == 'audio' %}
{% if av.source_type == 'upload' %}<audio controls style="width:100%;height:28px;margin-top:4px"><source src="/static/uploads/{{ av.file_path }}"></audio>
{% else %}<audio controls style="width:100%;height:28px;margin-top:4px"><source src="{{ av.external_url }}"></audio>{% endif %}
{% endif %}
</div>
<button type="button" class="btn btn-danger btn-icon btn-sm" title="Delete" onclick="deleteAudioVideo({{ av.id }}, '{{ av.media_type }}')"><i class="fas fa-trash"></i></button>
</div>
</div>
{% endfor %}
{% else %}
<div style="text-align:center;padding:10px;font-size:11px;color:var(--text-light);background:var(--bg);border-radius:8px">No audio/video added yet</div>
{% endif %}
<details style="margin-top:10px">
<summary style="font-size:12px;font-weight:600;cursor:pointer;color:var(--primary)"><i class="fas fa-plus"></i> Add Audio/Video</summary>
<div id="avAddForm" style="margin-top:8px;background:var(--bg);padding:10px;border-radius:8px">
<input type="hidden" id="avTier" value="T1">
<input type="hidden" id="avRefId" value="{{ place.id }}">
<div style="margin-bottom:6px"><select id="avMediaType" class="form-control" style="font-size:12px"><option value="audio">ğŸµ Audio</option><option value="video">ğŸ¬ Video</option></select></div>
<div style="margin-bottom:6px"><input type="file" id="avFile" class="form-control" accept="audio/*,video/*" style="font-size:11px"><div style="font-size:10px;color:var(--text-light);margin-top:2px">OR enter an external URL:</div></div>
<div style="margin-bottom:6px"><input id="avExternalUrl" class="form-control" placeholder="YouTube/Vimeo URL or audio link" style="font-size:11px"></div>
<div style="margin-bottom:6px"><input id="avDescription" class="form-control" placeholder="ğŸ“ Description" style="font-size:11px"></div>
<button type="button" class="btn btn-primary btn-sm" style="width:100%;font-size:11px" onclick="addAudioVideo()"><i class="fas fa-plus"></i> Add</button>
</div>
</details>
</div>
{% endif %}
</div></div></div>

<!-- Submit Button -->
<div style="display:flex;justify-content:flex-end;padding:16px 0;margin-top:4px">
<button type="submit" class="btn btn-primary" style="min-width:220px"><i class="fas fa-save"></i> {{ 'Update Holy Dham' if editing else 'Create Holy Dham' }}</button>
</div>

</div><!-- end tier-1-content -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TIER 2 CONTENT: KEY PLACES -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tier-content" id="tier-2-content">

<div class="back-btn-row"><a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Tier 1 Â· Holy Dham</a></div>

<div class="tier-def" style="background:#2E86AB0A;border:1.5px solid #2E86AB20">
<div class="tier-def-icon" style="background:#2E86AB15">ğŸ“</div>
<div class="tier-def-body">
<h4 style="color:#1A6B8A"><span style="font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:2px 10px;background:#2E86AB;color:white;border-radius:50px;margin-right:8px">Tier 2</span> Key Places</h4>
<div class="def-text">Major locations within the dham where important categories of pastimes or historical events occurred. Represents clusters of leelas or thematic zones.</div>
<div class="def-chars">
<span class="def-char" style="background:#2E86AB15;color:#2E86AB">Recognized pilgrimage stops</span>
<span class="def-char" style="background:#2E86AB15;color:#2E86AB">Distinct identity or mood</span>
<span class="def-char" style="background:#2E86AB15;color:#2E86AB">Large temples, kunds, forests</span>
</div>
</div>
</div>

<div class="admin-card" style="border-top:3px solid #2E86AB">
<div class="admin-card-header"><h3>ğŸ“ Key Places (Tier 2)</h3><span style="font-size:12px;color:var(--text-light)">{{ key_places|length }} key place{{ 's' if key_places|length != 1 }}</span></div>
<div class="admin-card-body" id="keyPlacesContainer">
{% for kp in key_places %}
{% set ki = loop.index0 %}
<div class="kp-accordion" data-index="{{ ki }}">
<div class="kp-accordion-header" onclick="this.parentElement.classList.toggle('open')">
<h4><span class="kp-num">{{ loop.index }}</span> <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;background:#2E86AB15;color:#2E86AB;border-radius:50px;font-weight:700;border:1px solid #2E86AB25">Tier 2</span> <span class="kp-title-display">{{ kp.title }}</span>{% if kp.hierarchy_id %}<span class="hid-badge" onclick="event.stopPropagation();copyHid(this)" data-hid="{{ kp.hierarchy_id }}" style="font-size:10px;margin-left:4px">{{ kp.hierarchy_id }} <span class="hid-copy">ğŸ“‹</span></span>{% endif %}</h4>
<div class="kp-actions">
<label class="toggle-label" onclick="event.stopPropagation()"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="kp_{{ ki }}_is_visible" {{ 'checked' if kp.is_visible }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if kp.is_visible else 'off' }}" style="font-size:11px">{{ 'On' if kp.is_visible else 'Off' }}</span></label>
<span class="chevron"><i class="fas fa-chevron-down"></i></span>
<button type="button" class="btn btn-danger btn-sm" onclick="event.stopPropagation();this.closest('.kp-accordion').remove()" title="Remove"><i class="fas fa-trash"></i></button>
</div>
</div>
<div class="kp-accordion-body"><div class="kp-accordion-body-inner">
<input type="hidden" name="kp_{{ ki }}_id" value="{{ kp.id }}">

<!-- T2 Title (always visible) -->
<div class="form-group"><label>ğŸ“ Title <span class="red-star">*</span></label><input name="kp_{{ ki }}_title" class="form-control" value="{{ kp.title }}" required onchange="this.closest('.kp-accordion').querySelector('.kp-title-display').textContent=this.value"></div>

<!-- T2 ACC 1: Core -->
<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ“‹</span> Core Information<span class="fab">2 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="form-group"><label>ğŸ“ Short Description</label><textarea name="kp_{{ ki }}_short_description" class="form-control" rows="2">{{ kp.short_description }}</textarea></div>
<div class="form-group"><label>ğŸ“– Full Description</label><input type="hidden" name="kp_{{ ki }}_full_content" id="kp_{{ ki }}_fc" value="{{ kp.full_content }}"><div class="rich-editor" data-target="kp_{{ ki }}_fc" style="background:white;min-height:120px"></div></div>
</div></div></div>

<!-- T2 ACC 2: Location -->
<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ“</span> Location<span class="fab">2 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div id="loc_kp_{{ ki }}" class="loc-picker">
<div class="loc-picker-title"><i class="fas fa-map-marker-alt" style="color:#2E86AB"></i> Location Picker <span class="loc-badge" style="background:#2E86AB">T2</span><button class="loc-info-btn" type="button" onclick="document.getElementById('locInfoPopup').classList.add('active')" title="How to use"><i class="fas fa-info"></i></button></div>
<div class="loc-saved" style="margin-bottom:10px"><span style="font-size:12px;color:var(--text-light);margin-right:4px">ğŸ“ Current:</span><span class="loc-saved-info">{% if kp.latitude and kp.longitude %}<span class="loc-coords-display">{{ kp.latitude }}, {{ kp.longitude }}</span>{% else %}<span class="loc-no-data">No location set</span>{% endif %}</span></div>
{% if kp.location_updated_at %}<div style="font-size:11px;color:var(--text-light);margin-bottom:10px;padding:6px 10px;background:var(--bg);border-radius:8px;border:1px dashed var(--border);display:inline-flex;align-items:center;gap:6px"><i class="fas fa-clock" style="color:#2E86AB;font-size:10px"></i> Location last updated by <strong style="color:var(--text-dark)">{{ kp.location_updated_by }}</strong> on <strong style="color:var(--text-dark)">{{ kp.location_updated_at }}</strong></div>{% endif %}
<div class="loc-status"></div>
<div class="loc-map-container"><div class="loc-map-wrap" style="height:100%"></div></div>
<div style="position:relative"><div class="loc-search-bar"><input class="loc-search-input" placeholder="ğŸ” Search for {{ kp.title or 'this place' }}"><button class="loc-search-btn" type="button"><i class="fas fa-search"></i> Search</button></div><div class="loc-search-results"></div></div>
<div class="loc-actions-row"><button type="button" class="loc-btn loc-btn-gps">ğŸ“¡ Use My Current Location</button><button type="button" class="loc-btn loc-btn-clear">ğŸ—‘ï¸ Clear</button></div>
<div class="loc-coords-row">
<div class="form-group"><label>ğŸ“ Latitude</label><input name="kp_{{ ki }}_latitude" class="form-control" type="number" step="any" value="{{ kp.latitude or '' }}"></div>
<div class="form-group"><label>ğŸ“ Longitude</label><input name="kp_{{ ki }}_longitude" class="form-control" type="number" step="any" value="{{ kp.longitude or '' }}"></div>
</div>
<div style="font-size:10px;color:var(--text-light);margin-top:6px;display:flex;align-items:center;gap:6px"><i class="fas fa-info-circle"></i> Click map Â· Drag pin Â· GPS/Search</div>
</div>
</div></div></div>

<!-- T2 ACC 3: Images & Media -->
<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ–¼ï¸</span> Images & Media<span class="fab">3 fields</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi">
<div class="form-group"><label>ğŸ–¼ï¸ Featured Image</label>{% if kp.featured_image %}<input type="hidden" name="kp_{{ ki }}_featured_image_existing" value="{{ kp.featured_image }}">
<div class="gal-section" style="margin-bottom:6px">
<div class="gal-thumbs"><div class="gal-thumb"><img src="/static/uploads/{{ kp.featured_image }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="deleteGalleryImage('t2',{{ kp.id }},'{{ kp.featured_image }}',this)" title="Delete">âœ•</span></div></div>
</div>{% endif %}<input type="file" name="kp_{{ ki }}_featured_image_file" class="form-control" accept="image/*">
<div class="cam-capture-wrap">
<div style="display:flex;gap:8px;align-items:center">
<button type="button" class="cam-btn" onclick="this.parentElement.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture Featured</button>
<button class="loc-info-btn" type="button" onclick="document.getElementById('camInfoPopup').classList.add('active')" title="How to use" style="flex-shrink:0"><i class="fas fa-info"></i></button>
</div>
<input type="file" name="kp_{{ ki }}_featured_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.parentElement.querySelector('.cam-preview');p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.cam-capture-wrap');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">âœ•</button></div>
<div class="cam-desc"><input type="text" name="kp_{{ ki }}_featured_cam_desc" placeholder="ğŸ“ Photo description (optional)"></div>
<div class="cam-info-badge"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed</div>
</div>
<input type="text" name="kp_{{ ki }}_featured_image_desc" class="form-control" value="{{ kp.featured_image_desc or '' }}" placeholder="ğŸ“ Featured image description" style="font-size:12px;margin-top:6px">
</div>
<div class="gal-section" style="background:#f4f7fa;border-radius:12px;padding:14px;margin-top:10px;border:1px solid #2E86AB15">
<label style="display:flex;align-items:center;gap:6px;font-weight:700;margin-bottom:6px;font-size:13px"><span style="font-size:16px">ğŸ“¸</span> Gallery Images <span style="font-size:10px;font-weight:500;color:var(--text-light)">(shown as slider)</span>
{% if kp.gallery_images %}<span class="gal-count">{{ kp.gallery_images.split(',')|length }} image{{ 's' if kp.gallery_images.split(',')|length != 1 }}</span>{% endif %}</label>
<input type="hidden" name="kp_{{ ki }}_gallery_existing" value="{{ kp.gallery_images or '' }}" class="gal-existing-input">
<input type="hidden" class="gal-captions-data" data-prefix="kp_{{ ki }}" value="{{ kp.gallery_captions|default('{}') }}">
{% if kp.gallery_images %}
<div class="gal-individual-list" id="kp_{{ ki }}_gal_list">
{% for gi in kp.gallery_images.split(',') %}{% if gi.strip() %}
<div class="gal-item" style="display:flex;align-items:center;gap:10px;padding:10px;background:white;border:1px solid var(--border);border-radius:10px;margin-bottom:8px">
<div class="gal-thumb" style="flex-shrink:0"><img src="/static/uploads/{{ gi.strip() }}" style="width:70px;height:70px;object-fit:cover;border-radius:8px;cursor:pointer" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"></div>
<div style="flex:1;min-width:0">
<input type="text" class="form-control gal-caption-input" name="kp_{{ ki }}_caption_{{ gi.strip() }}" data-img="{{ gi.strip() }}" placeholder="Caption for this image..." style="font-size:12px">
<div style="font-size:10px;color:var(--text-light);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ gi.strip().split('/')[-1] }}</div>
</div>
<button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="galDeleteConfirm(this,'t2',{{ kp.id }},'{{ gi.strip() }}','kp_{{ ki }}')"><i class="fas fa-trash"></i></button>
</div>
{% endif %}{% endfor %}
</div>
{% endif %}
<div id="kp_{{ ki }}_new_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="margin-top:6px;font-size:11px" onclick="addGalleryItem('kp_{{ ki }}')"><i class="fas fa-plus"></i> Add More Images</button>
<div class="cam-capture-wrap" style="margin-top:8px">
<button type="button" class="cam-btn cam-btn-gallery" onclick="addCamGalleryItem('kp_{{ ki }}')"><i class="fas fa-camera"></i> Capture Gallery Photo</button>
<div class="cam-info-badge"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed</div>
</div>
</div>
</div></div></div>

<!-- T2 ACC 4-6: Custom Fields (Visitor Â· History Â· Media) -->
{% if custom_fields %}{% set kpc = key_place_customs.get(kp.id, {}) %}
<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ§³</span> Visitor Information<span class="fab">custom</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi"><div class="cf-sep">Custom Fields â€” Visitor Info</div>
{% for cf in custom_fields %}{% if cf.applies_to in ('both','key_place') and cf.name in ('opening_hours','best_time_to_visit','dress_code') %}{% set kcv = kpc.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label style="font-size:12px;display:flex;align-items:center;gap:4px"><span style="font-size:14px">{{ cf.icon or 'ğŸ“‹' }}</span> {{ cf.label }}</label>
{% if cf.field_type in ('text','number') %}<input name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ kcv.get('value','') }}" style="font-size:13px">{% elif cf.field_type == 'textarea' %}<textarea name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" rows="2" style="font-size:13px">{{ kcv.get('value','') }}</textarea>{% else %}<input name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ kcv.get('value','') }}" style="font-size:13px">{% endif %}
</div></div><div class="field-toggle" style="padding-top:24px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="kp_{{ ki }}_cf_vis_{{ cf.id }}" {{ 'checked' if kcv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if kcv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if kcv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
</div></div></div>

<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ“œ</span> History & Spiritual<span class="fab">1 field</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi"><div class="cf-sep">Custom Fields â€” Spiritual</div>
{% for cf in custom_fields %}{% if cf.applies_to in ('both','key_place') and cf.name == 'history' %}{% set kcv = kpc.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label style="font-size:12px"><span style="font-size:14px">{{ cf.icon or 'ğŸ“œ' }}</span> {{ cf.label }}</label>
{% if cf.field_type == 'richtext' %}<input type="hidden" name="kp_{{ ki }}_cf_{{ cf.id }}" id="kp_{{ ki }}_cf_rt_{{ cf.id }}" value="{{ kcv.get('value','') }}"><div class="rich-editor" data-target="kp_{{ ki }}_cf_rt_{{ cf.id }}" style="background:white;min-height:120px"></div>{% else %}<textarea name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" rows="3">{{ kcv.get('value','') }}</textarea>{% endif %}
</div></div><div class="field-toggle" style="padding-top:24px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="kp_{{ ki }}_cf_vis_{{ cf.id }}" {{ 'checked' if kcv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if kcv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if kcv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
</div></div></div>

<div class="facc"><button type="button" class="facc-h ct2" onclick="togFacc(this)"><span class="fai">ğŸ¬</span> Audio, Video & Links<span class="fab">media</span><i class="fas fa-chevron-down fac"></i></button>
<div class="facc-b"><div class="facc-bi"><div class="cf-sep">Custom Fields â€” Media</div>
{% for cf in custom_fields %}{% if cf.applies_to in ('both','key_place') and cf.name in ('audio_narration','video_tour','external_audio_url','external_video_url','gallery_images') and cf.name != 'entry_fee' %}{% set kcv = kpc.get(cf.id, {}) %}
<div class="field-row"><div class="field-main"><div class="form-group"><label style="font-size:12px;display:flex;align-items:center;gap:4px"><span style="font-size:14px">{{ cf.icon or 'ğŸ“‹' }}</span> {{ cf.label }}</label>
{% if cf.field_type in ('text','number') %}<input name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ kcv.get('value','') }}" style="font-size:13px">
{% elif cf.field_type == 'url' %}<input name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ kcv.get('value','') }}" style="font-size:13px"><input name="kp_{{ ki }}_cf_desc_{{ cf.id }}" class="form-control" value="{{ kcv.get('description','') }}" placeholder="ğŸ“ Description" style="font-size:11px;margin-top:4px">
{% elif cf.field_type in ('audio','video') %}{% if kcv.get('value') %}<input type="hidden" name="kp_{{ ki }}_cf_{{ cf.id }}" value="{{ kcv.get('value','') }}"><div style="font-size:10px;color:green;margin-bottom:3px">âœ… {{ kcv.get('value','') }}</div>{% endif %}<input type="file" name="kp_{{ ki }}_cf_file_{{ cf.id }}" class="form-control" style="font-size:13px" accept="{{ 'audio/*' if cf.field_type=='audio' else 'video/*' }}"><input name="kp_{{ ki }}_cf_desc_{{ cf.id }}" class="form-control" value="{{ kcv.get('description','') }}" placeholder="ğŸ“ Description" style="font-size:11px;margin-top:4px">
{% elif cf.field_type == 'images' %}{% if kcv.get('value') %}<input type="hidden" name="kp_{{ ki }}_cf_{{ cf.id }}" value="{{ kcv.get('value','') }}"><div class="gal-section" style="margin-bottom:4px"><span class="gal-count">{{ kcv.get('value','').split(',')|reject('equalto','')|list|length }} images</span><div class="gal-thumbs">{% for gi in kcv.get('value','').split(',') %}{% if gi.strip() %}<div class="gal-thumb"><img src="/static/uploads/{{ gi.strip() }}" onclick="openLightbox(this.src)" onerror="this.parentElement.style.display='none'"><span class="gal-del" onclick="cfDeleteImage(this,'kp_{{ ki }}_cf_{{ cf.id }}','{{ gi.strip() }}')" title="Delete">âœ•</span></div>{% endif %}{% endfor %}</div></div>{% endif %}<input type="file" name="kp_{{ ki }}_cf_files_{{ cf.id }}" class="form-control" accept="image/*" multiple style="font-size:13px">
{% else %}<input name="kp_{{ ki }}_cf_{{ cf.id }}" class="form-control" value="{{ kcv.get('value','') }}" style="font-size:13px">{% endif %}
</div></div><div class="field-toggle" style="padding-top:24px"><label class="toggle-label"><label class="toggle-switch" style="width:40px;height:22px"><input type="checkbox" name="kp_{{ ki }}_cf_vis_{{ cf.id }}" {{ 'checked' if kcv.get('is_visible',1) }} onchange="updateToggleText(this)"><span class="toggle-slider"></span></label><span class="status-text {{ 'on' if kcv.get('is_visible',1) else 'off' }}" style="font-size:11px">{{ 'On' if kcv.get('is_visible',1) else 'Off' }}</span></label></div></div>
{% endif %}{% endfor %}
</div></div></div>
{% endif %}

{% if kp.id %}
<div style="margin-top:14px;padding:14px;background:linear-gradient(135deg,#fdf5f5,#f8f0f8);border:1px solid #E7484520;border-radius:12px;display:flex;align-items:center;gap:12px;flex-wrap:wrap">
<div style="flex:1"><div style="font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text-light)">Deeper Tiers</div><div style="font-size:13px;color:var(--text-mid)">Manage spots & points within {{ kp.title }}</div></div>
<a href="{{ url_for('admin_key_place_spots', kp_id=kp.id) }}" class="btn btn-sm" style="background:#E7484508;color:#E74845;border:1.5px solid #E7484530;font-weight:700" onclick="event.stopPropagation()"><i class="fas fa-layer-group"></i> Manage Key Spots <span style="font-size:9px;padding:1px 6px;background:#E74845;color:white;border-radius:50px">T3</span> {% if kp_spot_counts and kp_spot_counts.get(kp.id, 0) > 0 %}<span style="background:#E74845;color:white;padding:1px 7px;border-radius:50px;font-size:10px;margin-left:2px">{{ kp_spot_counts[kp.id] }}</span>{% endif %}</a>
</div>{% endif %}

<div class="section-save"><button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Save All Changes</button></div>
</div></div>
</div>
{% endfor %}
{% if not key_places %}<div style="padding:32px;text-align:center;color:var(--text-light)"><div style="font-size:36px;opacity:.3">ğŸ“</div><p>No Key Places yet. Add major zones within this Dham.</p></div>{% endif %}
</div></div>

<div style="display:flex;gap:12px;margin-top:16px;align-items:center">
<button type="button" class="add-kp-btn" onclick="addKeyPlace()" style="flex:1"><i class="fas fa-plus-circle"></i> Add Key Place (Tier 2)</button>
<button type="submit" class="btn btn-primary" style="min-width:200px"><i class="fas fa-save"></i> Save All Changes</button>
</div>

<div class="back-btn-row" style="margin-top:16px"><a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Tier 1 Â· Holy Dham</a></div>
</div><!-- end tier-2-content -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TIER 3 CONTENT: KEY SPOTS OVERVIEW -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tier-content" id="tier-3-content">

<div class="back-btn-row">
<a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 1 Â· Holy Dham</a>
<a href="javascript:switchTier(2)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 2 Â· Key Places</a>
</div>

<div class="tier-def" style="background:#E748450A;border:1.5px solid #E7484520">
<div class="tier-def-icon" style="background:#E7484515">ğŸ”¸</div>
<div class="tier-def-body">
<h4 style="color:#C73A38"><span style="font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:2px 10px;background:#E74845;color:white;border-radius:50px;margin-right:8px">Tier 3</span> Key Spots</h4>
<div class="def-text">Specific sites within a Key Place where a particular pastime, event, or spiritual activity is centered. A precise location of a known leela or event. Pilgrims visit for focused remembrance.</div>
<div class="def-chars">
<span class="def-char" style="background:#E7484515;color:#E74845">Identifiable physical spot</span>
<span class="def-char" style="background:#E7484515;color:#E74845">Specific pastimes</span>
<span class="def-char" style="background:#E7484515;color:#E74845">15 categories</span>
</div>
</div>
</div>

{% if editing and key_places|length > 0 %}
<!-- T3 Cascade Filter -->
<div class="tier-filter">
<div class="tf-title"><i class="fas fa-filter" style="color:#E74845"></i> Filter Key Spots by Key Place</div>
<div class="tf-row">
<div class="tf-grp">
<label>Key Place (T2)</label>
<select id="t3FilterKP" onchange="filterT3Spots(this.value)">
<option value="">â€” All Key Places ({{ all_spots|length }} spots) â€”</option>
{% for kp in key_places %}
<option value="{{ kp.id }}">ğŸ“ {{ kp.title }}</option>
{% endfor %}
</select>
</div>
</div>
<div class="tf-hint" id="t3FilterHint"><i class="fas fa-info-circle" style="color:var(--primary)"></i> Select a Key Place to filter, or view all {{ all_spots|length }} spots below</div>
</div>
{% endif %}

{% if editing and all_spots %}
<div id="t3SpotsContainer">
{% set current_kp = namespace(id=0) %}
{% for spot in all_spots %}
{% if spot.kp_id != current_kp.id %}
{% set current_kp.id = spot.kp_id %}
<div class="t3-kp-group" data-kpid="{{ spot.kp_id }}" style="display:flex;align-items:center;gap:10px;margin:{{ '20px' if not loop.first else '0' }} 0 12px;padding:10px 16px;background:#2E86AB08;border-radius:10px;border:1px solid #2E86AB15">
<span style="width:22px;height:22px;background:#2E86AB;color:white;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700">T2</span>
<span style="font-size:14px;font-weight:700;color:#2E86AB">{{ spot.kp_title }}</span>
<a href="{{ url_for('admin_key_place_spots', kp_id=spot.kp_id) }}" class="btn btn-sm" style="margin-left:auto;font-size:11px;background:#E7484510;color:#E74845;border:1px solid #E7484525"><i class="fas fa-edit"></i> Manage Spots</a>
</div>
{% endif %}
<div class="overview-card t3-spot-card" data-kpid="{{ spot.kp_id }}" style="border-color:{{ spot.cat_color or '#E74845' }}">
<div class="ov-icon" style="background:{{ spot.cat_color or '#E74845' }}12">{{ spot.cat_icon or 'ğŸ“' }}</div>
<div class="ov-body">
<div class="hier-bc">
<span class="bc-pill" style="background:#C76B8F15;color:#C76B8F">ğŸ™ T1</span><span class="bc-arrow">â€º</span>
<span class="bc-pill" style="background:#2E86AB15;color:#2E86AB">ğŸ“ {{ spot.kp_title }}</span><span class="bc-arrow">â€º</span>
<span class="bc-pill" style="background:{{ spot.cat_color or '#E74845' }}15;color:{{ spot.cat_color or '#E74845' }}">{{ spot.cat_icon or 'ğŸ”¸' }} T3</span>
</div>
<div class="ov-cat" style="color:{{ spot.cat_color or '#E74845' }}">{{ spot.cat_name or 'Uncategorized' }}</div>
<div class="ov-title">{{ spot.title }}{% if spot.hierarchy_id %} <span class="hid-badge" onclick="copyHid(this)" data-hid="{{ spot.hierarchy_id }}" style="font-size:9px;vertical-align:middle">{{ spot.hierarchy_id }} <span class="hid-copy">ğŸ“‹</span></span>{% endif %}</div>
{% if spot.short_description %}<div style="font-size:12px;color:var(--text-light);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:400px">{{ spot.short_description }}</div>{% endif %}
</div>
<div class="ov-actions">
<a href="{{ url_for('admin_key_spot_subs', ks_id=spot.id) }}" class="btn btn-secondary btn-sm" style="font-size:10px"><i class="fas fa-sitemap"></i> Key Points <span style="font-size:8px;padding:1px 5px;background:#9C27B0;color:white;border-radius:50px">T4</span></a>
</div>
</div>
{% endfor %}
</div>
{% elif editing %}
<div style="padding:32px;text-align:center;color:var(--text-light)"><div style="font-size:36px;opacity:.3">ğŸ”¸</div><p>No Key Spots yet. Go to Tier 2, open a Key Place, and click "Manage Key Spots" to add Tier 3 entries.</p></div>
{% else %}
<div style="padding:32px;text-align:center;color:var(--text-light)"><div style="font-size:36px;opacity:.3">ğŸ”¸</div><p>Save this Holy Dham first, then add Key Places (Tier 2) to start building Tier 3.</p></div>
{% endif %}

<div class="back-btn-row" style="margin-top:16px">
<a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 1 Â· Holy Dham</a>
<a href="javascript:switchTier(2)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 2 Â· Key Places</a>
</div>
</div><!-- end tier-3-content -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- TIER 4 CONTENT: KEY POINTS OVERVIEW -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="tier-content" id="tier-4-content">

<div class="back-btn-row">
<a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 1</a>
<a href="javascript:switchTier(2)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 2</a>
<a href="javascript:switchTier(3)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 3</a>
</div>

<div class="tier-def" style="background:#9C27B00A;border:1.5px solid #9C27B020">
<div class="tier-def-icon" style="background:#9C27B015">âœ¦</div>
<div class="tier-def-body">
<h4 style="color:#7B1FA2"><span style="font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:2px 10px;background:#9C27B0;color:white;border-radius:50px;margin-right:8px">Tier 4</span> Key Points</h4>
<div class="def-text">Exact micro-locations or meditation points within a Key Spot that highlight a very specific moment, action, or detail of a pastime. The finest level of devotional focus â€” may be a tree, rock, step, samadhi, footprint, or platform.</div>
<div class="def-chars">
<span class="def-char" style="background:#9C27B015;color:#9C27B0">Subtle or locally indicated</span>
<span class="def-char" style="background:#9C27B015;color:#9C27B0">Deep meditation</span>
<span class="def-char" style="background:#9C27B015;color:#9C27B0">10 categories</span>
</div>
</div>
</div>

{% if editing and key_places|length > 0 %}
<!-- T4 Cascade Filter -->
<div class="tier-filter">
<div class="tf-title"><i class="fas fa-filter" style="color:#9C27B0"></i> Filter Key Points by Tier Hierarchy</div>
<div class="tf-row">
<div class="tf-grp">
<label>Step 1 â€” Key Place (T2)</label>
<select id="t4FilterKP" onchange="filterT4ByKP(this.value)">
<option value="">â€” All Key Places â€”</option>
{% for kp in key_places %}
<option value="{{ kp.id }}">ğŸ“ {{ kp.title }}</option>
{% endfor %}
</select>
</div>
<div class="tf-grp">
<label>Step 2 â€” Key Spot (T3)</label>
<select id="t4FilterKS" disabled onchange="filterT4ByKS(this.value)">
<option value="">â€” Select Key Place first â€”</option>
</select>
</div>
</div>
<div class="tf-hint" id="t4FilterHint"><i class="fas fa-info-circle" style="color:var(--primary)"></i> Filter by Key Place â†’ Key Spot, or view all {{ all_points|length }} points below</div>
</div>
{% endif %}

{% if editing and all_points %}
<div id="t4PointsContainer">
{% set current_ks = namespace(id=0) %}
{% for pt in all_points %}
{% if pt.ks_id != current_ks.id %}
{% set current_ks.id = pt.ks_id %}
<div class="t4-ks-group" data-kpid="{{ pt.kp_id }}" data-ksid="{{ pt.ks_id }}" style="display:flex;align-items:center;gap:10px;margin:{{ '20px' if not loop.first else '0' }} 0 12px;padding:10px 16px;background:#E7484508;border-radius:10px;border:1px solid #E7484515">
<span style="width:22px;height:22px;background:#E74845;color:white;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700">T3</span>
<span style="font-size:14px;font-weight:700;color:#E74845">{{ pt.ks_title }}</span>
<span style="font-size:11px;color:var(--text-light)">in {{ pt.kp_title }}</span>
<a href="{{ url_for('admin_key_spot_subs', ks_id=pt.ks_id) }}" class="btn btn-sm" style="margin-left:auto;font-size:11px;background:#9C27B010;color:#9C27B0;border:1px solid #9C27B025"><i class="fas fa-edit"></i> Manage Points</a>
</div>
{% endif %}
<div class="overview-card t4-point-card" data-kpid="{{ pt.kp_id }}" data-ksid="{{ pt.ks_id }}" style="border-color:{{ pt.cat_color or '#9C27B0' }}">
<div class="ov-icon" style="background:{{ pt.cat_color or '#9C27B0' }}12">{{ pt.cat_icon or 'âœ¦' }}</div>
<div class="ov-body">
<div class="hier-bc">
<span class="bc-pill" style="background:#C76B8F15;color:#C76B8F">ğŸ™ T1</span><span class="bc-arrow">â€º</span>
<span class="bc-pill" style="background:#2E86AB15;color:#2E86AB">ğŸ“ {{ pt.kp_title }}</span><span class="bc-arrow">â€º</span>
<span class="bc-pill" style="background:#E7484515;color:#E74845">{{ pt.ks_cat_icon or 'ğŸ”¸' }} {{ pt.ks_title }}</span><span class="bc-arrow">â€º</span>
<span class="bc-pill" style="background:{{ pt.cat_color or '#9C27B0' }}15;color:{{ pt.cat_color or '#9C27B0' }}">{{ pt.cat_icon or 'âœ¦' }} T4</span>
</div>
<div class="ov-cat" style="color:{{ pt.cat_color or '#9C27B0' }}">{{ pt.cat_name or 'Uncategorized' }}</div>
<div class="ov-title">{{ pt.title }}{% if pt.hierarchy_id %} <span class="hid-badge" onclick="copyHid(this)" data-hid="{{ pt.hierarchy_id }}" style="font-size:9px;vertical-align:middle">{{ pt.hierarchy_id }} <span class="hid-copy">ğŸ“‹</span></span>{% endif %}</div>
{% if pt.short_description %}<div style="font-size:12px;color:var(--text-light);margin-top:2px">{{ pt.short_description }}</div>{% endif %}
</div>
</div>
{% endfor %}
</div>
{% elif editing %}
<div style="padding:32px;text-align:center;color:var(--text-light)"><div style="font-size:36px;opacity:.3">âœ¦</div><p>No Key Points yet. Go to a Key Spot's page and add Tier 4 entries there.</p></div>
{% else %}
<div style="padding:32px;text-align:center;color:var(--text-light)"><div style="font-size:36px;opacity:.3">âœ¦</div><p>Save this Holy Dham first to build the hierarchy.</p></div>
{% endif %}

<div class="back-btn-row" style="margin-top:16px">
<a href="javascript:switchTier(1)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 1</a>
<a href="javascript:switchTier(2)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 2</a>
<a href="javascript:switchTier(3)" class="back-btn"><i class="fas fa-arrow-left"></i> Tier 3</a>
</div>
</div><!-- end tier-4-content -->

</form>
{% endblock %}

{% block extra_js %}
<script>
function switchTier(n) {
    document.querySelectorAll('.tier-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tier-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tier-tab[data-tier="${n}"]`).classList.add('active');
    document.getElementById(`tier-${n}-content`).classList.add('active');
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function updateToggleText(cb) {
    const lbl = cb.closest('.toggle-label');
    if (!lbl) return;
    const st = lbl.querySelector('.status-text');
    if (st) { st.textContent = cb.checked ? 'On' : 'Off'; st.className = 'status-text ' + (cb.checked ? 'on' : 'off'); }
}

let kpIndex = {{ key_places|length }};
function addKeyPlace() {
    const container = document.getElementById('keyPlacesContainer');
    const div = document.createElement('div');
    div.className = 'kp-accordion open';
    div.innerHTML = `<div class="kp-accordion-header" onclick="this.parentElement.classList.toggle('open')">
<h4><span class="kp-num">${kpIndex+1}</span> <span style="font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;background:#2E86AB15;color:#2E86AB;border-radius:50px;font-weight:700;border:1px solid #2E86AB25">Tier 2</span> <span class="kp-title-display">New Key Place</span></h4>
<div class="kp-actions"><span class="chevron"><i class="fas fa-chevron-down"></i></span><button type="button" class="btn btn-danger btn-sm" onclick="event.stopPropagation();this.closest('.kp-accordion').remove()"><i class="fas fa-trash"></i></button></div></div>
<div class="kp-accordion-body" style="max-height:3000px"><div class="kp-accordion-body-inner">
<div class="form-group"><label>Title <span class="red-star">*</span></label><input name="kp_${kpIndex}_title" class="form-control" required placeholder="e.g. Vrindavan Town" onchange="this.closest('.kp-accordion').querySelector('.kp-title-display').textContent=this.value||'New Key Place'"></div>
<div class="form-group"><label>Short Description</label><textarea name="kp_${kpIndex}_short_description" class="form-control" rows="2"></textarea></div>
<div class="form-group"><label>Long Description</label><textarea name="kp_${kpIndex}_full_content" class="form-control" rows="4"></textarea></div>
<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
<div class="form-group"><label>Featured Image</label><input type="file" name="kp_${kpIndex}_featured_image_file" class="form-control" accept="image/*"></div>
<div class="form-group"><label>Latitude</label><input name="kp_${kpIndex}_latitude" class="form-control" type="number" step="any"></div>
<div class="form-group"><label>Longitude</label><input name="kp_${kpIndex}_longitude" class="form-control" type="number" step="any"></div></div>
<div style="padding:12px;background:#f7f7f2;border-radius:10px;font-size:12px;color:var(--text-light);margin-top:8px"><i class="fas fa-info-circle" style="color:#2E86AB"></i> Save first â†’ then "Manage Key Spots (T3)" button appears</div>
<div class="section-save"><button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save"></i> Save</button></div>
</div></div>`;
    container.appendChild(div);
    kpIndex++;
}

// Initialize Location Pickers
document.addEventListener('DOMContentLoaded', function(){
  // Init hierarchy search
  initHierarchySearch(document.getElementById('editHSearch'),document.getElementById('editHResults'),document.getElementById('editHClear'));
  // T1 Dham
  initLocationPicker('loc_t1','latitude','longitude');
  // T2 Key Places
  {% if editing %}{% for kp in key_places %}
  initLocationPicker('loc_kp_{{ loop.index0 }}','kp_{{ loop.index0 }}_latitude','kp_{{ loop.index0 }}_longitude');
  {% endfor %}{% endif %}

  // â”€â”€â”€ T4 KPâ†’KS mapping (for cascade filter) â”€â”€â”€
  {% if editing and all_spots %}
  window._t4KsMap = {};
  {% for spot in all_spots %}
  if (!window._t4KsMap['{{ spot.kp_id }}']) window._t4KsMap['{{ spot.kp_id }}'] = [];
  window._t4KsMap['{{ spot.kp_id }}'].push({id:'{{ spot.id }}', title:'{{ spot.title|replace("'","\\'") }}'});
  {% endfor %}
  {% endif %}

  // â”€â”€â”€ Audio/Video Library (JS-based to avoid nested forms) â”€â”€â”€
  window.deleteAudioVideo = function(avId, mediaType) {
    if (!confirm('Delete this ' + mediaType + '?')) return;
    if (!confirm('Are you sure? This cannot be undone.')) return;
    fetch('/admin/audio-video/' + avId + '/delete', {method:'POST'})
      .then(function(r){ location.reload(); })
      .catch(function(e){ alert('Error deleting: ' + e); });
  };
  window.addAudioVideo = function() {
    var fd = new FormData();
    fd.append('tier', document.getElementById('avTier').value);
    fd.append('place_ref_id', document.getElementById('avRefId').value);
    fd.append('media_type', document.getElementById('avMediaType').value);
    var fileInput = document.getElementById('avFile');
    if (fileInput.files.length > 0) fd.append('av_file', fileInput.files[0]);
    fd.append('external_url', document.getElementById('avExternalUrl').value);
    fd.append('description', document.getElementById('avDescription').value);
    fetch('/admin/audio-video/add', {method:'POST', body:fd})
      .then(function(r){ location.reload(); })
      .catch(function(e){ alert('Error adding: ' + e); });
  };
});

/* â•â•â• T3 Filter â•â•â• */
function filterT3Spots(kpId) {
    var container = document.getElementById('t3SpotsContainer');
    if (!container) return;
    var groups = container.querySelectorAll('.t3-kp-group');
    var cards = container.querySelectorAll('.t3-spot-card');
    var hint = document.getElementById('t3FilterHint');
    var count = 0;
    groups.forEach(function(g) {
        if (!kpId || g.dataset.kpid === kpId) { g.style.display = ''; } else { g.style.display = 'none'; }
    });
    cards.forEach(function(c) {
        if (!kpId || c.dataset.kpid === kpId) { c.style.display = ''; count++; } else { c.style.display = 'none'; }
    });
    if (!kpId) {
        hint.className = 'tf-hint';
        hint.innerHTML = '<i class="fas fa-info-circle" style="color:var(--primary)"></i> Showing all ' + cards.length + ' spots';
    } else {
        hint.className = 'tf-hint ok';
        var sel = document.getElementById('t3FilterKP');
        var name = sel.options[sel.selectedIndex].text.replace(/^ğŸ“\s*/, '');
        hint.innerHTML = '<i class="fas fa-check" style="color:#27ae60"></i> Showing <strong>' + count + '</strong> spot(s) under <strong>' + name + '</strong>';
    }
    container.classList.add('tier-filtered-list');
    setTimeout(function(){ container.classList.remove('tier-filtered-list'); }, 350);
}

/* â•â•â• T4 Filter â€” Step 1: by Key Place â•â•â• */
function filterT4ByKP(kpId) {
    var container = document.getElementById('t4PointsContainer');
    if (!container) return;
    var ksSel = document.getElementById('t4FilterKS');
    var hint = document.getElementById('t4FilterHint');
    // Reset KS dropdown
    ksSel.innerHTML = '';
    ksSel.disabled = true;
    if (!kpId) {
        ksSel.innerHTML = '<option value="">â€” Select Key Place first â€”</option>';
        // Show all
        container.querySelectorAll('.t4-ks-group, .t4-point-card').forEach(function(el){ el.style.display = ''; });
        hint.className = 'tf-hint';
        hint.innerHTML = '<i class="fas fa-info-circle" style="color:var(--primary)"></i> Showing all points';
        return;
    }
    // Filter T4 items by KP
    container.querySelectorAll('.t4-ks-group').forEach(function(g) {
        g.style.display = (g.dataset.kpid === kpId) ? '' : 'none';
    });
    var count = 0;
    container.querySelectorAll('.t4-point-card').forEach(function(c) {
        if (c.dataset.kpid === kpId) { c.style.display = ''; count++; } else { c.style.display = 'none'; }
    });
    // Populate KS dropdown
    var spots = (window._t4KsMap && window._t4KsMap[kpId]) || [];
    var opt0 = document.createElement('option'); opt0.value = ''; opt0.text = 'â€” All ' + spots.length + ' Key Spots â€”'; ksSel.appendChild(opt0);
    spots.forEach(function(s) {
        var o = document.createElement('option'); o.value = s.id; o.text = 'â­ ' + s.title; ksSel.appendChild(o);
    });
    ksSel.disabled = false;
    var sel = document.getElementById('t4FilterKP');
    var name = sel.options[sel.selectedIndex].text.replace(/^ğŸ“\s*/, '');
    hint.className = 'tf-hint ok';
    hint.innerHTML = '<i class="fas fa-check" style="color:#27ae60"></i> <strong>' + count + '</strong> point(s) under <strong>' + name + '</strong> â€” optionally filter by Key Spot';
    container.classList.add('tier-filtered-list');
    setTimeout(function(){ container.classList.remove('tier-filtered-list'); }, 350);
}

/* â•â•â• T4 Filter â€” Step 2: by Key Spot â•â•â• */
function filterT4ByKS(ksId) {
    var container = document.getElementById('t4PointsContainer');
    if (!container) return;
    var kpId = document.getElementById('t4FilterKP').value;
    var hint = document.getElementById('t4FilterHint');
    var count = 0;
    container.querySelectorAll('.t4-ks-group').forEach(function(g) {
        if (g.dataset.kpid !== kpId) { g.style.display = 'none'; return; }
        if (!ksId || g.dataset.ksid === ksId) { g.style.display = ''; } else { g.style.display = 'none'; }
    });
    container.querySelectorAll('.t4-point-card').forEach(function(c) {
        if (c.dataset.kpid !== kpId) { c.style.display = 'none'; return; }
        if (!ksId || c.dataset.ksid === ksId) { c.style.display = ''; count++; } else { c.style.display = 'none'; }
    });
    if (!ksId) {
        filterT4ByKP(kpId); return;
    }
    var ksSel = document.getElementById('t4FilterKS');
    var ksName = ksSel.options[ksSel.selectedIndex].text.replace(/^â­\s*/, '');
    hint.className = 'tf-hint ok';
    hint.innerHTML = '<i class="fas fa-check" style="color:#27ae60"></i> <strong>' + count + '</strong> point(s) under <strong>' + ksName + '</strong>';
    container.classList.add('tier-filtered-list');
    setTimeout(function(){ container.classList.remove('tier-filtered-list'); }, 350);
}
</script>
{% endblock %}
