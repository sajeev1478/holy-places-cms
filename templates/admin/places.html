{% extends "admin/base.html" %}
{% block title %}Holy Dhams{% endblock %}
{% block page_title %}Holy Dhams{% endblock %}
{% block topbar_actions %}<a href="{{ url_for('admin_place_new') }}" class="btn btn-primary"><i class="fas fa-plus"></i> New Dham</a>{% endblock %}

{% block admin_content %}
<div style="display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;align-items:center">
<a class="btn btn-sm {{ 'btn-primary' if not current_status else 'btn-secondary' }}" href="{{ url_for('admin_places') }}">All</a>
<a class="btn btn-sm {{ 'btn-primary' if current_status=='published' else 'btn-secondary' }}" href="{{ url_for('admin_places', status='published') }}">Published</a>
<a class="btn btn-sm {{ 'btn-primary' if current_status=='draft' else 'btn-secondary' }}" href="{{ url_for('admin_places', status='draft') }}">Drafts</a>
<form action="{{ url_for('admin_places') }}" method="GET" style="margin-left:auto;display:flex;gap:8px" onsubmit="return false">
<div class="hsearch-wrap" style="width:320px">
<input id="placesHSearch" class="hsearch-input" autocomplete="off" placeholder="Search all tiers by name or ID..." value="{{ query }}">
<i class="fas fa-search hsearch-icon"></i>
<button type="button" class="hsearch-clear" id="placesHClear">âœ•</button>
<div class="hsearch-results" id="placesHResults"></div>
</div>
</form>
</div>

<div class="admin-card">
{% if places %}
<div style="overflow-x:auto">
<table class="admin-table">
<thead><tr><th>ID</th><th>Dham Name</th><th>Location</th><th>Key Places</th><th>Status</th><th>Featured</th><th>Views</th><th>Updated</th><th>Actions</th></tr></thead>
<tbody>
{% for place in places %}
<tr>
<td><span class="hid-badge" onclick="copyHid(this)" data-hid="{{ place.hierarchy_id or 'â€”' }}" title="Click to copy">{{ place.hierarchy_id or 'â€”' }} <span class="hid-copy">ğŸ“‹</span></span></td>
<td>
<a href="{{ url_for('admin_place_edit', place_id=place.id) }}" style="font-weight:600;color:var(--text)">{{ place.title }}</a>
<div style="font-size:11px;color:var(--text-light);margin-top:2px">ğŸ™ Tier 1 Â· {{ place.dham_code or '' }}</div>
</td>
<td style="font-size:13px;color:var(--text-light)">{{ place.city }}{% if place.city and place.state %}, {% endif %}{{ place.state }}</td>
<td><span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;background:var(--primary-light);color:var(--primary);border-radius:50px;font-size:12px;font-weight:600">ğŸ“ {{ place.kp_count }}</span></td>
<td><span class="badge badge-{{ place.status }}">{{ place.status }}</span></td>
<td>{% if place.is_featured %}<i class="fas fa-star" style="color:var(--warning)"></i>{% endif %}</td>
<td>{{ place.view_count }}</td>
<td style="font-size:12px;color:var(--text-light)">{{ place.updated_at[:10] if place.updated_at else '' }}</td>
<td class="actions">
{% if has_permission(current_user, 'manage_places') %}
<a href="{{ url_for('admin_place_edit', place_id=place.id) }}" class="btn btn-secondary btn-icon btn-sm" title="Edit"><i class="fas fa-edit"></i></a>
{% endif %}
{% if has_permission(current_user, 'capture_photo') %}
<a href="{{ url_for('admin_place_photos', place_id=place.id) }}" class="btn btn-secondary btn-icon btn-sm" title="Photos" style="{% if not has_permission(current_user, 'manage_places') %}background:#2E86AB15;color:#2E86AB;border-color:#2E86AB40{% endif %}"><i class="fas fa-camera"></i></a>
{% endif %}
{% if has_permission(current_user, 'update_location') %}
<a href="{{ url_for('admin_place_location', place_id=place.id) }}" class="btn btn-secondary btn-icon btn-sm" title="Location" style="{% if not has_permission(current_user, 'manage_places') %}background:#8BAB8A15;color:#3D6B3D;border-color:#8BAB8A40{% endif %}"><i class="fas fa-map-marker-alt"></i></a>
{% endif %}
<a href="{{ url_for('place_detail', slug=place.slug) }}" target="_blank" class="btn btn-secondary btn-icon btn-sm" title="View"><i class="fas fa-eye"></i></a>
{% if has_permission(current_user, 'manage_places') %}
<form method="POST" action="{{ url_for('admin_place_delete', place_id=place.id) }}" style="display:inline" onsubmit="return confirm('Delete this dham?')">
<button type="submit" class="btn btn-danger btn-icon btn-sm" title="Delete"><i class="fas fa-trash"></i></button>
</form>
{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% else %}
<div class="empty"><span class="icon">ğŸ›•</span><h3>No Holy Dhams found</h3><p>Create your first Holy Dham to begin building the spiritual hierarchy.</p></div>
{% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded',function(){
  initHierarchySearch(
    document.getElementById('placesHSearch'),
    document.getElementById('placesHResults'),
    document.getElementById('placesHClear')
  );
});
</script>
{% endblock %}
