{% extends "admin/base.html" %}
{% block title %}{{ 'Edit' if editing else 'New' }} User{% endblock %}
{% block page_title %}{{ 'Edit' if editing else 'Create' }} User{% endblock %}

{% block admin_content %}
<form method="POST" class="admin-card" style="max-width:700px">
<div class="admin-card-body">
<div class="form-row">
<div class="form-group">
<label>Username *</label>
<input name="username" class="form-control" value="{{ user.username if editing else '' }}" {{ 'readonly' if editing }} required>
</div>
<div class="form-group">
<label>Display Name</label>
<input name="display_name" class="form-control" value="{{ user.display_name if editing else '' }}" required>
</div>
</div>
<div class="form-group">
<label>Email *</label>
<input name="email" class="form-control" type="email" value="{{ user.email if editing else '' }}" required>
</div>
<div class="form-group">
<label>Password {{ '(leave blank to keep current)' if editing else '*' }}</label>
<input name="password" class="form-control" type="password" {{ '' if editing else 'required' }} placeholder="{{ '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' if editing else 'Enter password' }}">
</div>
<div class="form-group">
<label>Role</label>
<select name="role" class="form-control">
<option value="editor" {{ 'selected' if editing and user.role=='editor' }}>Editor</option>
<option value="content_admin" {{ 'selected' if editing and user.role=='content_admin' }}>Content Admin</option>
<option value="super_admin" {{ 'selected' if editing and user.role=='super_admin' }}>Super Admin</option>
</select>
<div class="hint">Super Admin has all permissions. Content Admin and Editor permissions are set below.</div>
</div>

<div class="form-group">
<label>üì© Receive Error/Feedback Reports</label>
<label class="form-check" style="padding:10px 14px;background:var(--bg);border-radius:8px">
<input type="checkbox" name="receive_reports" value="1" {{ 'checked' if editing and user.receive_reports }}>
<div>
<div style="font-weight:600;font-size:13px">Send reports to this user's email</div>
<div style="font-size:11px;color:var(--text-light)">When visitors submit error reports or feedback, emails will also be sent to this user.</div>
</div>
</label>
</div>

<div class="form-group">
<label>Permissions</label>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
{% for perm in perm_defs %}{% if perm.category != 'field_access' %}
<label class="form-check" style="padding:10px 14px;background:var(--bg);border-radius:8px">
<input type="checkbox" name="permissions" value="{{ perm.permission_key }}"
    {{ 'checked' if editing and user_perms.get(perm.permission_key) }}>
<div>
<div style="font-weight:600;font-size:13px">{{ perm.label }}</div>
<div style="font-size:11px;color:var(--text-light)">{{ perm.description }}</div>
</div>
</label>
{% endif %}{% endfor %}
</div>
<div style="margin-top:16px;padding-top:12px;border-top:2px solid var(--border)">
<div style="font-size:13px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px"><i class="fas fa-lock" style="color:var(--primary)"></i> Restricted Field Access</div>
<div style="font-size:11px;color:var(--text-light);margin-bottom:10px;padding:8px 12px;background:#FFF3E0;border-radius:8px;border:1px solid #FFE0B2">
<strong>‚ö†Ô∏è Important:</strong> These permissions open a dedicated page where the user can <strong>see all data across all tiers</strong> (titles, descriptions, status, tags, custom fields) in <strong>read-only mode</strong> for reference ‚Äî but can <strong>only edit photos or GPS location</strong> as per the option given. No other content can be modified.</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
{% for perm in perm_defs %}{% if perm.category == 'field_access' %}
<label class="form-check" style="padding:10px 14px;background:#E3F2FD;border-radius:8px;border:1px solid #BBDEFB">
<input type="checkbox" name="permissions" value="{{ perm.permission_key }}"
    {{ 'checked' if editing and user_perms.get(perm.permission_key) }}>
<div>
<div style="font-weight:600;font-size:13px">{{ perm.label }}</div>
<div style="font-size:11px;color:var(--text-light)">{{ perm.description }}</div>
</div>
</label>
{% endif %}{% endfor %}
</div>
</div>
</div>

{% if editing %}
<div class="form-group">
<label class="form-check"><input type="checkbox" name="is_active" {{ 'checked' if user.is_active }}> Account is Active</label>
</div>
{% endif %}
</div>
<div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end">
<a href="{{ url_for('admin_users') }}" class="btn btn-secondary">Cancel</a>
<button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> {{ 'Update' if editing else 'Create' }} User</button>
</div>
</form>
{% endblock %}
