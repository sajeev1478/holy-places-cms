{% extends "admin/base.html" %}
{% set place = d.place %}
{% set kps = d.kps %}
{% set kss = d.kss %}
{% set sss = d.sss %}
{% block title %}Location ‚Äì {{ place.title }}{% endblock %}
{% block page_title %}üìç Update Locations ‚Äî {{ place.title }}{% endblock %}
{% block topbar_actions %}<a href="{{ url_for('admin_places') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back</a>{% endblock %}

{% block admin_content %}
<style>
.rp-notice{background:linear-gradient(135deg,#8BAB8A12,#8BAB8A06);border:1px solid #8BAB8A30;border-radius:12px;padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;font-size:13px;color:#3D6B3D}
.rp-notice i{font-size:18px;flex-shrink:0}
.tier-card{background:white;border-radius:14px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.03);border:1px solid var(--border);overflow:hidden}
.tier-head{padding:16px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none}
.tier-head:hover{background:rgba(0,0,0,.015)}
.tier-badge{font-size:9px;font-weight:700;letter-spacing:1px;padding:3px 10px;border-radius:50px;color:white;flex-shrink:0}
.tier-head-info{flex:1;min-width:0}
.tier-head-title{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tier-head-sub{font-size:11px;color:var(--text-light);margin-top:1px}
.tier-head-img{width:42px;height:42px;object-fit:cover;border-radius:8px;border:1px solid var(--border);flex-shrink:0}
.tier-chevron{transition:transform .2s;color:var(--text-light)}
.tier-card.open .tier-chevron{transform:rotate(180deg)}
.tier-body{display:none;border-top:1px solid var(--border)}
.tier-card.open .tier-body{display:block}
.ro-section{padding:14px 20px;border-bottom:1px solid #f0ede8}
.ro-section:last-child{border-bottom:none}
.ro-label{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-light);margin-bottom:4px}
.ro-value{font-size:13px;color:var(--text);line-height:1.5}
.ro-value.empty{font-style:italic;color:#bbb;font-size:12px}
.ro-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:8px}
.ro-chip{display:inline-block;padding:3px 10px;background:#f3f0e8;border-radius:50px;font-size:11px;font-weight:600;margin:2px}
.ro-img-row{display:flex;gap:6px;flex-wrap:wrap}
.ro-img{width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid var(--border)}
.edit-section{padding:16px 20px;background:linear-gradient(135deg,#8BAB8A12,#8BAB8A06);border-top:2px solid #8BAB8A40}
.edit-section .es-label{font-size:11px;font-weight:700;color:#3D6B3D;letter-spacing:1px;text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.edit-section .es-label i{font-size:14px}
.loc-row{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;align-items:end}
.loc-row .form-group{margin-bottom:0}
.loc-row label{font-size:11px;font-weight:600;display:block;margin-bottom:3px}
.loc-row input{font-size:13px;padding:8px 10px}
.gps-btn{background:linear-gradient(135deg,#8BAB8A,#6d8d6c);color:white;border:none;padding:8px 14px;border-radius:8px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;height:38px}
.gps-btn:hover{opacity:.9}
.tier-divider{font-size:11px;font-weight:700;color:var(--text-light);letter-spacing:1.5px;text-transform:uppercase;margin:20px 0 10px;padding-bottom:6px;border-bottom:2px solid var(--border)}
.ro-cf-item{background:#f8f6f0;border-radius:6px;padding:6px 10px;margin-bottom:3px;display:flex;gap:8px;align-items:baseline}
.ro-cf-label{font-size:11px;font-weight:600;color:var(--text);white-space:nowrap}
.ro-cf-val{font-size:11px;color:var(--text-light);flex:1}
@media(max-width:600px){.ro-grid{grid-template-columns:1fr}.loc-row{grid-template-columns:1fr 1fr;gap:8px}.gps-btn{grid-column:1/-1}}
</style>

<div class="rp-notice">
<i class="fas fa-info-circle"></i>
<div><strong>Location Update Mode</strong> ‚Äî All data is shown for reference (read-only). You can only update GPS coordinates. Text, descriptions, images, status, tags, and all other fields cannot be edited here. Use the GPS button when on-site for best accuracy.</div>
</div>

<form method="POST">

{# ‚ïê‚ïê‚ïê MACROS ‚ïê‚ïê‚ïê #}

{# Read-only data display #}
{% macro ro_data(item, short_desc=none, full_content=none, featured_img=none, gallery=none, gallery_media_list=none, status=none, tags=none, cfs=none, cvs=none) %}
<div class="ro-section">
<div class="ro-grid">
<div><div class="ro-label">Status</div><div class="ro-value"><span class="badge badge-{{ status or 'draft' }}">{{ status or 'draft' }}</span></div></div>
{% if short_desc %}<div style="grid-column:1/-1"><div class="ro-label">Short Description</div><div class="ro-value">{{ short_desc }}</div></div>{% endif %}
{% if full_content %}<div style="grid-column:1/-1"><div class="ro-label">Description</div><div class="ro-value" style="font-size:12px;max-height:80px;overflow:hidden">{{ full_content|striptags|truncate(250) }}</div></div>{% endif %}
</div>
</div>
{# Images row #}
{% if featured_img or gallery_media_list or gallery %}
<div class="ro-section"><div class="ro-label">Images</div>
<div class="ro-img-row">
{% if featured_img %}<img src="/static/uploads/{{ featured_img }}" class="ro-img" title="Featured">{% endif %}
{% if gallery_media_list %}{% for gm in gallery_media_list %}<img src="/static/uploads/{{ gm.filename }}" class="ro-img">{% endfor %}{% endif %}
{% if gallery %}{% for gi in gallery.split(',') %}{% if gi.strip() %}<img src="/static/uploads/{{ gi.strip() }}" class="ro-img">{% endif %}{% endfor %}{% endif %}
</div>
</div>
{% endif %}
{% if tags %}
<div class="ro-section"><div class="ro-label">Tags</div>{% for t in tags %}<span class="ro-chip">{{ t }}</span>{% endfor %}</div>
{% endif %}
{% if cfs and cvs %}
{% set ns = namespace(has=false) %}{% for cf in cfs %}{% if cvs.get(cf.id, {}).get('value') %}{% set ns.has = true %}{% endif %}{% endfor %}
{% if ns.has %}
<div class="ro-section"><div class="ro-label">Custom Fields</div>
{% for cf in cfs %}{% set cv = cvs.get(cf.id, {}) %}{% if cv.get('value') %}
<div class="ro-cf-item"><span class="ro-cf-label">{{ cf.label }}:</span>
{% if cf.field_type == 'image' %}<img src="/static/uploads/{{ cv.value }}" style="width:30px;height:30px;border-radius:4px;object-fit:cover">
{% elif cf.field_type in ('audio','video','audio_url','video_url') %}<span class="ro-cf-val">{{ cv.get('description','') or '(media file)' }}</span>
{% elif cf.field_type == 'richtext' %}<span class="ro-cf-val">{{ cv.value|striptags|truncate(80) }}</span>
{% else %}<span class="ro-cf-val">{{ cv.value|truncate(80) }}</span>{% endif %}
</div>
{% endif %}{% endfor %}
</div>
{% endif %}
{% endif %}
{% endmacro %}

{# Editable location section #}
{% macro loc_edit(prefix, lat, lng, loc_updated_at='', loc_updated_by='', tier_color='#8BAB8A') %}
<div class="edit-section">
<div class="es-label"><i class="fas fa-map-marker-alt"></i> Edit GPS Coordinates</div>
{% if lat and lng %}<div style="font-size:11px;color:var(--text-light);margin-bottom:8px">Current: <span style="font-family:monospace;font-weight:600;color:var(--text)">{{ lat }}, {{ lng }}</span></div>{% endif %}
{% if loc_updated_at %}<div style="font-size:11px;color:var(--text-light);margin-bottom:8px;padding:5px 10px;background:white;border-radius:6px;border:1px dashed var(--border);display:inline-flex;align-items:center;gap:6px"><i class="fas fa-clock" style="color:{{ tier_color }};font-size:10px"></i> Location last updated by <strong style="color:var(--text-dark)">{{ loc_updated_by }}</strong> on <strong style="color:var(--text-dark)">{{ loc_updated_at }}</strong></div>{% endif %}
<div class="loc-row">
<div class="form-group"><label>Latitude</label><input name="{{ prefix }}_latitude" class="form-control" type="number" step="any" value="{{ lat or '' }}" placeholder="e.g. 26.7922"></div>
<div class="form-group"><label>Longitude</label><input name="{{ prefix }}_longitude" class="form-control" type="number" step="any" value="{{ lng or '' }}" placeholder="e.g. 82.1998"></div>
<button type="button" class="gps-btn" onclick="fillGPS(this)"><i class="fas fa-crosshairs"></i> Use GPS</button>
</div>
</div>
{% endmacro %}

<!-- ‚ïê‚ïê‚ïê T1: HOLY DHAM ‚ïê‚ïê‚ïê -->
<div class="tier-card open">
<div class="tier-head" onclick="this.parentElement.classList.toggle('open')">
<span class="tier-badge" style="background:#C76B8F">T1</span>
{% if place.featured_image %}<img src="/static/uploads/{{ place.featured_image }}" class="tier-head-img">{% endif %}
<div class="tier-head-info">
<div class="tier-head-title">üôè {{ place.title }}</div>
<div class="tier-head-sub">{{ place.city }}{% if place.city and place.state %}, {% endif %}{{ place.state }} ¬∑ {{ place.hierarchy_id or '' }}</div>
</div>
<i class="fas fa-chevron-down tier-chevron"></i>
</div>
<div class="tier-body">
{{ ro_data(place, place.short_description, place.full_content, place.featured_image, gallery_media_list=d.gallery_media, status=place.status, tags=d.tags, cfs=d.custom_fields, cvs=d.custom_values) }}
{{ loc_edit('t1', place.latitude, place.longitude, place.location_updated_at, place.location_updated_by, '#C76B8F') }}
</div>
</div>

<!-- ‚ïê‚ïê‚ïê T2: KEY PLACES ‚ïê‚ïê‚ïê -->
{% if kps %}
<div class="tier-divider">üìç Tier 2 ‚Äî Key Places ({{ kps|length }})</div>
{% for kp in kps %}
<div class="tier-card">
<div class="tier-head" onclick="this.parentElement.classList.toggle('open')">
<span class="tier-badge" style="background:#2E86AB">T2</span>
{% if kp.featured_image %}<img src="/static/uploads/{{ kp.featured_image }}" class="tier-head-img">{% endif %}
<div class="tier-head-info">
<div class="tier-head-title">{{ kp.title }}</div>
<div class="tier-head-sub">{{ kp.hierarchy_id or '' }}{% if kp.short_description %} ¬∑ {{ kp.short_description|truncate(50) }}{% endif %}</div>
</div>
<i class="fas fa-chevron-down tier-chevron"></i>
</div>
<div class="tier-body">
{{ ro_data(kp, kp.short_description, kp.full_content, kp.featured_image, gallery=kp.gallery_images, status='published', cfs=d.kp_field_defs, cvs=d.kp_customs.get(kp.id, {})) }}
{{ loc_edit('kp_' ~ kp.id, kp.latitude, kp.longitude, kp.location_updated_at, kp.location_updated_by, '#2E86AB') }}
</div>
</div>
{% endfor %}
{% endif %}

<!-- ‚ïê‚ïê‚ïê T3: KEY SPOTS ‚ïê‚ïê‚ïê -->
{% if kss %}
<div class="tier-divider">üéØ Tier 3 ‚Äî Key Spots ({{ kss|length }})</div>
{% for ks in kss %}
<div class="tier-card">
<div class="tier-head" onclick="this.parentElement.classList.toggle('open')">
<span class="tier-badge" style="background:#E74845">T3</span>
{% if ks.featured_image %}<img src="/static/uploads/{{ ks.featured_image }}" class="tier-head-img">{% endif %}
<div class="tier-head-info">
<div class="tier-head-title">{{ ks.title }}</div>
<div class="tier-head-sub">{{ ks.kp_title }} ¬∑ {{ ks.hierarchy_id or '' }}</div>
</div>
<i class="fas fa-chevron-down tier-chevron"></i>
</div>
<div class="tier-body">
{{ ro_data(ks, ks.short_description, ks.full_content, ks.featured_image, gallery=ks.gallery_images, status='published') }}
{{ loc_edit('ks_' ~ ks.id, ks.latitude, ks.longitude, ks.location_updated_at, ks.location_updated_by, '#E74845') }}
</div>
</div>
{% endfor %}
{% endif %}

<!-- ‚ïê‚ïê‚ïê T4: KEY POINTS ‚ïê‚ïê‚ïê -->
{% if sss %}
<div class="tier-divider">‚ú¶ Tier 4 ‚Äî Key Points ({{ sss|length }})</div>
{% for ss in sss %}
<div class="tier-card">
<div class="tier-head" onclick="this.parentElement.classList.toggle('open')">
<span class="tier-badge" style="background:#9C27B0">T4</span>
{% if ss.featured_image %}<img src="/static/uploads/{{ ss.featured_image }}" class="tier-head-img">{% endif %}
<div class="tier-head-info">
<div class="tier-head-title">{{ ss.title }}</div>
<div class="tier-head-sub">{{ ss.ks_title }} ‚Üí {{ ss.kp_title }}</div>
</div>
<i class="fas fa-chevron-down tier-chevron"></i>
</div>
<div class="tier-body">
{{ ro_data(ss, ss.short_description, ss.full_content, ss.featured_image, gallery=ss.gallery_images, status='published') }}
{{ loc_edit('ss_' ~ ss.id, ss.latitude, ss.longitude, ss.location_updated_at, ss.location_updated_by, '#9C27B0') }}
</div>
</div>
{% endfor %}
{% endif %}

<div style="position:sticky;bottom:0;background:var(--bg);padding:14px 0;border-top:1px solid var(--border);margin-top:20px;z-index:10">
<button type="submit" class="btn btn-primary" style="width:100%;max-width:400px"><i class="fas fa-save"></i> Save All Locations</button>
</div>
</form>

<script>
function fillGPS(btn){
    if(!navigator.geolocation){alert('GPS not available on this device.');return}
    btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Getting...';btn.disabled=true;
    navigator.geolocation.getCurrentPosition(function(pos){
        var row=btn.closest('.loc-row'),inputs=row.querySelectorAll('input[type=number]');
        inputs[0].value=pos.coords.latitude.toFixed(6);inputs[1].value=pos.coords.longitude.toFixed(6);
        btn.innerHTML='<i class="fas fa-check"></i> Done';btn.style.background='#2E7D32';
        setTimeout(function(){btn.innerHTML='<i class="fas fa-crosshairs"></i> Use GPS';btn.style.background='';btn.disabled=false},2000);
    },function(err){alert('Could not get location: '+err.message);btn.innerHTML='<i class="fas fa-crosshairs"></i> Use GPS';btn.disabled=false},{enableHighAccuracy:true,timeout:15000});
}
</script>
{% endblock %}
