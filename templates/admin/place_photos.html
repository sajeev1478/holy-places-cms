{% extends "admin/base.html" %}
{% block title %}Photos ‚Äì {{ place.title }}{% endblock %}
{% block page_title %}üì∑ Capture Photos{% endblock %}
{% block topbar_actions %}<a href="{{ url_for('admin_places') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Dhams</a>{% endblock %}

{% block admin_content %}
<style>
.photo-notice{background:linear-gradient(135deg,#2E86AB15,#2E86AB08);border:1px solid #2E86AB30;border-radius:12px;padding:14px 18px;margin-bottom:20px;display:flex;align-items:center;gap:12px;font-size:13px;color:#1a6d8f}
.photo-notice i{font-size:18px;flex-shrink:0}
.photo-notice strong{color:#14536b}
.tier-section{background:white;border-radius:14px;padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,.03);border:1px solid var(--border)}
.tier-tag{font-size:10px;font-weight:700;letter-spacing:1px;padding:3px 10px;border-radius:50px;color:white;display:inline-block;margin-bottom:6px}
.tier-title{font-size:16px;font-weight:700;margin-bottom:4px}
.tier-sub{font-size:12px;color:var(--text-light);margin-bottom:14px}
.img-row{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start;margin-bottom:12px}
.img-preview{width:80px;height:80px;object-fit:cover;border-radius:10px;border:2px solid var(--border);flex-shrink:0}
.img-upload-area{flex:1;min-width:200px}
.cam-btn{background:linear-gradient(135deg,#2E86AB,#1a6d8f);color:white;border:none;padding:8px 16px;border-radius:50px;font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:5px;margin-top:6px}
.cam-preview{display:none;margin-top:8px;max-width:150px;border-radius:8px;overflow:hidden;position:relative}
.cam-preview.active{display:block}
.cam-preview img{width:100%;border-radius:8px}
.cam-remove{position:absolute;top:4px;right:4px;width:20px;height:20px;background:rgba(0,0,0,.6);color:white;border:none;border-radius:50%;cursor:pointer;font-size:10px}
.cam-info{font-size:10px;color:var(--text-light);margin-top:4px;display:flex;align-items:center;gap:4px}
.cam-info i{color:#2E86AB}
.gal-new{margin-top:8px}
.tier-divider{font-size:11px;font-weight:700;color:var(--text-light);letter-spacing:1.5px;text-transform:uppercase;margin:20px 0 12px;padding-bottom:6px;border-bottom:2px solid var(--border)}
@media(max-width:600px){.img-row{flex-direction:column}.img-preview{width:60px;height:60px}}
</style>

<div class="photo-notice">
<i class="fas fa-info-circle"></i>
<div><strong>Photo Capture Only</strong> ‚Äî This page lets you upload or capture photos for all tiers. No other content (text, descriptions, status, etc.) can be changed here.</div>
</div>

<form method="POST" enctype="multipart/form-data">
<!-- T1: Holy Dham -->
<div class="tier-section">
<span class="tier-tag" style="background:#C76B8F">T1 HOLY DHAM</span>
<div class="tier-title">{{ place.title }}</div>
<div class="tier-sub">Featured Image & Gallery</div>
<div class="img-row">
{% if place.featured_image %}<img src="/static/uploads/{{ place.featured_image }}" class="img-preview" title="Current featured image">{% endif %}
<div class="img-upload-area">
<label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Featured Image</label>
<input type="file" name="t1_featured_file" accept="image/*" class="form-control" style="font-size:12px">
<button type="button" class="cam-btn" onclick="this.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture</button>
<input type="file" name="t1_featured_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.nextElementSibling;p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.img-upload-area');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">‚úï</button></div>
<div class="cam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed on upload</div>
</div>
</div>
{% if gallery_media %}
<div style="margin-bottom:8px"><span style="font-size:12px;font-weight:600">Gallery ({{ gallery_media|length }} images)</span></div>
<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">{% for gm in gallery_media %}<img src="/static/uploads/{{ gm.filename }}" style="width:50px;height:50px;object-fit:cover;border-radius:6px;border:1px solid var(--border)">{% endfor %}</div>
{% endif %}
<div class="gal-new" id="t1_photo_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:11px" onclick="addPhotoGal('t1_photo')"><i class="fas fa-plus"></i> Add Gallery Images</button>
<button type="button" class="cam-btn" style="background:linear-gradient(135deg,#8BAB8A,#6d8d6c);margin-left:6px" onclick="addPhotoCamGal('t1_photo')"><i class="fas fa-camera"></i> Capture Gallery</button>
</div>

<!-- T2: Key Places -->
{% if kps %}
<div class="tier-divider">üìç Tier 2 ‚Äî Key Places ({{ kps|length }})</div>
{% for kp in kps %}
<div class="tier-section">
<span class="tier-tag" style="background:#2E86AB">T2</span>
<div class="tier-title">{{ kp.title }}</div>
<div class="img-row">
{% if kp.featured_image %}<img src="/static/uploads/{{ kp.featured_image }}" class="img-preview">{% endif %}
<div class="img-upload-area">
<label style="font-size:12px;font-weight:600;display:block;margin-bottom:4px">Featured Image</label>
<input type="file" name="kp_{{ kp.id }}_featured_file" accept="image/*" class="form-control" style="font-size:12px">
<button type="button" class="cam-btn" onclick="this.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture</button>
<input type="file" name="kp_{{ kp.id }}_featured_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.nextElementSibling;p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.img-upload-area');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">‚úï</button></div>
<div class="cam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed</div>
</div>
</div>
{% if kp.gallery_images %}<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">{% for gi in kp.gallery_images.split(',') %}{% if gi.strip() %}<img src="/static/uploads/{{ gi.strip() }}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;border:1px solid var(--border)">{% endif %}{% endfor %}</div>{% endif %}
<div class="gal-new" id="kp_{{ kp.id }}_photo_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:10px" onclick="addPhotoGal('kp_{{ kp.id }}_photo')"><i class="fas fa-plus"></i> Gallery</button>
<button type="button" class="cam-btn" style="font-size:10px;padding:6px 12px;background:linear-gradient(135deg,#8BAB8A,#6d8d6c);margin-left:4px" onclick="addPhotoCamGal('kp_{{ kp.id }}_photo')"><i class="fas fa-camera"></i> Capture</button>
</div>
{% endfor %}
{% endif %}

<!-- T3: Key Spots -->
{% if kss %}
<div class="tier-divider">üéØ Tier 3 ‚Äî Key Spots ({{ kss|length }})</div>
{% for ks in kss %}
<div class="tier-section">
<span class="tier-tag" style="background:#E74845">T3</span>
<div class="tier-title">{{ ks.title }}</div>
<div class="tier-sub">{{ ks.kp_title }}</div>
<div class="img-row">
{% if ks.featured_image %}<img src="/static/uploads/{{ ks.featured_image }}" class="img-preview">{% endif %}
<div class="img-upload-area">
<input type="file" name="ks_{{ ks.id }}_featured_file" accept="image/*" class="form-control" style="font-size:12px">
<button type="button" class="cam-btn" onclick="this.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture</button>
<input type="file" name="ks_{{ ks.id }}_featured_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.nextElementSibling;p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.img-upload-area');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">‚úï</button></div>
<div class="cam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed</div>
</div>
</div>
{% if ks.gallery_images %}<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:6px">{% for gi in ks.gallery_images.split(',') %}{% if gi.strip() %}<img src="/static/uploads/{{ gi.strip() }}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;border:1px solid var(--border)">{% endif %}{% endfor %}</div>{% endif %}
<div class="gal-new" id="ks_{{ ks.id }}_photo_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:10px" onclick="addPhotoGal('ks_{{ ks.id }}_photo')"><i class="fas fa-camera"></i> Gallery</button>
</div>
{% endfor %}
{% endif %}

<!-- T4: Sub Spots -->
{% if sss %}
<div class="tier-divider">‚ú¶ Tier 4 ‚Äî Key Points ({{ sss|length }})</div>
{% for ss in sss %}
<div class="tier-section">
<span class="tier-tag" style="background:#9C27B0">T4</span>
<div class="tier-title">{{ ss.title }}</div>
<div class="tier-sub">{{ ss.ks_title }} ‚Üí {{ ss.kp_title }}</div>
<div class="img-row">
{% if ss.featured_image %}<img src="/static/uploads/{{ ss.featured_image }}" class="img-preview">{% endif %}
<div class="img-upload-area">
<input type="file" name="ss_{{ ss.id }}_featured_file" accept="image/*" class="form-control" style="font-size:12px">
<button type="button" class="cam-btn" onclick="this.nextElementSibling.click()"><i class="fas fa-camera"></i> Capture</button>
<input type="file" name="ss_{{ ss.id }}_featured_cam" accept="image/*" capture="environment" style="display:none" onchange="var p=this.nextElementSibling;p.classList.add('active');var r=new FileReader();r.onload=function(e){p.querySelector('img').src=e.target.result};r.readAsDataURL(this.files[0])">
<div class="cam-preview"><img><button type="button" class="cam-remove" onclick="var w=this.closest('.img-upload-area');w.querySelector('.cam-preview').classList.remove('active');w.querySelector('input[capture]').value=''">‚úï</button></div>
<div class="cam-info"><i class="fas fa-compress-arrows-alt"></i> Auto-compressed</div>
</div>
</div>
<div class="gal-new" id="ss_{{ ss.id }}_photo_gals"></div>
<button type="button" class="btn btn-sm btn-secondary" style="font-size:10px" onclick="addPhotoGal('ss_{{ ss.id }}_photo')"><i class="fas fa-camera"></i> Gallery</button>
</div>
{% endfor %}
{% endif %}

<div style="position:sticky;bottom:0;background:var(--bg);padding:16px 0;border-top:1px solid var(--border);margin-top:20px;z-index:10">
<button type="submit" class="btn btn-primary" style="width:100%;max-width:400px"><i class="fas fa-save"></i> Save All Photos</button>
</div>
</form>

<script>
var galCounters = {};
function addPhotoGal(prefix){
    if(!galCounters[prefix]) galCounters[prefix]=0;
    var c=document.getElementById(prefix+'_gals');
    var div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:6px;margin-bottom:4px';
    div.innerHTML='<input type="file" name="'+prefix+'_gallery_'+galCounters[prefix]+'" accept="image/*" class="form-control" style="font-size:11px;flex:1"><button type="button" class="btn btn-danger btn-sm btn-icon" style="flex-shrink:0" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>';
    c.appendChild(div);
    galCounters[prefix]++;
}
function addPhotoCamGal(prefix){
    if(!galCounters[prefix]) galCounters[prefix]=0;
    var c=document.getElementById(prefix+'_gals');
    var div=document.createElement('div');
    div.style.cssText='margin-bottom:4px';
    div.innerHTML='<input type="file" name="'+prefix+'_gallery_'+galCounters[prefix]+'" accept="image/*" capture="environment" style="font-size:11px" onchange="var p=this.nextElementSibling;p.classList.add(\'active\');var r=new FileReader();r.onload=function(e){p.querySelector(\'img\').src=e.target.result};r.readAsDataURL(this.files[0])"><div class="cam-preview"><img><button type="button" class="cam-remove" onclick="this.closest(\'div\').parentElement.remove()">‚úï</button></div>';
    c.appendChild(div);
    galCounters[prefix]++;
}
</script>
{% endblock %}
