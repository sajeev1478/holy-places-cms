{% extends "frontend/base.html" %}
{% block title %}{{ kp.title }} ‚Äî {{ place.title }}{% endblock %}
{% block content %}
<!-- Hero -->
<section style="background:linear-gradient(135deg,#1a3a5c 0%,#2E86AB 60%,#3498db 100%);padding:70px 0 50px;color:white;position:relative;overflow:hidden">
<div style="position:absolute;inset:0;background:url('/static/uploads/{{ kp.featured_image or place.featured_image }}') center/cover;opacity:.1"></div>
<div class="container" style="position:relative;z-index:1">
<!-- Breadcrumb with tier badges -->
<nav style="display:flex;align-items:center;gap:8px;margin-bottom:18px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;flex-wrap:wrap">
<a href="{{ url_for('home') }}" style="color:rgba(255,255,255,.6);text-decoration:none">Home</a><span style="opacity:.4">‚Ä∫</span>
<a href="{{ url_for('place_detail', slug=place.slug) }}" style="color:rgba(255,255,255,.7);text-decoration:none;display:flex;align-items:center;gap:4px"><span style="font-size:8px;padding:1px 5px;background:rgba(199,107,143,.4);border-radius:50px;font-weight:700">T1</span>{{ place.title }}</a><span style="opacity:.4">‚Ä∫</span>
<span style="opacity:.9;display:flex;align-items:center;gap:4px"><span style="font-size:8px;padding:1px 5px;background:rgba(46,134,171,.5);border-radius:50px;font-weight:700">T2</span>{{ kp.title }}</span>
</nav>
<div style="display:inline-flex;align-items:center;gap:8px;background:rgba(255,255,255,.12);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.15);border-radius:50px;padding:6px 16px;margin-bottom:14px">
<span style="font-size:14px">üìç</span>
<span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;text-transform:uppercase;opacity:.9">Tier 2 ¬∑ Key Place</span>
</div>
<h1 style="font-family:'Josefin Sans',sans-serif;font-size:clamp(28px,4.5vw,48px);font-weight:700;margin-bottom:8px">{{ kp.title }}</h1>
{% if kp.short_description %}<p style="max-width:650px;font-size:15px;line-height:1.7;opacity:.75;font-family:'Nunito Sans',sans-serif">{{ kp.short_description }}</p>{% endif %}
{% if key_spots %}<div style="display:flex;gap:20px;margin-top:18px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px">
<div style="padding:10px 18px;background:rgba(255,255,255,.1);border-radius:10px"><strong>{{ key_spots|length }}</strong> Key Spots</div>
{% set total_subs = namespace(val=0) %}{% for ksd in key_spots %}{% set total_subs.val = total_subs.val + ksd.sub_spots|length %}{% endfor %}
{% if total_subs.val %}<div style="padding:10px 18px;background:rgba(255,255,255,.1);border-radius:10px"><strong>{{ total_subs.val }}</strong> Key Points</div>{% endif %}
</div>{% endif %}

</div>
</section>

<!-- Content -->
<section style="padding:45px 0">
<div class="container" style="display:grid;grid-template-columns:1fr 320px;gap:40px;align-items:start">
<div>
<!-- Back to Dham -->
<div style="margin-bottom:20px"><a href="{{ url_for('place_detail', slug=place.slug) }}" style="display:inline-flex;align-items:center;gap:6px;padding:8px 16px;background:var(--cream-dark);border:1px solid var(--border);border-radius:10px;color:var(--text-light);font-size:13px;font-weight:600;text-decoration:none;transition:all .2s" onmouseover="this.style.borderColor='var(--rose-deep)';this.style.color='var(--rose-deep)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-light)'"><i class="fas fa-arrow-left" style="font-size:10px"></i> Back to {{ place.title }} (T1)</a></div>

<!-- Tier 2 Definition -->
<div style="background:#2E86AB06;border:1.5px solid #2E86AB18;border-radius:14px;padding:16px 18px;margin-bottom:24px;display:flex;gap:14px;align-items:flex-start">
<span style="width:40px;height:40px;background:#2E86AB12;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0">üìç</span>
<div>
<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px"><span style="font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:2px 8px;background:#2E86AB;color:white;border-radius:50px">Tier 2</span><span style="font-size:13px;font-weight:700;color:#2E86AB">Key Place</span></div>
<p style="font-size:12px;color:var(--text-light);margin:0;line-height:1.5">A major location within <strong>{{ place.title }}</strong> where important pastimes or historical events occurred. Key Places represent clusters of leelas or thematic zones ‚Äî each with a distinct spiritual identity or mood.</p>
</div>
</div>

{% if kp.featured_image %}<div style="margin-bottom:28px;border-radius:16px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.08)"><img src="/static/uploads/{{ kp.featured_image }}" alt="{{ kp.title }}" style="width:100%;display:block" onerror="this.parentElement.style.display='none'"></div>{% endif %}

<!-- Gallery Slider -->
{% if kp_gallery %}
<div style="margin-bottom:28px">
<h3 style="font-family:'Josefin Sans',sans-serif;font-size:18px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px">üì∏ Photo Gallery <span style="font-size:12px;font-weight:500;color:var(--text-light);font-family:'Plus Jakarta Sans',sans-serif">{{ kp_gallery|length }} images</span></h3>
{% with gallery_images=kp_gallery, slider_id='kp' %}{% include 'frontend/_gallery_slider.html' %}{% endwith %}
</div>
{% endif %}

{% if kp.full_content %}<div class="rich-content" style="margin-bottom:36px;line-height:1.85;font-size:15.5px;color:var(--text-mid)">{{ kp.full_content|safe }}</div>{% endif %}

{% if kp_customs %}
<div style="margin-bottom:32px">
{% with custom_vals=kp_customs, accent='#2E86AB' %}{% include 'frontend/_custom_fields.html' %}{% endwith %}
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê TIER 3: KEY SPOTS ‚ïê‚ïê‚ïê -->
{% if key_spots %}
<div style="margin-bottom:36px">
<h2 style="font-family:'Josefin Sans',sans-serif;font-size:26px;font-weight:700;margin-bottom:20px;display:flex;align-items:center;gap:10px">üî∏ Key Spots <span style="font-size:14px;font-weight:500;color:var(--text-light);font-family:'Plus Jakarta Sans',sans-serif">(Tier 3)</span></h2>

<!-- Group by category -->
{% set seen_cats = [] %}
{% for ksd in key_spots %}
{% set ks = ksd.spot %}
{% set cat_name = ks.cat_name or 'Uncategorized' %}

{% if cat_name not in seen_cats %}
{% if seen_cats.append(cat_name) %}{% endif %}
<div style="margin-bottom:20px">
<h3 style="display:inline-flex;align-items:center;gap:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:{{ ks.cat_color or '#666' }};margin-bottom:12px;padding:6px 14px;background:{{ ks.cat_color or '#666' }}10;border-radius:8px;border:1px solid {{ ks.cat_color or '#666' }}25"><span style="font-size:16px">{{ ks.cat_icon or 'üìç' }}</span>{{ cat_name }}</h3>

<div style="display:grid;gap:14px">
{% for ksd2 in key_spots %}{% set ks2 = ksd2.spot %}{% if (ks2.cat_name or 'Uncategorized') == cat_name %}
<a href="{{ url_for('key_spot_detail', slug=place.slug, kp_slug=kp.slug, ks_slug=ks2.slug) }}" style="display:block;background:white;border-radius:16px;padding:20px;text-decoration:none;color:inherit;border:2px solid {{ ks2.cat_color or '#ddd' }}15;transition:all .25s;position:relative" onmouseover="this.style.transform='translateY(-2px)';this.style.borderColor='{{ ks2.cat_color or '#666' }}40';this.style.boxShadow='0 8px 24px {{ ks2.cat_color or '#666' }}12'" onmouseout="this.style.transform='none';this.style.borderColor='{{ ks2.cat_color or '#ddd' }}15';this.style.boxShadow='none'">
<div style="display:flex;align-items:flex-start;gap:14px">
  <span style="width:44px;height:44px;background:{{ ks2.cat_color or '#666' }}12;border:1.5px solid {{ ks2.cat_color or '#666' }}25;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">{{ ks2.cat_icon or 'üìç' }}</span>
  <div style="flex:1;min-width:0">
    <h4 style="font-family:'Josefin Sans',sans-serif;font-size:18px;font-weight:600;color:var(--text-dark);margin-bottom:4px">{{ ks2.title }}</h4>
    {% if ks2.short_description %}<p style="font-size:13px;color:var(--text-light);line-height:1.5;margin:0">{{ ks2.short_description }}</p>{% endif %}
    {% if ksd2.sub_spots %}<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">{% for ss in ksd2.sub_spots %}<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;background:{{ ss.cat_color or '#9C27B0' }}08;border:1px solid {{ ss.cat_color or '#9C27B0' }}20;border-radius:50px;font-size:11px;color:{{ ss.cat_color or '#9C27B0' }};font-family:'Plus Jakarta Sans',sans-serif"><span style="font-size:12px">{{ ss.cat_icon or 'üìç' }}</span>{{ ss.title }}</span>{% endfor %}</div>{% endif %}
  </div>
  <svg style="width:18px;height:18px;color:var(--text-light);flex-shrink:0;margin-top:4px" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z"/></svg>
</div></a>
{% endif %}{% endfor %}
</div></div>
{% endif %}{% endfor %}
</div>{% endif %}

<!-- Bottom back button -->
<div style="margin-top:24px;padding-top:20px;border-top:1px solid var(--border);display:flex;gap:10px">
<a href="{{ url_for('place_detail', slug=place.slug) }}" style="display:inline-flex;align-items:center;gap:6px;padding:10px 18px;background:var(--cream-dark);border:1px solid var(--border);border-radius:10px;color:var(--text-mid);font-size:13px;font-weight:600;text-decoration:none;transition:all .2s" onmouseover="this.style.borderColor='var(--rose-deep)'" onmouseout="this.style.borderColor='var(--border)'">‚Üê Back to {{ place.title }}</a>
</div>
</div>

<!-- Sidebar -->
<div>
{% if kp.latitude and kp.longitude %}<div style="background:white;border:2px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px"><iframe src="https://maps.google.com/maps?q={{ kp.latitude }},{{ kp.longitude }}&z=14&output=embed" style="width:100%;height:200px;border:0"></iframe></div>{% endif %}

<!-- Sibling Key Places -->
{% if siblings %}
<div style="background:white;border:2px solid var(--border);border-radius:16px;padding:22px;margin-bottom:20px">
<h3 style="font-family:'Josefin Sans',sans-serif;font-size:16px;font-weight:700;margin-bottom:14px">Other Key Places</h3>
{% for sib in siblings %}
<a href="{{ url_for('key_place_detail', slug=place.slug, kp_slug=sib.slug) }}" style="display:block;padding:10px 0;border-bottom:1px solid var(--border);text-decoration:none;color:inherit;font-size:14px;transition:color .2s" onmouseover="this.style.color='var(--rose-deep)'" onmouseout="this.style.color='inherit'"><strong>{{ sib.title }}</strong>{% if sib.short_description %}<p style="font-size:12px;color:var(--text-light);margin:3px 0 0">{{ sib.short_description[:80] }}{% if sib.short_description|length > 80 %}‚Ä¶{% endif %}</p>{% endif %}</a>
{% endfor %}
</div>{% endif %}

<!-- Back to Dham -->
<a href="{{ url_for('place_detail', slug=place.slug) }}" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:14px;background:var(--rose-deep);color:white;border-radius:12px;text-decoration:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600">‚Üê Back to {{ place.title }}</a>
</div>
</div>
</section>

<!-- Report Error Button at bottom of page -->
<section style="padding:20px 0 50px">
<div class="container" style="text-align:center">
<button class="report-btn" onclick="openReportModal(this.dataset.info)" data-info="&lt;strong&gt;üìç Page Info&lt;/strong&gt;&lt;br&gt;üèõÔ∏è &lt;b&gt;T1 Holy Dham:&lt;/b&gt; {{ place.title }}&lt;br&gt;üìç &lt;b&gt;T2 Key Place:&lt;/b&gt; {{ kp.title }}">üö© Report an Error</button>
</div>
</section>

<style>
@media(max-width:900px){section .container{grid-template-columns:1fr!important}}
.rich-content h2{font-family:'Josefin Sans',sans-serif;font-size:22px;margin:20px 0 10px;color:var(--text-dark);font-weight:700}
.rich-content h3{font-family:'Josefin Sans',sans-serif;font-size:18px;margin:16px 0 8px;font-weight:600}
.rich-content p{margin-bottom:12px}
</style>
{% endblock %}
