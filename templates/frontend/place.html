{% extends "frontend/base.html" %}
{% block title %}{{ place.title }} â€” Holy Places{% endblock %}

{% set vis = visibility or {} %}

{% block content %}
<!-- Hero -->
<section style="background:linear-gradient(135deg,#2D1F2E,#4A2D4E);padding:60px 0 50px;color:white;position:relative;overflow:hidden">
<div style="position:absolute;inset:0;background:url('/static/uploads/{{ place.featured_image }}') center/cover;opacity:.15"></div>
<div class="container" style="position:relative;z-index:1">
{% if vis.get('tags',1) and tags %}<div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">{% for tag in tags %}<span style="background:{{ tag.color }}22;border:1px solid {{ tag.color }}55;color:{{ tag.color }};padding:4px 14px;border-radius:50px;font-size:12px;font-weight:600">{{ tag.name }}</span>{% endfor %}</div>{% endif %}
<h1 style="font-family:'Playfair Display',serif;font-size:clamp(28px,5vw,52px);margin-bottom:12px">{{ place.title }}</h1>
{% if vis.get('city',1) or vis.get('state',1) %}<p style="font-size:18px;opacity:.85;display:flex;align-items:center;gap:8px"><span>ğŸ“</span>{% if vis.get('city',1) and place.city %}{{ place.city }}{% endif %}{% if vis.get('city',1) and place.city and vis.get('state',1) and place.state %}, {% endif %}{% if vis.get('state',1) and place.state %}{{ place.state }}{% endif %}{% if vis.get('country',1) and place.country %}, {{ place.country }}{% endif %}</p>{% endif %}
{% if vis.get('short_description',1) and place.short_description %}<p style="max-width:700px;font-size:16px;line-height:1.7;opacity:.8;margin-top:12px">{{ place.short_description }}</p>{% endif %}
<div style="display:flex;gap:20px;margin-top:20px;font-size:14px;opacity:.7">
<span>ğŸ‘ï¸ {{ place.view_count or 0 }} views</span>
</div>
</div>
</section>

<!-- Main Content -->
<section style="padding:50px 0">
<div class="container" style="display:grid;grid-template-columns:1fr 340px;gap:40px;align-items:start">

<!-- Left Column -->
<div>

<!-- Featured Image -->
{% if vis.get('featured_image',1) and place.featured_image %}
<div style="margin-bottom:32px;border-radius:16px;overflow:hidden;box-shadow:0 4px 24px rgba(0,0,0,.08)">
<img src="/static/uploads/{{ place.featured_image }}" alt="{{ place.title }}" style="width:100%;display:block" onerror="this.parentElement.style.display='none'">
</div>
{% endif %}

<!-- Full Content -->
{% if vis.get('full_content',1) and place.full_content %}
<div class="rich-content" style="margin-bottom:40px;line-height:1.8;font-size:16px;color:var(--text-mid)">
{{ place.full_content|safe }}
</div>
{% endif %}

<!-- Custom Fields -->
{% if custom_values %}
<div style="margin-bottom:40px">
{% for cv in custom_values %}
{% if cv.value %}
<div style="background:var(--bg);border-radius:14px;padding:20px;margin-bottom:12px">
<h4 style="font-size:14px;font-weight:700;color:var(--text-dark);margin-bottom:10px;display:flex;align-items:center;gap:8px">
{% if cv.field_type == 'audio' %}ğŸµ{% elif cv.field_type == 'video' %}ğŸ¬{% elif cv.field_type == 'image' or cv.field_type == 'images' %}ğŸ“¸{% elif cv.field_type == 'url' %}ğŸ”—{% else %}ğŸ“‹{% endif %}
{{ cv.label }}
</h4>

{% if cv.field_type == 'audio' %}
<audio controls style="width:100%;border-radius:8px"><source src="/static/uploads/{{ cv.value }}">Your browser doesn't support audio.</audio>
{% elif cv.field_type == 'video' %}
{% if 'youtube.com' in cv.value or 'youtu.be' in cv.value %}
<div style="position:relative;padding-bottom:56.25%;border-radius:10px;overflow:hidden"><iframe src="{{ cv.value.replace('watch?v=','embed/').replace('youtu.be/','youtube.com/embed/') }}" style="position:absolute;inset:0;width:100%;height:100%;border:0" allowfullscreen></iframe></div>
{% else %}
<video controls style="width:100%;border-radius:10px"><source src="/static/uploads/{{ cv.value }}">Your browser doesn't support video.</video>
{% endif %}
{% elif cv.field_type == 'image' %}
<img src="/static/uploads/{{ cv.value }}" style="width:100%;border-radius:10px" alt="{{ cv.label }}">
{% elif cv.field_type == 'images' %}
<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px">
{% for img in cv.value.split(',') %}{% if img.strip() %}<img src="/static/uploads/{{ img.strip() }}" style="width:100%;height:160px;object-fit:cover;border-radius:8px" alt="Gallery">{% endif %}{% endfor %}
</div>
{% elif cv.field_type == 'url' %}
<a href="{{ cv.value }}" target="_blank" style="color:var(--primary);text-decoration:underline">{{ cv.value }}</a>
{% elif cv.field_type == 'richtext' %}
<div style="line-height:1.7;color:var(--text-mid)">{{ cv.value|safe }}</div>
{% else %}
<p style="color:var(--text-mid);line-height:1.6">{{ cv.value }}</p>
{% endif %}
</div>
{% endif %}
{% endfor %}
</div>
{% endif %}

<!-- Key Places to Visit -->
{% if key_places_data %}
<div style="margin-bottom:40px">
<h2 style="font-family:'Playfair Display',serif;font-size:28px;margin-bottom:8px;color:var(--text-dark)">ğŸ—ºï¸ Key Places to Visit</h2>
<p style="color:var(--text-light);margin-bottom:24px">Explore the sacred spots within {{ place.title }}</p>

{% for kpd in key_places_data %}
{% set kp = kpd.place %}
{% set kp_customs = kpd.customs %}
<div style="background:white;border:2px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:20px;transition:box-shadow .3s" onmouseover="this.style.boxShadow='0 8px 30px rgba(0,0,0,.08)'" onmouseout="this.style.boxShadow='none'">

<!-- Key Place Header -->
<div style="padding:24px;{% if kp.featured_image %}display:grid;grid-template-columns:1fr 200px;gap:20px;align-items:start{% endif %}">
<div>
<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
<span style="width:32px;height:32px;background:var(--primary);color:white;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700">{{ loop.index }}</span>
<h3 style="font-family:'Playfair Display',serif;font-size:22px;color:var(--text-dark)">{{ kp.title }}</h3>
</div>
{% if kp.short_description %}<p style="color:var(--text-mid);line-height:1.6;margin-bottom:12px">{{ kp.short_description }}</p>{% endif %}
{% if kp.latitude and kp.longitude %}<span style="font-size:12px;color:var(--text-light)">ğŸ“ {{ kp.latitude }}, {{ kp.longitude }}</span>{% endif %}
</div>
{% if kp.featured_image %}
<img src="/static/uploads/{{ kp.featured_image }}" style="width:200px;height:140px;object-fit:cover;border-radius:12px" alt="{{ kp.title }}" onerror="this.style.display='none'">
{% endif %}
</div>

<!-- Key Place Content -->
{% if kp.full_content %}
<div style="padding:0 24px 20px;line-height:1.7;color:var(--text-mid);border-top:1px solid var(--border);margin-top:0;padding-top:16px">
{{ kp.full_content|safe }}
</div>
{% endif %}

<!-- Key Place Custom Fields -->
{% if kp_customs %}
<div style="padding:0 24px 24px">
{% for kcv in kp_customs %}
{% if kcv.value %}
<div style="background:var(--bg);border-radius:10px;padding:14px;margin-bottom:8px">
<h5 style="font-size:13px;font-weight:700;margin-bottom:8px;color:var(--text-dark);display:flex;align-items:center;gap:6px">
{% if kcv.field_type == 'audio' %}ğŸµ{% elif kcv.field_type == 'video' %}ğŸ¬{% elif kcv.field_type in ('image','images') %}ğŸ“¸{% elif kcv.field_type == 'url' %}ğŸ”—{% else %}ğŸ“‹{% endif %}
{{ kcv.label }}
</h5>
{% if kcv.field_type == 'audio' %}
<audio controls style="width:100%"><source src="/static/uploads/{{ kcv.value }}"></audio>
{% elif kcv.field_type == 'video' %}
{% if 'youtube' in kcv.value or 'youtu.be' in kcv.value %}
<div style="position:relative;padding-bottom:56.25%;border-radius:8px;overflow:hidden"><iframe src="{{ kcv.value.replace('watch?v=','embed/').replace('youtu.be/','youtube.com/embed/') }}" style="position:absolute;inset:0;width:100%;height:100%;border:0" allowfullscreen></iframe></div>
{% else %}
<video controls style="width:100%;border-radius:8px"><source src="/static/uploads/{{ kcv.value }}"></video>
{% endif %}
{% elif kcv.field_type == 'image' %}
<img src="/static/uploads/{{ kcv.value }}" style="width:100%;border-radius:8px" alt="{{ kcv.label }}">
{% elif kcv.field_type == 'url' %}
<a href="{{ kcv.value }}" target="_blank" style="color:var(--primary)">{{ kcv.value }}</a>
{% elif kcv.field_type == 'richtext' %}
<div style="line-height:1.6;color:var(--text-mid)">{{ kcv.value|safe }}</div>
{% else %}
<p style="color:var(--text-mid)">{{ kcv.value }}</p>
{% endif %}
</div>
{% endif %}
{% endfor %}
</div>
{% endif %}

</div>
{% endfor %}
</div>
{% endif %}

<!-- Related Module Entries -->
{% if related_entries %}
<div style="margin-bottom:40px">
<h2 style="font-family:'Playfair Display',serif;font-size:24px;margin-bottom:20px">ğŸ“– Related Content</h2>
<div style="display:grid;gap:12px">
{% for entry in related_entries %}
<a href="{{ url_for('entry_detail', mod_slug=entry.module_slug, entry_slug=entry.slug) }}" style="display:flex;align-items:center;gap:14px;padding:16px;background:var(--bg);border-radius:12px;text-decoration:none;color:inherit;transition:all .2s" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='none'">
<span style="font-size:24px">{{ entry.module_icon }}</span>
<div><strong style="color:var(--text-dark)">{{ entry.title }}</strong><br><span style="font-size:12px;color:var(--text-light)">{{ entry.module_name }}</span></div>
</a>
{% endfor %}
</div>
</div>
{% endif %}

<!-- Share -->
<div style="padding:20px 0;border-top:2px solid var(--border)">
<h4 style="font-size:14px;color:var(--text-light);margin-bottom:12px">Share this holy place</h4>
<div style="display:flex;gap:10px">
<a href="https://wa.me/?text={{ place.title }} {{ request.url }}" target="_blank" style="width:40px;height:40px;border-radius:10px;background:#25D366;display:flex;align-items:center;justify-content:center;color:white;text-decoration:none;font-size:18px">ğŸ’¬</a>
<a href="https://twitter.com/intent/tweet?text={{ place.title }}&url={{ request.url }}" target="_blank" style="width:40px;height:40px;border-radius:10px;background:#1DA1F2;display:flex;align-items:center;justify-content:center;color:white;text-decoration:none;font-size:18px">ğŸ¦</a>
<a href="https://www.facebook.com/sharer.php?u={{ request.url }}" target="_blank" style="width:40px;height:40px;border-radius:10px;background:#1877F2;display:flex;align-items:center;justify-content:center;color:white;text-decoration:none;font-size:18px">ğŸ“˜</a>
</div>
</div>
</div>

<!-- Right Sidebar -->
<div>
<!-- Quick Info Card -->
<div style="background:white;border:2px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px;position:sticky;top:90px">
<h3 style="font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px">Quick Info</h3>
<div style="display:flex;flex-direction:column;gap:12px">
{% if vis.get('city',1) and place.city %}<div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-light)">City</span><strong>{{ place.city }}</strong></div>{% endif %}
{% if vis.get('state',1) and place.state %}<div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-light)">State</span><strong>{{ place.state }}</strong></div>{% endif %}
{% if vis.get('country',1) and place.country %}<div style="display:flex;justify-content:space-between;font-size:14px"><span style="color:var(--text-light)">Country</span><strong>{{ place.country }}</strong></div>{% endif %}

<!-- Custom fields in sidebar (text/url types) -->
{% for cv in custom_values %}
{% if cv.value and cv.field_type in ('text','number','url') %}
<div style="display:flex;justify-content:space-between;font-size:14px;gap:12px">
<span style="color:var(--text-light);white-space:nowrap">{{ cv.label }}</span>
{% if cv.field_type == 'url' %}<a href="{{ cv.value }}" target="_blank" style="color:var(--primary);font-weight:600;text-align:right">Link â†—</a>
{% else %}<strong style="text-align:right">{{ cv.value }}</strong>{% endif %}
</div>
{% endif %}
{% endfor %}
</div>

{% if key_places_data %}
<div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
<h4 style="font-size:14px;margin-bottom:10px;color:var(--text-light)">Key Places ({{ key_places_data|length }})</h4>
{% for kpd in key_places_data %}
<div style="font-size:13px;padding:6px 0;display:flex;gap:8px;align-items:center">
<span style="width:20px;height:20px;background:var(--primary-light);color:var(--primary);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0">{{ loop.index }}</span>
{{ kpd.place.title }}
</div>
{% endfor %}
</div>
{% endif %}
</div>

<!-- Map -->
{% if vis.get('latitude',1) and place.latitude and place.longitude %}
<div style="background:white;border:2px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:24px">
<iframe src="https://maps.google.com/maps?q={{ place.latitude }},{{ place.longitude }}&z=14&output=embed" style="width:100%;height:220px;border:0"></iframe>
</div>
{% endif %}

<!-- Nearby Places -->
{% if nearby %}
<div style="background:white;border:2px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">
<h3 style="font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px">Nearby Places</h3>
{% for np in nearby %}
<a href="{{ url_for('place_detail', slug=np.slug) }}" style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);text-decoration:none;color:inherit">
<span style="font-weight:600;color:var(--text-dark);font-size:14px">{{ np.title }}</span>
<span style="font-size:12px;color:var(--text-light)">{{ '%.0f'|format(np.distance_km) }} km</span>
</a>
{% endfor %}
</div>
{% endif %}

<!-- Related Places -->
{% if related %}
<div style="background:white;border:2px solid var(--border);border-radius:16px;padding:24px">
<h3 style="font-family:'Playfair Display',serif;font-size:18px;margin-bottom:16px">Similar Places</h3>
{% for rp in related %}
<a href="{{ url_for('place_detail', slug=rp.slug) }}" style="display:block;padding:10px 0;border-bottom:1px solid var(--border);text-decoration:none;color:inherit">
<strong style="color:var(--text-dark);font-size:14px">{{ rp.title }}</strong>
<p style="font-size:12px;color:var(--text-light);margin:4px 0 0">{{ rp.city }}{{ ', ' + rp.state if rp.state else '' }}</p>
</a>
{% endfor %}
</div>
{% endif %}

</div>
</div>
</section>

<!-- Responsive -->
<style>
@media(max-width:900px){
.container > div:first-child{grid-column:1/-1}
section .container{grid-template-columns:1fr!important}
}
.rich-content h2{font-family:'Playfair Display',serif;font-size:24px;margin:24px 0 12px;color:var(--text-dark)}
.rich-content h3{font-family:'Playfair Display',serif;font-size:20px;margin:20px 0 10px;color:var(--text-dark)}
.rich-content p{margin-bottom:12px}
.rich-content img{max-width:100%;border-radius:10px;margin:16px 0}
</style>
{% endblock %}
